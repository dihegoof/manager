<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio da Casa</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="overlay" class="overlay"><div class="spinner"></div></div>
  <div id="toastHost" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal (info do item) -->
  <div id="modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Info</div>
        <button id="modalClose" class="small ghost" type="button">Fechar</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>

  <!-- ===== AUTH ===== -->
  <div id="authView" class="center-screen">
    <div class="card login-card">
      <h1 class="title" id="authTitle">Entrar</h1>

      <div id="loginForm">
        <div class="row">
          <input id="loginEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>
        <div class="row mt12">
          <button id="loginBtn">Logar</button>
          <button id="openRegisterBtn" class="small" type="button">Registrar</button>
        </div>
      </div>

      <div id="registerForm" class="hidden">
        <div class="row">
          <input id="regName" placeholder="Seu nome" autocomplete="name" />
        </div>
        <div class="row mt10">
          <input id="regEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="regPass" type="password" placeholder="Senha" autocomplete="new-password" />
        </div>

        <div class="row mt10" style="align-items:center;">
          <label class="checkline">
            <input id="genInv" type="checkbox" checked />
            Gerar invent√°rio
          </label>
        </div>

        <div class="row mt10">
          <input id="invCode" placeholder="C√≥digo do invent√°rio (6 letras/n√∫meros)" autocomplete="off" disabled />
        </div>

        <div class="row mt12">
          <button id="registerBtn">Criar conta</button>
          <button id="backToLoginBtn" class="small" type="button">Voltar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appView" class="wrap hidden">
    <div class="card">
      <div class="row header-row">
        <h1 class="title">Invent√°rio da Casa</h1>
        <button id="logoutBtn" class="small">Sair</button>
      </div>

      <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
        <div class="muted" style="margin-top:6px;">
          C√≥digo do invent√°rio:
          <span id="invCodeShow" class="pill copy" title="Toque para copiar"></span>
        </div>
        <div id="netBadge" class="pill net warn">sincronizando‚Ä¶</div>
      </div>

      <!-- ===== MEMBROS (visu simples) ===== -->
      <div class="divider"></div>
      <div class="members-box">
        <div class="row header-row" style="gap:8px;">
          <div class="members-title">Membros</div>
          <div class="row" style="gap:8px; justify-content:flex-end; flex:1;">
            <button id="toggleMembersBtn" class="small ghost" type="button">Mostrar</button>
            <button id="reloadMembersBtn" class="small ghost hidden" type="button">Atualizar</button>
          </div>
        </div>
        <div id="membersWrap" class="hidden">
          <div class="muted" style="margin-top:4px;">‚≠ê = dono ‚Ä¢ status = √∫ltimo acesso</div>
          <div id="membersList" class="members-list"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <input id="search" placeholder="Buscar item" />
      </div>

      <div class="divider"></div>

      <!-- ADD / EDIT -->
      <div class="row">
        <input id="name" placeholder="Novo item:" />
        <select id="unit">
          <option value="un">un</option>
          <option value="g">g</option>
          <option value="kg">kg</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
        <input id="qty" type="number" step="0.1" placeholder="Qtd" class="w120" />
        <input id="min" type="number" step="0.1" placeholder="M√≠n" class="w120" />
        <button id="add">Adicionar</button>
        <button id="cancelEdit" class="small ghost hidden" type="button">Cancelar</button>
      </div>

      <div class="row mt10" style="align-items:center;">
        <label class="checkline">
          <input id="confirmBuy" type="checkbox" />
          Registrar compra (salvar ‚Äú√∫ltima compra‚Äù)
        </label>
      </div>

      <div class="muted" id="editHint">
        Dica: marque ‚ÄúRegistrar compra‚Äù quando voc√™ realmente comprou no mercado (isso atualiza o hist√≥rico).
      </div>

      <div class="divider"></div>

      <div class="row actions">
        <button class="small" id="filterList">Filtrar lista</button>
        <button class="small" id="export">Exportar (backup)</button>
        <button class="small" id="import">Importar</button>
        <button class="small" id="clear">Zerar tudo</button>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <footer id="footer" class="footer"></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xzcgwnifypiqqushxrcs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9Nx27f1V0IgMkMw6BdTwmQ_B96lf3wq";
    const APP_URL = "https://dihegoof.github.io/manager/";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    const round = (v) => Math.round((Number(v) + Number.EPSILON) * 10) / 10;

    // Footer
    $("footer").innerHTML = `¬© ${new Date().getFullYear()}
      <a href="https://github.com/Dihegoof" target="_blank" rel="noopener">Dihego Nunes</a>
      ‚Äî Todos os direitos reservados`;

    // ===== Toast =====
    const lastToastAt = new Map();
    function normalizeToastType(type) {
      if (type === "success" || type === "error" || type === "warn") return type;
      return "warn";
    }
    function toast(message, type = "warn", key = "") {
      const t = normalizeToastType(type);
      const msg = (message || "").toString().trim();
      if (!msg) return;

      const k = key || (t + ":" + msg);
      const now = Date.now();
      const last = lastToastAt.get(k) || 0;
      if (now - last < 900) return;
      lastToastAt.set(k, now);

      const host = $("toastHost");
      const wrap = document.createElement("div");
      wrap.className = `toast ${t}`;

      const bubble = document.createElement("div");
      bubble.className = "toast-bubble";
      bubble.textContent = msg;

      wrap.appendChild(bubble);
      host.appendChild(wrap);

      requestAnimationFrame(() => wrap.classList.add("show"));
      setTimeout(() => wrap.classList.add("hide"), 3200);
      setTimeout(() => wrap.remove(), 3800);
    }

    // ===== Overlay =====
    function overlay(on) { $("overlay").classList.toggle("on", !!on); }
    let overlayTimer = null;
    function overlaySafe(on, reason = "") {
      overlay(!!on);
      clearTimeout(overlayTimer);
      if (on) {
        overlayTimer = setTimeout(() => {
          overlay(false);
          toast("Sem conex√£o no momento. Usando cache local.", "warn", "overlay-timeout");
          console.warn("Overlay timeout:", reason);
          setNet("offline");
        }, 12000);
      }
    }

    function withTimeout(promise, ms, label = "opera√ß√£o") {
      return Promise.race([
        promise,
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error(`${label}: timeout (${ms}ms)`)), ms)
        )
      ]);
    }

    function isAbortError(e) {
      const msg = (e?.message || "").toLowerCase();
      return e?.name === "AbortError" || msg.includes("signal is aborted") || msg.includes("aborted");
    }

    async function runTask(label, fn, { showOverlay = true, timeoutMs = 0 } = {}) {
      if (showOverlay) overlaySafe(true, label);
      try {
        if (!timeoutMs || timeoutMs <= 0) return await fn();
        return await withTimeout(fn(), timeoutMs, label);
      } catch (e) {
        if (isAbortError(e)) {
          console.warn(label, "AbortError (ignorado):", e?.message || e);
          return null;
        }
        console.error(label, e);
        toast(`${label}: ${e?.message || e}`, "error", "err:" + label);
        throw e;
      } finally {
        if (showOverlay) overlaySafe(false, label);
      }
    }

    window.addEventListener("unhandledrejection", (e) => {
      console.error("unhandledrejection:", e?.reason);
      overlaySafe(false, "unhandled");
      if (!isAbortError(e?.reason)) toast("Erro: " + (e?.reason?.message || e?.reason || "falha"), "error", "unhandled");
    });
    window.addEventListener("error", (e) => {
      console.error("window error:", e?.message, e);
      overlaySafe(false, "window-error");
      toast("Erro JS: " + (e?.message || "falha"), "error", "window-error");
    });

    // ===== Views =====
    function showLogin() {
      $("authTitle").textContent = "Entrar";
      $("loginForm").classList.remove("hidden");
      $("registerForm").classList.add("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
      $("authView").classList.add("fade-in");
    }
    function showRegister() {
      $("authTitle").textContent = "Registrar";
      $("loginForm").classList.add("hidden");
      $("registerForm").classList.remove("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
      syncRegisterUI();
      $("authView").classList.add("fade-in");
    }
    function showApp() {
      $("authView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      $("appView").classList.add("fade-in");
    }
    function syncRegisterUI() {
      const gen = $("genInv").checked;
      $("invCode").disabled = gen;
      if (gen) $("invCode").value = "";
    }

    // ===== Status rede =====
    function setNet(mode) {
      const el = $("netBadge");
      el.classList.remove("good","warn","bad");
      if (mode === "online") { el.textContent = "online"; el.classList.add("good"); }
      else if (mode === "offline") { el.textContent = "offline"; el.classList.add("bad"); }
      else { el.textContent = "sincronizando‚Ä¶"; el.classList.add("warn"); }
    }

    // ===== local cache =====
    const KEY_PREFIX = "home_inventory_items_";
    const loadLocal = (invId) => { try { return JSON.parse(localStorage.getItem(KEY_PREFIX + invId)) || []; } catch { return []; } };
    const saveLocal = (invId, arr) => localStorage.setItem(KEY_PREFIX + invId, JSON.stringify(arr));

    // ===== state =====
    let currentInventoryId = null;
    let inviteCode = "";
    let items = [];
    let showOnlyNeeds = false;
    let realtimeChannel = null;
    let editingId = null;
    let me = { user_id: null, display_name: "Voc√™" };
    let membersOpen = false;
    let membersRefreshTimer = null;
    let lastSeenTimer = null;

    function needsBuy(it) {
      const qty = Number(it.qty ?? 0);
      const min = Number(it.min_qty ?? 0);
      return qty <= 0 || (min > 0 && qty <= min);
    }

    // ===== Modal =====
    function openModal(title, html) {
      $("modalTitle").textContent = title || "Info";
      $("modalBody").innerHTML = html || "";
      $("modal").classList.remove("hidden");
      $("modal").setAttribute("aria-hidden", "false");
    }
    function closeModal() {
      $("modal").classList.add("hidden");
      $("modal").setAttribute("aria-hidden", "true");
      $("modalBody").innerHTML = "";
    }
    $("modalClose").onclick = closeModal;
    $("modal").addEventListener("click", (e) => { if (e.target?.id === "modal") closeModal(); });

    function fmtDate(ts) {
      if (!ts) return "‚Äî";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "‚Äî";
      return d.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
    }
    function relTime(ts) {
      if (!ts) return "nunca";
      const d = new Date(ts).getTime();
      if (!isFinite(d)) return "‚Äî";
      const diff = Date.now() - d;
      const m = Math.round(diff/60000);
      if (m < 1) return "agora";
      if (m < 60) return `h√° ${m} min`;
      const h = Math.round(m/60);
      if (h < 24) return `h√° ${h} h`;
      const dd = Math.round(h/24);
      return `h√° ${dd} d`;
    }

    // ===== render =====
    function render() {
      const q = norm($("search").value);
      const list = $("list");
      list.innerHTML = "";

      const filtered = items
        .filter(it => {
          const matchesSearch = !q || (it.name_norm || "").includes(q);
          const matchesNeeds = !showOnlyNeeds || needsBuy(it);
          return matchesSearch && matchesNeeds;
        })
        .sort((a, b) => (a.name || "").localeCompare((b.name || ""), "pt-BR"));

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = showOnlyNeeds ? "Nenhum item precisa comprar üôÇ" : "Nada por aqui üôÇ";
        list.appendChild(empty);
        return;
      }

      for (const it of filtered) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        const needs = needsBuy(it);
        left.innerHTML = `
          <div class="name">${it.name}</div>
          <div class="sub">
            ${it.qty} ${it.unit} ‚Ä¢ m√≠nimo: ${it.min_qty || 0}
            ${needs ? ' ‚Ä¢ <span class="pill danger">precisa comprar</span>' : ""}
          </div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        const minus = document.createElement("button");
        minus.textContent = "‚àí";
        minus.onclick = () => updateQty(it.id, it.unit === "un" ? -1 : -0.1);

        const gear = document.createElement("button");
        gear.textContent = "‚öôÔ∏è";
        gear.title = "Editar item";
        gear.onclick = () => startEdit(it.id);

        const info = document.createElement("button");
        info.textContent = "‚ÑπÔ∏è";
        info.title = "Info / hist√≥rico";
        info.onclick = () => showItemInfo(it);

        const qty = document.createElement("div");
        qty.className = "qty pill";
        qty.textContent = `${it.qty} ${it.unit}`;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.onclick = () => updateQty(it.id, it.unit === "un" ? +1 : +0.1);

        const del = document.createElement("button");
        del.textContent = "üóëÔ∏è";
        del.title = "Remover";
        del.onclick = () => removeItem(it.id);

        controls.append(minus, gear, info, qty, plus, del);
        row.append(left, controls);
        list.appendChild(row);
      }
    }

    function showItemInfo(it) {
      const buyAt = it.last_buy_at;
      const zeroAt = it.last_zero_at;

      let dur = "‚Äî";
      if (buyAt && zeroAt) {
        const a = new Date(buyAt).getTime();
        const b = new Date(zeroAt).getTime();
        if (isFinite(a) && isFinite(b) && b >= a) {
          const days = Math.round((b - a) / (1000*60*60*24));
          dur = `${days} dia(s)`;
        }
      }

      openModal(
        it.name,
        `
          <div class="info-grid">
            <div><b>Unidade:</b> ${it.unit}</div>
            <div><b>Qtd atual:</b> ${it.qty}</div>
            <div><b>M√≠nimo:</b> ${it.min_qty || 0}</div>
          </div>
          <div class="divider"></div>
          <div class="info-grid">
            <div><b>√öltima compra:</b> ${fmtDate(buyAt)}</div>
            <div><b>Qtd comprada:</b> ${it.last_buy_qty ?? "‚Äî"}</div>
            <div><b>√öltimo zerado:</b> ${fmtDate(zeroAt)}</div>
            <div><b>Qtd ao zerar:</b> ${it.last_zero_qty ?? "‚Äî"}</div>
            <div><b>Durou:</b> ${dur}</div>
          </div>
        `
      );
    }

    // ===== DB helpers =====
    async function loadProfile(userId) {
      const { data, error } = await supabase
        .from("profiles")
        .select("user_id, display_name, current_inventory_id, last_seen_at")
        .eq("user_id", userId)
        .maybeSingle();

      if (error) throw error;
      return data || null;
    }

    async function upsertProfileSelf(userId, displayName, currentInventoryId = null) {
      const payload = { user_id: userId };
      if (displayName) payload.display_name = displayName;
      if (currentInventoryId !== undefined) payload.current_inventory_id = currentInventoryId;
      payload.last_seen_at = new Date().toISOString();

      const { error } = await supabase
        .from("profiles")
        .upsert(payload, { onConflict: "user_id" });

      if (error) throw error;
    }

    async function touchLastSeen() {
      if (!me?.user_id) return;
      try {
        await supabase.from("profiles").update({ last_seen_at: new Date().toISOString() }).eq("user_id", me.user_id);
      } catch {}
    }

    async function loadInventoryMeta(inventoryId) {
      const { data, error } = await supabase
        .from("inventories")
        .select("id, invite_code")
        .eq("id", inventoryId)
        .single();
      if (error) throw error;
      return data;
    }

    async function fetchItems(inventoryId) {
      const { data, error } = await supabase
        .from("inventory_items")
        .select("*")
        .eq("inventory_id", inventoryId);
      if (error) throw error;
      return Array.isArray(data) ? data : [];
    }

    async function insertItem(row) {
      const { data, error } = await supabase
        .from("inventory_items")
        .insert(row)
        .select("*")
        .single();
      if (error) throw error;
      return data;
    }

    async function updateItem(id, patch) {
      const { data, error } = await supabase
        .from("inventory_items")
        .update(patch)
        .eq("id", id)
        .select("*")
        .single();
      if (error) throw error;
      return data;
    }

    async function deleteItem(id) {
      const { error } = await supabase.from("inventory_items").delete().eq("id", id);
      if (error) throw error;
    }

    // ===== realtime items =====
    async function startRealtime(inventoryId) {
      await stopRealtime();

      realtimeChannel = supabase
        .channel("inv-items-" + inventoryId)
        .on("postgres_changes", {
          event: "*",
          schema: "public",
          table: "inventory_items",
          filter: `inventory_id=eq.${inventoryId}`,
        }, (payload) => {
          const ev = payload?.eventType;
          if (ev === "INSERT" && payload.new) upsertLocalItem(payload.new);
          else if (ev === "UPDATE" && payload.new) upsertLocalItem(payload.new);
          else if (ev === "DELETE" && payload.old) {
            items = items.filter(x => x.id !== payload.old.id);
            saveLocal(inventoryId, items);
            render();
          }
        })
        .subscribe((status) => { if (status === "SUBSCRIBED") setNet("online"); });
    }

    async function stopRealtime() {
      if (realtimeChannel) await supabase.removeChannel(realtimeChannel);
      realtimeChannel = null;
    }

    function upsertLocalItem(row) {
      row.name_norm = row.name_norm || norm(row.name);
      const idx = items.findIndex(x => x.id === row.id);
      if (idx >= 0) items[idx] = row;
      else items.push(row);
      saveLocal(currentInventoryId, items);
      render();
    }

    // ===== Boot flow =====
    async function bootToInventory(inventoryId) {
      currentInventoryId = inventoryId;

      items = loadLocal(inventoryId) || [];
      showApp();
      render();
      setNet(navigator.onLine ? "sync" : "offline");

      const meta = await runTask("Sincronizar", async () => {
        const [m, cloudItems] = await Promise.all([
          loadInventoryMeta(inventoryId),
          fetchItems(inventoryId),
        ]);
        return { m, cloudItems };
      }, { showOverlay: false, timeoutMs: 25000 });

      if (meta?.m) {
        inviteCode = meta.m.invite_code || "";
        $("invCodeShow").textContent = inviteCode || "(sem c√≥digo)";
      }
      if (meta?.cloudItems) {
        items = meta.cloudItems.map(x => ({ ...x, name_norm: x.name_norm || norm(x.name) }));
        saveLocal(inventoryId, items);
        render();
        setNet("online");
      } else {
        setNet(navigator.onLine ? "sync" : "offline");
      }

      if (!document.hidden) await startRealtime(inventoryId);

      toast("Sincronizado ‚úÖ", "success", "synced");

      if (membersOpen) await refreshMembers();
      startPresenceLoop();
    }

    async function bootFromProfile(userId) {
      const prof = await runTask("Carregar perfil", async () => await loadProfile(userId), { showOverlay: true, timeoutMs: 20000 });

      if (!prof) {
        await runTask("Criar perfil", async () => await upsertProfileSelf(userId, "Usu√°rio", null), { showOverlay: true, timeoutMs: 20000 });
        showRegister();
        toast("Complete seu cadastro (nome + invent√°rio).", "warn", "need-setup");
        return;
      }

      me = { user_id: prof.user_id, display_name: prof.display_name || "Voc√™" };

      if (!prof.current_inventory_id) {
        showRegister();
        toast("Voc√™ est√° logado. Gere um invent√°rio ou informe um c√≥digo.", "warn", "need-inv");
        return;
      }

      await bootToInventory(prof.current_inventory_id);
    }

    // ===== Register setup via RPC =====
    const PENDING_KEY = "pending_inv_setup_v3";
    const setPendingSetup = (obj) => localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
    const getPendingSetup = () => { try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "null"); } catch { return null; } };
    const clearPendingSetup = () => localStorage.removeItem(PENDING_KEY);

    async function finalizePendingSetupIfNeeded(sessionUser = null) {
      const pending = getPendingSetup();
      if (!pending) return false;

      const user = sessionUser || (await supabase.auth.getUser()).data?.user;
      if (!user) return false;

      try {
        await runTask("Criar perfil", async () => await upsertProfileSelf(user.id, pending.displayName || "Usu√°rio", null), { showOverlay: true, timeoutMs: 20000 });

        let inventoryId = null;

        if (pending.mode === "create") {
          const { data, error } = await supabase.rpc("create_inventory_and_set_profile", { p_display_name: pending.displayName || "Usu√°rio" });
          if (error) throw error;
          inventoryId = data?.inventory_id || data?.[0]?.inventory_id;
        } else {
          const { data, error } = await supabase.rpc("join_inventory_by_code", { p_code: pending.code, p_display_name: pending.displayName || "Usu√°rio" });
          if (error) throw error;
          inventoryId = data?.inventory_id || data?.[0]?.inventory_id;
        }

        if (!inventoryId) throw new Error("N√£o consegui obter o invent√°rio.");

        clearPendingSetup();
        await bootToInventory(inventoryId);
        return true;
      } catch (e) {
        console.error(e);
        clearPendingSetup();
        showRegister();
        toast("Falhou ao finalizar invent√°rio: " + (e?.message || e), "warn", "finalize-fail");
        return true;
      }
    }

    // ===== Members =====
    async function refreshMembers() {
      if (!currentInventoryId) return;
      $("reloadMembersBtn").classList.remove("hidden");

      const data = await runTask("Membros", async () => {
        const { data, error } = await supabase
          .from("inventory_members_view")
          .select("user_id, role, display_name, last_seen_at")
          .eq("inventory_id", currentInventoryId);
        if (error) throw error;
        return data || [];
      }, { showOverlay: false, timeoutMs: 15000 });

      const list = $("membersList");
      list.innerHTML = "";

      if (!Array.isArray(data) || !data.length) {
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = "Sem membros.";
        list.appendChild(empty);
        return;
      }

      data.sort((a,b) => {
        if ((a.role==="owner") !== (b.role==="owner")) return a.role==="owner" ? -1 : 1;
        return (a.display_name||"").localeCompare((b.display_name||""), "pt-BR");
      });

      for (const m of data) {
        const row = document.createElement("div");
        row.className = "member-row";
        const isMe = m.user_id === me.user_id;

        const nm = document.createElement("div");
        nm.innerHTML = `<b>${m.display_name || "Usu√°rio"}</b> ${m.role==="owner" ? "‚≠ê" : ""} ${isMe ? '<span class="pill tiny">(voc√™)</span>' : ""}`;

        const st = document.createElement("div");
        st.className = "sub";
        st.textContent = "√∫ltimo acesso: " + relTime(m.last_seen_at);

        row.append(nm, st);
        list.appendChild(row);
      }
    }

    function startMembersLoop() {
      stopMembersLoop();
      membersRefreshTimer = setInterval(() => {
        if (membersOpen && document.visibilityState === "visible") refreshMembers();
      }, 60000);
    }
    function stopMembersLoop() {
      if (membersRefreshTimer) clearInterval(membersRefreshTimer);
      membersRefreshTimer = null;
    }

    function startPresenceLoop() {
      if (lastSeenTimer) clearInterval(lastSeenTimer);
      touchLastSeen();
      lastSeenTimer = setInterval(() => { if (document.visibilityState === "visible") touchLastSeen(); }, 30000);
    }

    // ===== UI events =====
    $("openRegisterBtn").onclick = () => showRegister();
    $("backToLoginBtn").onclick = () => showLogin();
    $("genInv").addEventListener("change", syncRegisterUI);

    $("loginBtn").onclick = async () => {
      const email = $("loginEmail").value.trim();
      const password = $("loginPass").value;

      try {
        await runTask("Login", async () => {
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
        }, { showOverlay: true });

        toast("Logado ‚úÖ", "success", "logged");
      } catch (e) {
        const msg = (e?.message || "").toLowerCase();
        if (msg.includes("invalid login credentials")) return toast("Email ou senha inv√°lidos.", "warn", "bad-creds");
        if (!isAbortError(e)) toast("Falha no login: " + (e?.message || e), "error", "login-fail");
      }
    };

    $("registerBtn").onclick = async () => {
      const displayName = $("regName").value.trim();
      const email = $("regEmail").value.trim();
      const password = $("regPass").value;
      const gen = $("genInv").checked;
      const code = ($("invCode").value || "").trim().toUpperCase();

      if (!displayName) return toast("Informe seu nome.", "warn", "reg-name");
      if (!email) return toast("Informe seu email.", "warn", "reg-email");
      if (!password || password.length < 6) return toast("Senha com pelo menos 6 caracteres.", "warn", "reg-pass");
      if (!gen && !code) return toast("Informe o c√≥digo do invent√°rio.", "warn", "reg-code");

      setPendingSetup({ displayName, mode: gen ? "create" : "join", code: gen ? "" : code, createdAt: Date.now() });

      try {
        await runTask("Criar conta", async () => {
          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: { emailRedirectTo: APP_URL },
          });
          if (error) throw error;

          if (!data?.session?.user) {
            clearPendingSetup();
            toast("Conta criada ‚úÖ Confirme o email e depois fa√ßa login.", "warn", "confirm-email");
            showLogin();
            $("loginEmail").value = email;
            return;
          }

          await finalizePendingSetupIfNeeded(data.session.user);
        }, { showOverlay: true });

      } catch (e) {
        const msg = (e?.message || "").toLowerCase();
        if (msg.includes("already registered") || msg.includes("user already registered")) {
          clearPendingSetup();
          toast("Esse email j√° tem conta. Faz login üòä", "warn", "already");
          showLogin();
          $("loginEmail").value = email;
          return;
        }

        clearPendingSetup();
        if (!isAbortError(e)) toast("Falha no cadastro: " + (e?.message || e), "error", "signup-fail");
      }
    };

    $("logoutBtn").onclick = async () => {
      overlaySafe(true, "logout");
      try {
        await stopRealtime();
        if (lastSeenTimer) clearInterval(lastSeenTimer);
        await supabase.auth.signOut();
        currentInventoryId = null;
        items = [];
        showLogin();
        toast("Saiu.", "warn", "logout");
      } finally {
        overlaySafe(false, "logout");
      }
    };

    $("invCodeShow").onclick = async () => {
      const t = $("invCodeShow").textContent || "";
      if (!t) return;
      try {
        await navigator.clipboard.writeText(t);
        toast("C√≥digo copiado ‚úÖ", "success", "copy-code");
      } catch {
        toast("N√£o consegui copiar.", "error", "copy-fail");
      }
    };

    $("toggleMembersBtn").onclick = async () => {
      membersOpen = !membersOpen;
      $("membersWrap").classList.toggle("hidden", !membersOpen);
      $("reloadMembersBtn").classList.toggle("hidden", !membersOpen);
      $("toggleMembersBtn").textContent = membersOpen ? "Ocultar" : "Mostrar";
      if (membersOpen) {
        await refreshMembers();
        startMembersLoop();
      } else stopMembersLoop();
    };
    $("reloadMembersBtn").onclick = async () => refreshMembers();

    $("add").onclick = () => addOrUpdateItem();
    $("cancelEdit").onclick = () => cancelEdit();
    $("search").addEventListener("input", render);
    $("name").addEventListener("keydown", (e) => { if (e.key === "Enter") addOrUpdateItem(); });

    $("filterList").onclick = () => {
      showOnlyNeeds = !showOnlyNeeds;
      $("filterList").classList.toggle("active", showOnlyNeeds);
      $("filterList").textContent = showOnlyNeeds ? "Mostrar tudo" : "Filtrar lista";
      render();
    };

    $("export").onclick = () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "inventario.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("Exportado ‚úÖ", "success", "export");
    };

    $("import").onclick = async () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = async () => {
        const file = inp.files?.[0];
        if (!file) return;
        overlaySafe(true, "import");
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) return toast("Arquivo inv√°lido.", "error", "import-invalid");
          if (!currentInventoryId) return;

          for (const it of data) {
            const name = (it?.name || "").toString().trim();
            if (!name) continue;
            const unit = (it?.unit || "un").toString();
            const qty = round(Number(it?.qty || 0));
            const min_qty = round(Number(it?.min_qty || 0));
            const n = norm(name);
            const existing = items.find(x => x.name_norm === n && x.unit === unit);

            if (existing) {
              const patched = await updateItem(existing.id, { name, name_norm: n, unit, qty, min_qty });
              upsertLocalItem(patched);
            } else {
              const inserted = await insertItem({ inventory_id: currentInventoryId, name, name_norm: n, unit, qty, min_qty });
              upsertLocalItem(inserted);
            }
          }
          toast("Importado ‚úÖ", "success", "import-ok");
        } catch (e) {
          console.error(e);
          toast("Falha ao importar: " + (e?.message || e), "error", "import-fail");
        } finally {
          overlaySafe(false, "import");
        }
      };
      inp.click();
    };

    $("clear").onclick = async () => {
      if (!confirm("Tem certeza que quer zerar tudo?")) return;
      overlaySafe(true, "clear");
      try {
        if (!currentInventoryId) return;
        for (const id of items.map(x => x.id)) await deleteItem(id);
        items = [];
        saveLocal(currentInventoryId, items);
        render();
        toast("Zerado ‚úÖ", "success", "clear-ok");
      } catch (e) {
        console.error(e);
        toast("Falha ao zerar: " + (e?.message || e), "error", "clear-fail");
      } finally {
        overlaySafe(false, "clear");
      }
    };

    // ===== Edit =====
    function startEdit(id) {
      const it = items.find(x => x.id === id);
      if (!it) return;
      editingId = id;
      $("name").value = it.name || "";
      $("unit").value = it.unit || "un";
      $("qty").value = it.qty ?? 0;
      $("min").value = it.min_qty ?? 0;
      $("add").textContent = "Salvar";
      $("cancelEdit").classList.remove("hidden");
      toast("Editando item‚Ä¶", "warn", "editing");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    function cancelEdit() {
      editingId = null;
      $("name").value = "";
      $("qty").value = "";
      $("min").value = "";
      $("confirmBuy").checked = false;
      $("add").textContent = "Adicionar";
      $("cancelEdit").classList.add("hidden");
    }

    async function addOrUpdateItem() {
      if (!currentInventoryId) return;
      const name = $("name").value.trim();
      const unit = $("unit").value;
      const qty = round(Number($("qty").value || 0));
      const minQty = round(Number($("min").value || 0));
      const confirmBuy = $("confirmBuy").checked;
      if (!name) return toast("Informe o nome do item.", "warn", "need-name");
      const n = norm(name);

      try {
        overlaySafe(true, "save-item");
        if (editingId) {
          const old = items.find(x => x.id === editingId);
          const patch = { name, name_norm: n, unit, qty, min_qty: minQty, updated_at: new Date().toISOString() };
          if (confirmBuy) {
            patch.last_buy_at = new Date().toISOString();
            const oldQty = Number(old?.qty ?? 0);
            const delta = round(qty - oldQty);
            patch.last_buy_qty = delta > 0 ? delta : qty;
          }
          const updated = await updateItem(editingId, patch);
          upsertLocalItem(updated);
          toast("Salvo ‚úÖ", "success", "saved-edit");
          cancelEdit();
          return;
        }

        const existing = items.find(x => x.name_norm === n && x.unit === unit);
        if (existing) {
          const newQty = round(Number(existing.qty || 0) + qty);
          const patch = { qty: newQty, min_qty: (minQty || minQty === 0) ? minQty : (existing.min_qty || 0), updated_at: new Date().toISOString() };
          if (confirmBuy) { patch.last_buy_at = new Date().toISOString(); patch.last_buy_qty = qty; }
          const updated = await updateItem(existing.id, patch);
          upsertLocalItem(updated);
          toast("Atualizado ‚úÖ", "success", "saved-merge");
        } else {
          const row = { inventory_id: currentInventoryId, name, name_norm: n, unit, qty, min_qty: minQty };
          if (confirmBuy) { row.last_buy_at = new Date().toISOString(); row.last_buy_qty = qty; }
          const inserted = await insertItem(row);
          upsertLocalItem(inserted);
          toast("Adicionado ‚úÖ", "success", "saved-new");
        }

        $("name").value = ""; $("qty").value = ""; $("min").value = ""; $("confirmBuy").checked = false;
        render();
      } catch (e) {
        console.error(e);
        toast("Falha ao salvar: " + (e?.message || e), "error", "save-fail");
      } finally {
        overlaySafe(false, "save-item");
      }
    }

    async function updateQty(id, delta) {
      const it = items.find(x => x.id === id);
      if (!it) return;
      const oldQty = Number(it.qty ?? 0);
      const newQty = round(Math.max(0, oldQty + Number(delta)));

      try {
        it.qty = newQty;
        saveLocal(currentInventoryId, items);
        render();

        const patch = { qty: newQty, updated_at: new Date().toISOString() };
        if (newQty === 0 && oldQty > 0) { patch.last_zero_at = new Date().toISOString(); patch.last_zero_qty = 0; }
        const updated = await runTask("Salvar", () => updateItem(id, patch), { showOverlay: false, timeoutMs: 15000 });
        if (updated) upsertLocalItem(updated);
      } catch (e) {
        console.error(e);
        toast("N√£o salvou no cloud. Tentando depois.", "warn", "save-offline");
        setNet("offline");
      }
    }

    async function removeItem(id) {
      if (!confirm("Remover item?")) return;
      try {
        overlaySafe(true, "delete");
        items = items.filter(x => x.id !== id);
        saveLocal(currentInventoryId, items);
        render();
        await deleteItem(id);
        toast("Removido ‚úÖ", "success", "deleted");
      } catch (e) {
        console.error(e);
        toast("Falha ao remover: " + (e?.message || e), "error", "del-fail");
      } finally {
        overlaySafe(false, "delete");
      }
    }

    // ===== visibility =====
    document.addEventListener("visibilitychange", async () => {
      if (!currentInventoryId) return;
      if (document.hidden) await stopRealtime();
      else {
        setNet(navigator.onLine ? "sync" : "offline");
        const cloudItems = await runTask("Sincronizar", () => fetchItems(currentInventoryId), { showOverlay: false, timeoutMs: 20000 });
        if (Array.isArray(cloudItems)) {
          items = cloudItems.map(x => ({ ...x, name_norm: x.name_norm || norm(x.name) }));
          saveLocal(currentInventoryId, items);
          render();
          setNet("online");
        }
        await startRealtime(currentInventoryId);
        touchLastSeen();
        if (membersOpen) refreshMembers();
      }
    });

    window.addEventListener("online", () => setNet("sync"));
    window.addEventListener("offline", () => setNet("offline"));

    // ===== auth =====
    let booting = false;
    supabase.auth.onAuthStateChange(async (_event, session) => {
      if (booting) return;
      if (!session?.user) {
        overlaySafe(false, "authStateChange");
        await stopRealtime();
        showLogin();
        return;
      }
      booting = true;
      try {
        const did = await finalizePendingSetupIfNeeded(session.user);
        if (!did) await bootFromProfile(session.user.id);
      } catch (e) {
        console.error(e);
        showLogin();
        if (!isAbortError(e)) toast("Falha ao iniciar: " + (e?.message || e), "error", "boot-fail");
      } finally {
        booting = false;
        overlaySafe(false, "authStateChange");
      }
    });

    // ===== first paint =====
    (async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) { showLogin(); setNet(navigator.onLine ? "sync" : "offline"); return; }
        setNet(navigator.onLine ? "sync" : "offline");
        overlaySafe(true, "first-paint");
        const did = await finalizePendingSetupIfNeeded(session.user);
        if (!did) await bootFromProfile(session.user.id);
      } catch (e) {
        console.error(e);
        showLogin();
        if (!isAbortError(e)) toast("Falha ao iniciar: " + (e?.message || e), "error", "init-fail");
      } finally {
        overlaySafe(false, "first-paint");
      }
    })();

  </script>
</body>
</html>
