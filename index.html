<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio da Casa</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <div id="toastHost" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal Info -->
  <div id="infoModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 class="title" style="margin-bottom:6px;">Info do item</h3>
      <div id="infoBody" class="sub" style="white-space:pre-wrap;"></div>
      <div class="divider"></div>
      <div class="row">
        <button id="infoClose" class="small">Fechar</button>
      </div>
    </div>
  </div>

  <!-- ===== AUTH ===== -->
  <div id="authView" class="center-screen">
    <div class="card login-card">
      <h1 class="title" id="authTitle">Entrar</h1>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="row">
          <input id="loginEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>

        <div class="row mt12">
          <button id="loginBtn">Logar</button>
          <button id="openRegisterBtn" class="small" type="button">Registrar</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" class="hidden">
        <div class="row">
          <input id="regName" placeholder="Seu nome" autocomplete="name" />
        </div>
        <div class="row mt10">
          <input id="regEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="regPass" type="password" placeholder="Senha" autocomplete="new-password" />
        </div>

        <div class="row mt10" style="align-items:center;">
          <label class="checkline">
            <input id="genInv" type="checkbox" checked />
            Gerar invent√°rio
          </label>
        </div>

        <div class="row mt10">
          <input id="invCode" placeholder="C√≥digo do invent√°rio (6 letras/n√∫meros)" autocomplete="off" disabled />
        </div>

        <div class="row mt12">
          <button id="registerBtn">Criar conta</button>
          <button id="backToLoginBtn" class="small" type="button">Voltar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appView" class="wrap hidden">
    <div class="card">
      <div class="row header-row">
        <h1 class="title">Invent√°rio da Casa</h1>
        <button id="logoutBtn" class="small">Sair</button>
      </div>

      <div class="muted" style="margin-top:6px;">
        C√≥digo do invent√°rio:
        <span id="invCodeShow" class="pill copy" title="Toque para copiar"></span>
      </div>

      <div class="divider"></div>

      <!-- MEMBROS (visualiza√ß√£o simples) -->
      <div>
        <div class="row header-row" style="margin-bottom:6px;">
          <div class="section-title">Membros</div>
          <span class="sub">Atualiza em tempo real</span>
        </div>
        <div id="membersList" class="members"></div>
      </div>

      <div class="divider"></div>

      <!-- BUSCA + FILTROS -->
      <div class="row">
        <input id="search" placeholder="Buscar item" />
        <select id="essentialFilter" class="small">
          <option value="all">Todos</option>
          <option value="essential">S√≥ essenciais</option>
          <option value="nonessential">S√≥ n√£o essenciais</option>
        </select>
      </div>

      <div class="divider"></div>

      <!-- ADD / EDIT -->
      <div class="row">
        <input id="name" placeholder="Novo item:" />
        <select id="unit">
          <option value="un">un</option>
          <option value="g">g</option>
          <option value="kg">kg</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
        <input id="qty" type="number" step="0.1" placeholder="Qtd" class="w120" />
        <input id="min" type="number" step="0.1" placeholder="M√≠n" class="w120" />
        <label class="checkline" style="display:flex;align-items:center;gap:8px;">
          <input id="essential" type="checkbox" />
          Essencial
        </label>
        <button id="add">Adicionar</button>
        <button id="cancelEdit" class="small ghost hidden" type="button">Cancelar</button>
      </div>

      <div class="muted">
        Dica: O ‚ÄúM√≠n‚Äù (m√≠nimo) emite um alerta ao chegar na quantidade definida.
      </div>

      <div class="divider"></div>

      <div class="row actions">
        <button class="small" id="filterList">Filtrar lista</button>
        <button class="small" id="export">Exportar (backup)</button>
        <button class="small" id="import">Importar</button>
        <button class="small" id="clear">Zerar tudo</button>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <footer id="footer" class="footer"></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xzcgwnifypiqqushxrcs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9Nx27f1V0IgMkMw6BdTwmQ_B96lf3wq";
    const APP_URL = "https://dihegoof.github.io/manager/";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: "manager_session_table_v1"
      }
    });

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    const round = (v) => Math.round((Number(v) + Number.EPSILON) * 10) / 10;

    // Footer
    $("footer").innerHTML = `¬© ${new Date().getFullYear()}
      <a href="https://github.com/Dihegoof" target="_blank" rel="noopener">Dihego Nunes</a>
      ‚Äî Todos os direitos reservados`;

    // ===== Toast =====
    const lastToastAt = new Map();
    function toast(message, type = "warn", key = "") {
      const msg = (message || "").toString().trim();
      if (!msg) return;

      const k = key || (type + ":" + msg);
      const now = Date.now();
      const last = lastToastAt.get(k) || 0;
      if (now - last < 900) return;
      lastToastAt.set(k, now);

      const host = $("toastHost");
      const wrap = document.createElement("div");
      wrap.className = `toast ${type}`;

      const bubble = document.createElement("div");
      bubble.className = "toast-bubble";
      bubble.textContent = msg;

      wrap.appendChild(bubble);
      host.appendChild(wrap);

      requestAnimationFrame(() => wrap.classList.add("show"));
      setTimeout(() => wrap.classList.add("hide"), 3200);
      setTimeout(() => wrap.remove(), 3800);
    }

    function overlay(on){ $("overlay").classList.toggle("on", !!on); }

    function withTimeout(promise, ms, label="opera√ß√£o"){
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error(`${label}: timeout (${ms}ms)`)), ms))
      ]);
    }

    window.addEventListener("unhandledrejection", (e) => {
      console.error("unhandledrejection:", e?.reason);
      overlay(false);
      toast("Erro: " + (e?.reason?.message || e?.reason || "falha"), "error", "unhandled");
    });
    window.addEventListener("error", (e) => {
      console.error("window error:", e?.message, e);
      overlay(false);
      toast("Erro: " + (e?.message || "falha"), "error", "window-error");
    });

    // ===== Views =====
    function showLogin(){
      $("authTitle").textContent = "Entrar";
      $("loginForm").classList.remove("hidden");
      $("registerForm").classList.add("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
      $("authView").classList.add("fade-in");
    }
    function showRegister(){
      $("authTitle").textContent = "Registrar";
      $("loginForm").classList.add("hidden");
      $("registerForm").classList.remove("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
      syncRegisterUI();
      $("authView").classList.add("fade-in");
    }
    function showApp(){
      $("authView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      $("appView").classList.add("fade-in");
    }

    function syncRegisterUI(){
      const gen = $("genInv").checked;
      $("invCode").disabled = gen;
      if (gen) $("invCode").value = "";
    }

    async function getSessionUser(){
      const { data: { session } } = await supabase.auth.getSession();
      return session?.user || null;
    }

    // ===== Modal Info =====
    function openInfo(text){
      $("infoBody").textContent = text;
      $("infoModal").classList.add("on");
    }
    function closeInfo(){
      $("infoModal").classList.remove("on");
    }
    $("infoClose").onclick = closeInfo;
    $("infoModal").addEventListener("click", (e) => {
      if (e.target === $("infoModal")) closeInfo();
    });

    // ===== State =====
    let currentInventoryId = null;
    let items = [];
    let members = [];
    let showOnlyNeeds = false;

    let editingId = null;

    let channelItems = null;
    let channelMembers = null;

    function needsBuy(it){
      const qty = Number(it.qty ?? 0);
      const min = Number(it.min_qty ?? 0);
      return qty <= 0 || (min > 0 && qty <= min);
    }

    function fmtDate(ts){
      if (!ts) return "‚Äî";
      try{
        return new Date(ts).toLocaleString("pt-BR");
      }catch{
        return String(ts);
      }
    }

    function daysBetween(a, b){
      if (!a || !b) return null;
      const da = new Date(a).getTime();
      const db = new Date(b).getTime();
      if (!isFinite(da) || !isFinite(db)) return null;
      const diff = Math.abs(db - da);
      return Math.floor(diff / (1000*60*60*24));
    }

    function renderMembers(){
      const host = $("membersList");
      host.innerHTML = "";

      if (!members.length){
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = "Sem membros (ainda).";
        host.appendChild(empty);
        return;
      }

      const sorted = [...members].sort((a,b) => {
        if (a.role !== b.role) return a.role === "owner" ? -1 : 1;
        return (a.display_name||"").localeCompare((‚Äîall||""), "pt-BR");
      });

      for (const m of sorted){
        const row = document.createElement("div");
        row.className = "member";

        const left = document.createElement("div");
        left.className = "member-left";
        const star = m.role === "owner" ? "‚≠ê" : "";
        left.innerHTML = `
          <div class="name">${m.display_name || "Usu√°rio"} <span class="star">${star}</span></div>
          <div class="sub">${m.role === "owner" ? "Dono" : "Membro"} ‚Ä¢ visto: ${fmtDate(m.last_seen_at)}</div>
        `;

        row.appendChild(left);
        host.appendChild(row);
      }
    }

    function renderItems(){
      const q = norm($("search").value);
      const essentialFilter = $("essentialFilter").value;

      const list = $("list");
      list.innerHTML = "";

      const filtered = items
        .filter(it => {
          const matchesSearch = !q || (it.name_norm || "").includes(q);
          const matchesNeeds = !showOnlyNeeds || needsBuy(it);
          const matchesEss =
            essentialFilter === "all" ? true :
            essentialFilter === "essential" ? !!it.essential :
            essentialFilter === "nonessential" ? !it.essential : true;
          return matchesSearch && matchesNeeds && matchesEss;
        })
        .sort((a,b) => (a.name||"").localeCompare((b.name||""), "pt-BR"));

      if (!filtered.length){
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = showOnlyNeeds ? "Nenhum item precisa comprar üôÇ" : "Nada por aqui üôÇ";
        list.appendChild(empty);
        return;
      }

      for (const it of filtered){
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        const needs = needsBuy(it);
        const essPill = it.essential ? ' ‚Ä¢ <span class="pill good">essencial</span>' : '';
        left.innerHTML = `
          <div class="name">${it.name}</div>
          <div class="sub">
            ${Number(it.qty)} ${it.unit} ‚Ä¢ m√≠nimo: ${Number(it.min_qty||0)}
            ${needs ? ' ‚Ä¢ <span class="pill danger">precisa comprar</span>' : ""}
            ${essPill}
          </div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        const minus = document.createElement("button");
        minus.textContent = "‚àí";
        minus.onclick = () => updateQty(it.id, it.unit === "un" ? -1 : -0.1);

        const qty = document.createElement("div");
        qty.className = "qty pill";
        qty.textContent = `${Number(it.qty)} ${it.unit}`;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.onclick = () => updateQty(it.id, it.unit === "un" ? +1 : +0.1);

        const edit = document.createElement("button");
        edit.textContent = "‚öôÔ∏è";
        edit.title = "Editar";
        edit.onclick = () => startEdit(it);

        const info = document.createElement("button");
        info.textContent = "‚ÑπÔ∏è";
        info.title = "Info / hist√≥rico";
        info.onclick = () => showInfo(it);

        const del = document.createElement("button");
        del.textContent = "üóëÔ∏è";
        del.title = "Remover";
        del.onclick = () => removeItem(it.id);

        controls.append(minus, qty, plus, edit, info, del);
        row.append(left, controls);
        list.appendChild(row);
      }
    }

    function startEdit(it){
      editingId = it.id;
      $("name").value = it.name || "";
      $("unit").value = it.unit || "un";
      $("qty").value = String(Number(it.qty ?? 0));
      $("min").value = String(Number(it.min_qty ?? 0));
      $("essential").checked = !!it.essential;

      $("add").textContent = "Salvar";
      $("cancelEdit").classList.remove("hidden");
      toast("Editando: " + (it.name || ""), "info", "edit-start");
    }

    function cancelEdit(){
      editingId = null;
      $("name").value = "";
      $("qty").value = "";
      $("min").value = "";
      $("essential").checked = false;
      $("add").textContent = "Adicionar";
      $("cancelEdit").classList.add("hidden");
    }

    function showInfo(it){
      const lastBuy = it.last_buy_at ? `${fmtDate(it.last_buy_at)} (qtd: ${Number(it.last_buy_qty ?? 0)})` : "‚Äî";
      const prevBuy = it.prev_buy_at ? `${fmtDate(it.prev_buy_at)} (qtd: ${Number(it.prev_buy_qty ?? 0)})` : "‚Äî";
      const lastZero = it.last_zero_at ? fmtDate(it.last_zero_at) : "‚Äî";

      let durou = "‚Äî";
      // ‚Äúdurou‚Äù quando tem last_buy e last_zero, e last_zero > last_buy
      if (it.last_buy_at && it.last_zero_at){
        const d = daysBetween(it.last_buy_at, it.last_zero_at);
        if (d !== null) durou = `${d} dia(s)`;
      }

      const text =
`Item: ${it.name}
Unidade: ${it.unit}
Qtd atual: ${Number(it.qty)} (m√≠n: ${Number(it.min_qty||0)})

√öltima compra: ${lastBuy}
Compra anterior: ${prevBuy}
√öltima vez zerado: ${lastZero}

Tempo que durou (compra ‚Üí zerou): ${durou}`;

      openInfo(text);
    }

    // ===== DB helpers =====
    async function loadProfileInventory(userId){
      const { data, error } = await withTimeout(
        supabase.from("profiles").select("current_inventory_id").eq("user_id", userId).maybeSingle(),
        9000,
        "load profile"
      );
      if (error) throw error;
      return data?.current_inventory_id || null;
    }

    async function loadInventoryCode(invId){
      const { data, error } = await withTimeout(
        supabase.from("inventories").select("invite_code").eq("id", invId).single(),
        9000,
        "load invite_code"
      );
      if (error) throw error;
      return data?.invite_code || "";
    }

    async function loadItems(invId){
      const { data, error } = await withTimeout(
        supabase.from("inventory_items")
          .select("*")
          .eq("inventory_id", invId)
          .order("name", { ascending: true }),
        9000,
        "load items"
      );
      if (error) throw error;
      return data || [];
    }

    async function loadMembers(invId){
      const { data, error } = await withTimeout(
        supabase.from("inventory_members")
          .select("inventory_id,user_id,role,display_name,last_seen_at,created_at")
          .eq("inventory_id", invId)
          .order("created_at", { ascending: true }),
        9000,
        "load members"
      );
      if (error) throw error;
      return data || [];
    }

    async function upsertSeen(invId, userId){
      // atualiza last_seen_at do membro (n√£o trava se falhar)
      try{
        await supabase.from("inventory_members")
          .update({ last_seen_at: new Date().toISOString() })
          .eq("inventory_id", invId)
          .eq("user_id", userId);
      }catch(e){}
    }

    // ===== realtime =====
    async function startRealtime(invId){
      await stopRealtime();

      channelItems = supabase
        .channel("rt-items-" + invId)
        .on("postgres_changes", { event:"*", schema:"public", table:"inventory_items", filter:`inventory_id=eq.${invId}` },
          (payload) => {
            const ev = payload.eventType;
            if (ev === "INSERT"){
              items = [...items, payload.new];
            } else if (ev === "UPDATE"){
              items = items.map(x => x.id === payload.new.id ? payload.new : x);
            } else if (ev === "DELETE"){
              items = items.filter(x => x.id !== payload.old.id);
            }
            renderItems();
          }
        )
        .subscribe();

      channelMembers = supabase
        .channel("rt-members-" + invId)
        .on("postgres_changes", { event:"*", schema:"public", table:"inventory_members", filter:`inventory_id=eq.${invId}` },
          (payload) => {
            const ev = payload.eventType;
            if (ev === "INSERT"){
              members = [...members, payload.new];
            } else if (ev === "UPDATE"){
              members = members.map(x => (x.user_id === payload.new.user_id && x.inventory_id === payload.new.inventory_id) ? payload.new : x);
            } else if (ev === "DELETE"){
              members = members.filter(x => !(x.user_id === payload.old.user_id && x.inventory_id === payload.old.inventory_id));
            }
            renderMembers();
          }
        )
        .subscribe();
    }

    async function stopRealtime(){
      try{ if (channelItems) await supabase.removeChannel(channelItems); }catch(e){}
      try{ if (channelMembers) await supabase.removeChannel(channelMembers); }catch(e){}
      channelItems = null;
      channelMembers = null;
    }

    // ===== Boot =====
    async function bootApp(user){
      const invId = await loadProfileInventory(user.id);
      if (!invId){
        showRegister();
        toast("Voc√™ est√° logado. Gere um invent√°rio ou informe um c√≥digo.", "warn", "need-inv");
        return;
      }

      currentInventoryId = invId;
      showApp();

      // sem overlay no boot (pra n√£o travar trocando aba)
      try{
        const [code, its, mems] = await Promise.all([
          loadInventoryCode(invId),
          loadItems(invId),
          loadMembers(invId),
        ]);
        $("invCodeShow").textContent = code || "(sem c√≥digo)";
        items = its || [];
        members = mems || [];
        renderMembers();
        renderItems();
        await startRealtime(invId);
        toast("Sincronizado ‚úÖ", "success", "synced");
      }catch(e){
        console.error(e);
        toast("Falhou ao carregar (policy/rede). Veja SQL/policies.", "error", "boot-fail");
      }

      // marca visto + heartbeat
      upsertSeen(invId, user.id);
      setInterval(() => upsertSeen(invId, user.id), 30000);
    }

    // ===== A√ß√µes itens (INSERT/UPDATE/DELETE) =====
    async function addOrEditItem(){
      if (!currentInventoryId) return;

      const name = $("name").value.trim();
      const unit = $("unit").value;
      const qty = round(Number($("qty").value || 0));
      const minQty = round(Number($("min").value || 0));
      const essential = !!$("essential").checked;

      if (!name) return toast("Informe o nome do item.", "warn", "need-name");

      overlay(true);
      try{
        if (editingId){
          // UPDATE
          const name_norm = norm(name);
          const { data, error } = await withTimeout(
            supabase.from("inventory_items")
              .update({
                name,
                name_norm,
                unit,
                qty,
                min_qty: minQty,
                essential
              })
              .eq("id", editingId)
              .select("*")
              .single(),
            9000,
            "update item"
          );
          if (error) throw error;

          // realtime vai atualizar todo mundo
          cancelEdit();
          toast("Atualizado ‚úÖ", "success", "updated");
        } else {
          // INSERT
          const name_norm = norm(name);
          const { data, error } = await withTimeout(
            supabase.from("inventory_items")
              .insert({
                inventory_id: currentInventoryId,
                name,
                name_norm,
                unit,
                qty,
                min_qty: minQty,
                essential
              })
              .select("*")
              .single(),
            9000,
            "insert item"
          );
          if (error) throw error;

          $("name").value = "";
          $("qty").value = "";
          $("min").value = "";
          $("essential").checked = false;

          toast("Adicionado ‚úÖ", "success", "added");
        }
      }catch(e){
        console.error(e);
        toast("Erro ao salvar: " + (e?.message || e), "error", "save-item");
      }finally{
        overlay(false);
      }
    }

    async function updateQty(id, delta){
      const it = items.find(x => x.id === id);
      if (!it) return;

      const newQty = round(Math.max(0, Number(it.qty) + Number(delta)));
      overlay(true);
      try{
        const { error } = await withTimeout(
          supabase.from("inventory_items")
            .update({ qty: newQty })
            .eq("id", id),
          9000,
          "update qty"
        );
        if (error) throw error;
        // realtime atualiza geral
      }catch(e){
        console.error(e);
        toast("Erro ao atualizar qtd: " + (e?.message || e), "error", "qty-fail");
      }finally{
        overlay(false);
      }
    }

    async function removeItem(id){
      overlay(true);
      try{
        const { error } = await withTimeout(
          supabase.from("inventory_items").delete().eq("id", id),
          9000,
          "delete item"
        );
        if (error) throw error;
        toast("Removido ‚úÖ", "success", "deleted");
      }catch(e){
        console.error(e);
        toast("Erro ao remover: " + (e?.message || e), "error", "del-fail");
      }finally{
        overlay(false);
      }
    }

    // Export / Import no modelo tabela
    $("export").onclick = () => {
      const mapped = items.map(it => ({
        name: it.name,
        unit: it.unit,
        qty: Number(it.qty),
        min_qty: Number(it.min_qty || 0),
        essential: !!it.essential
      }));
      const blob = new Blob([JSON.stringify(mapped, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "inventario.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("Exportado ‚úÖ", "success", "export");
    };

    $("import").onclick = async () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";

      inp.onchange = async () => {
        const file = inp.files?.[0];
        if (!file) return;

        overlay(true);
        try{
          const text = await file.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) return toast("Arquivo inv√°lido.", "error", "import-invalid");
          if (!currentInventoryId) return;

          // insere um por um (simples e confi√°vel)
          for (const r of data){
            const name = (r.name || "").toString().trim();
            if (!name) continue;
            const unit = (r.unit || "un").toString();
            const qty = round(Number(r.qty || 0));
            const min_qty = round(Number(r.min_qty || 0));
            const essential = !!r.essential;

            await supabase.from("inventory_items").insert({
              inventory_id: currentInventoryId,
              name,
              name_norm: norm(name),
              unit,
              qty,
              min_qty,
              essential
            });
          }

          toast("Importado ‚úÖ", "success", "import-ok");
        }catch(e){
          console.error(e);
          toast("Falha ao importar: " + (e?.message || e), "error", "import-fail");
        }finally{
          overlay(false);
        }
      };

      inp.click();
    };

    $("clear").onclick = async () => {
      if (!confirm("Tem certeza que quer zerar tudo?")) return;
      if (!currentInventoryId) return;

      overlay(true);
      try{
        const { error } = await withTimeout(
          supabase.from("inventory_items").delete().eq("inventory_id", currentInventoryId),
          9000,
          "clear items"
        );
        if (error) throw error;
        toast("Zerado ‚úÖ", "success", "clear-ok");
      }catch(e){
        console.error(e);
        toast("Falha ao zerar: " + (e?.message || e), "error", "clear-fail");
      }finally{
        overlay(false);
      }
    };

    // ===== Register/Login flows (RPC) =====
    const PENDING_KEY = "pending_inv_setup_table_v1";
    const setPendingSetup = (obj) => localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
    const getPendingSetup = () => { try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "null"); } catch { return null; } };
    const clearPendingSetup = () => localStorage.removeItem(PENDING_KEY);

    async function finalizePendingSetupIfNeeded(user){
      const pending = getPendingSetup();
      if (!pending) return false;

      try{
        // cria/atualiza profile
        const { error: pErr } = await withTimeout(
          supabase.from("profiles").upsert({ user_id: user.id, display_name: pending.displayName || "Usu√°rio" }),
          9000,
          "profile upsert"
        );
        if (pErr) throw pErr;

        if (pending.mode === "create"){
          const { data, error } = await withTimeout(
            supabase.rpc("create_inventory_and_set_profile", {
              p_name: "Invent√°rio",
              p_display_name: pending.displayName || "Usu√°rio",
            }),
            9000,
            "rpc create"
          );
          if (error) throw error;
        } else {
          const { data, error } = await withTimeout(
            supabase.rpc("join_inventory_by_code", {
              p_code: pending.code,
              p_display_name: pending.displayName || "Usu√°rio",
            }),
            9000,
            "rpc join"
          );
          if (error) throw error;
        }

        clearPendingSetup();
        return true;
      }catch(e){
        console.error(e);
        clearPendingSetup();
        toast("Falhou ao vincular invent√°rio: " + (e?.message || e), "error", "finalize-fail");
        return true;
      }
    }

    // ===== UI events =====
    $("openRegisterBtn").onclick = () => showRegister();
    $("backToLoginBtn").onclick = () => showLogin();
    $("genInv").addEventListener("change", syncRegisterUI);

    $("loginBtn").onclick = async () => {
      const email = $("loginEmail").value.trim();
      const password = $("loginPass").value;

      overlay(true);
      try{
        const { error } = await withTimeout(
          supabase.auth.signInWithPassword({ email, password }),
          9000,
          "login"
        );
        if (error) return toast(error.message, "error", "login-error");
        toast("Logado ‚úÖ", "success", "logged");
      }catch(e){
        console.error(e);
        toast("Falha no login: " + (e?.message || e), "error", "login-fail");
      }finally{
        overlay(false);
      }
    };

    $("registerBtn").onclick = async () => {
      const displayName = $("regName").value.trim();
      const email = $("regEmail").value.trim();
      const password = $("regPass").value;
      const gen = $("genInv").checked;
      const code = ($("invCode").value || "").trim().toUpperCase();

      if (!displayName) return toast("Informe seu nome.", "warn", "reg-name");
      if (!email) return toast("Informe seu email.", "warn", "reg-email");
      if (!password || password.length < 6) return toast("Senha com pelo menos 6 caracteres.", "warn", "reg-pass");
      if (!gen && !code) return toast("Informe o c√≥digo do invent√°rio.", "warn", "reg-code");

      setPendingSetup({
        displayName,
        mode: gen ? "create" : "join",
        code: gen ? "" : code
      });

      overlay(true);
      try{
        const { data, error } = await withTimeout(
          supabase.auth.signUp({
            email,
            password,
            options: { emailRedirectTo: APP_URL }
          }),
          9000,
          "signUp"
        );

        if (error){
          clearPendingSetup();
          return toast(error.message, "error", "signup-error");
        }

        if (!data?.session?.user){
          toast("Conta criada ‚úÖ Confirme o email e depois fa√ßa login.", "warn", "confirm-email");
          showLogin();
          return;
        }

        toast("Conta criada ‚úÖ", "success", "signup-ok");
        // finalize vai rodar no onAuthStateChange
      }catch(e){
        console.error(e);
        clearPendingSetup();
        toast("Falha no cadastro: " + (e?.message || e), "error", "signup-fail");
      }finally{
        overlay(false);
      }
    };

    $("logoutBtn").onclick = async () => {
      overlay(true);
      try{
        await stopRealtime();
        await supabase.auth.signOut();
        currentInventoryId = null;
        items = [];
        members = [];
        showLogin();
        toast("Saiu.", "warn", "logout");
      }finally{
        overlay(false);
      }
    };

    $("invCodeShow").onclick = async () => {
      const t = $("invCodeShow").textContent || "";
      if (!t || t === "(sem c√≥digo)") return;
      try{
        await navigator.clipboard.writeText(t);
        toast("C√≥digo copiado ‚úÖ", "success", "copy-code");
      }catch{
        toast("N√£o consegui copiar.", "error", "copy-fail");
      }
    };

    $("add").onclick = addOrEditItem;
    $("cancelEdit").onclick = cancelEdit;

    $("search").addEventListener("input", renderItems);
    $("essentialFilter").addEventListener("change", renderItems);

    $("filterList").onclick = () => {
      showOnlyNeeds = !showOnlyNeeds;
      $("filterList").classList.toggle("active", showOnlyNeeds);
      $("filterList").textContent = showOnlyNeeds ? "Mostrar tudo" : "Filtrar lista";
      renderItems();
    };

    // ===== SESS√ÉO SIMPLES (sem loading infinito ao trocar aba) =====
    let booting = false;

    supabase.auth.onAuthStateChange(async (_event, session) => {
      if (booting) return;

      if (!session?.user){
        await stopRealtime();
        showLogin();
        return;
      }

      booting = true;
      try{
        await finalizePendingSetupIfNeeded(session.user);
        await bootApp(session.user);
      }catch(e){
        console.error(e);
        toast("Falha ao iniciar: " + (e?.message || e), "error", "boot-error");
      }finally{
        booting = false;
      }
    });

    // ao voltar pra aba, s√≥ revalida e re-liga realtime
    document.addEventListener("visibilitychange", async () => {
      if (document.visibilityState !== "visible") return;

      try{ await supabase.auth.refreshSession(); }catch(e){}
      const user = await getSessionUser();
      if (!user) return;

      // se j√° tem inv, tenta religar realtime (n√£o trava)
      if (currentInventoryId){
        try{ await startRealtime(currentInventoryId); }catch(e){}
        upsertSeen(currentInventoryId, user.id);
      }
    });

    // first paint
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) showLogin();
      else {
        try{
          await finalizePendingSetupIfNeeded(session.user);
          await bootApp(session.user);
        }catch{
          showLogin();
        }
      }
    })();
  </script>
</body>
</html>