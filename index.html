<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio da Casa</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <div id="overlay" class="overlay">
    <div class="spinner"></div>
  </div>

  <!-- ===== AUTH (LOGIN / REGISTER / JOIN) ===== -->
  <div id="authView" class="center-screen">
    <div class="card login-card">
      <h1 class="title" id="authTitle">Entrar</h1>

      <!-- LOGIN FORM -->
      <div id="loginForm">
        <div class="row">
          <input id="loginEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>
        <div class="row mt12">
          <button id="loginBtn">Logar</button>
        </div>

        <div class="row mt10">
          <button id="goRegister" class="small" type="button">Criar conta</button>
          <button id="goJoin" class="small" type="button">Vincular pelo uuidInv</button>
        </div>

        <div id="authMsg" class="msg"></div>
      </div>

      <!-- REGISTER FORM -->
      <div id="registerForm" class="hidden">
        <div class="row">
          <input id="regName" placeholder="Seu nome" autocomplete="name" />
        </div>
        <div class="row mt10">
          <input id="regEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="regPass" type="password" placeholder="Senha" autocomplete="new-password" />
        </div>
        <div class="row mt10">
          <input id="regInvName" placeholder="Nome do invent√°rio (ex: Casa do Di)" />
        </div>

        <div class="row mt12">
          <button id="registerBtn">Criar conta e invent√°rio</button>
        </div>

        <div class="row mt10">
          <button id="backToLogin1" class="small" type="button">Voltar</button>
        </div>

        <div id="regMsg" class="msg"></div>
      </div>

      <!-- JOIN FORM -->
      <div id="joinForm" class="hidden">
        <div class="row">
          <input id="joinEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="joinPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>
        <div class="row mt10">
          <input id="joinUuid" placeholder="uuidInv (c√≥digo da casa)" autocomplete="off" />
        </div>

        <div class="row mt12">
          <button id="joinBtn">Entrar e vincular</button>
        </div>

        <div class="row mt10">
          <button id="backToLogin2" class="small" type="button">Voltar</button>
        </div>

        <div id="joinMsg" class="msg"></div>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appView" class="wrap hidden">
    <div class="card">
      <div class="row header-row">
        <h1 class="title">Invent√°rio da Casa</h1>
        <button id="logoutBtn" class="small">Sair</button>
      </div>

      <div id="appMsg" class="msg"></div>

      <!-- mostra o uuidInv do invent√°rio atual -->
      <div class="muted" style="margin-top:6px;">
        uuidInv desta casa: <span id="invUuid" class="pill" style="cursor:pointer;" title="Toque para copiar"></span>
      </div>

      <div class="divider"></div>

      <div class="row">
        <input id="search" placeholder="Buscar item" />
      </div>

      <div class="divider"></div>

      <div class="row">
        <input id="name" placeholder="Novo item:" />
        <select id="unit">
          <option value="un">un</option>
          <option value="g">g</option>
          <option value="kg">kg</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
        <input id="qty" type="number" step="0.1" placeholder="Qtd" class="w120" />
        <input id="min" type="number" step="0.1" placeholder="M√≠n" class="w120" />
        <button id="add">Adicionar</button>
      </div>

      <div class="muted">
        Dica: O ‚ÄúM√≠n‚Äù (m√≠nimo) emite um alerta ao chegar na quantidade definida.
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="small" id="filterList">Filtrar lista</button>
        <button class="small" id="export">Exportar (backup)</button>
        <button class="small" id="import">Importar</button>
        <button class="small" id="clear">Zerar tudo</button>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xzcgwnifypiqqushxrcs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9Nx27f1V0IgMkMw6BdTwmQ_B96lf3wq";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    const norm = (s) =>
      (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

    const round = (v) => Math.round((Number(v) + Number.EPSILON) * 10) / 10;

    function setMsg(el, text, isError = false) {
      el.textContent = text || "";
      el.classList.toggle("error", !!isError);
    }

    function overlay(on) { $("overlay").classList.toggle("on", !!on); }

    function showAuth(mode = "login") {
      $("appView").classList.add("hidden");
      $("authView").classList.remove("hidden");
      $("authView").classList.add("fade-in");

      $("loginForm").classList.toggle("hidden", mode !== "login");
      $("registerForm").classList.toggle("hidden", mode !== "register");
      $("joinForm").classList.toggle("hidden", mode !== "join");

      $("authTitle").textContent =
        mode === "login" ? "Entrar" :
        mode === "register" ? "Criar conta" :
        "Vincular pelo uuidInv";
    }

    function showApp() {
      $("authView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      $("appView").classList.add("fade-in");
    }

    // Regra robusta "precisa comprar": qty 0 OU qty <= min (se min > 0)
    function needsBuy(it) {
      const qty = Number(it.qty ?? 0);
      const min = Number(it.min_qty ?? 0);
      return qty <= 0 || (min > 0 && qty <= min);
    }

    // Toggle do filtro
    let showOnlyNeeds = false;

    // Local cache (por invent√°rio)
    const KEY_PREFIX = "home_inventory_inv_";
    const loadLocal = (invId) => {
      try { return JSON.parse(localStorage.getItem(KEY_PREFIX + invId)) || []; }
      catch { return []; }
    };
    const saveLocal = (invId, arr) => localStorage.setItem(KEY_PREFIX + invId, JSON.stringify(arr));

    let items = [];
    let saveTimer = null;

    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser();
      return user;
    }

    async function getUserId() {
      const u = await getUser();
      return u?.id || null;
    }

    async function ensureProfile(displayNameIfMissing = "Usu√°rio") {
      const uid = await getUserId();
      if (!uid) return null;

      const { data, error } = await supabase
        .from("profiles")
        .select("user_id, display_name, current_inventory_id")
        .eq("user_id", uid)
        .maybeSingle();

      if (error) throw error;
      if (data) return data;

      const profile = {
        user_id: uid,
        display_name: displayNameIfMissing,
        current_inventory_id: null
      };

      const { error: insErr } = await supabase.from("profiles").insert(profile);
      if (insErr) throw insErr;

      return profile;
    }

    async function setCurrentInventory(inventoryId) {
      const uid = await getUserId();
      if (!uid) return;

      const { error } = await supabase
        .from("profiles")
        .update({ current_inventory_id: inventoryId })
        .eq("user_id", uid);

      if (error) throw error;
    }

    async function loadItemsFromInventory(inventoryId) {
      const { data, error } = await supabase
        .from("inventories")
        .select("items")
        .eq("id", inventoryId)
        .single();

      if (error) throw error;
      return data?.items ?? [];
    }

    async function saveItemsToInventory(inventoryId, arr) {
      const { error } = await supabase
        .from("inventories")
        .update({ items: arr, updated_at: new Date().toISOString() })
        .eq("id", inventoryId);

      if (error) throw error;
    }

    async function createInventoryAndJoin(invName) {
      const uid = await getUserId();
      if (!uid) throw new Error("Sem usu√°rio.");

      const { data: inv, error: invErr } = await supabase
        .from("inventories")
        .insert({ name: invName || "Invent√°rio", created_by: uid })
        .select("id")
        .single();

      if (invErr) throw invErr;

      const { error: memErr } = await supabase
        .from("inventory_members")
        .insert({ inventory_id: inv.id, user_id: uid, role: "owner" });

      if (memErr) throw memErr;

      await setCurrentInventory(inv.id);
      return inv.id; // uuidInv
    }

    async function joinInventoryByUuid(uuidInv) {
      const uid = await getUserId();
      if (!uid) throw new Error("Sem usu√°rio.");

      const { error: memErr } = await supabase
        .from("inventory_members")
        .insert({ inventory_id: uuidInv, user_id: uid, role: "member" });

      if (memErr) throw memErr;

      await setCurrentInventory(uuidInv);
      return uuidInv;
    }

    // ========= REALTIME (por invent√°rio) =========
    let realtimeChannel = null;
    let currentInventoryId = null;

    async function startRealtime(inventoryId) {
      if (!inventoryId) return;

      if (realtimeChannel) {
        await supabase.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }

      realtimeChannel = supabase
        .channel("inv-" + inventoryId)
        .on(
          "postgres_changes",
          {
            event: "*",
            schema: "public",
            table: "inventories",
            filter: `id=eq.${inventoryId}`,
          },
          async (payload) => {
            try {
              const newItems = payload?.new?.items;
              if (Array.isArray(newItems)) {
                items = newItems;
                saveLocal(inventoryId, items);
                render();
                setMsg($("appMsg"), "Atualizado em tempo real ‚ö°");
              } else {
                const cloud = await loadItemsFromInventory(inventoryId);
                if (cloud && Array.isArray(cloud)) {
                  items = cloud;
                  saveLocal(inventoryId, items);
                  render();
                }
              }
            } catch (e) {
              console.error("Realtime handler error:", e);
            }
          }
        )
        .subscribe((status) => {
          if (status === "SUBSCRIBED") setMsg($("appMsg"), "Tempo real ativo ‚ö°");
        });
    }

    async function stopRealtime() {
      if (realtimeChannel) {
        await supabase.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
    }

    // Salva agora
    async function saveNow(arr) {
      if (!currentInventoryId) return;
      saveLocal(currentInventoryId, arr);
      try {
        await saveItemsToInventory(currentInventoryId, arr);
        setMsg($("appMsg"), "Salvo ‚úÖ");
      } catch (e) {
        console.error("Erro ao salvar no cloud:", e);
        setMsg($("appMsg"), "N√£o salvou no cloud. Veja Console (F12).", true);
      }
    }

    // Debounce para +/‚àí
    function saveDebounced(arr) {
      if (!currentInventoryId) return;
      saveLocal(currentInventoryId, arr);
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveNow(arr), 250);
    }

    function stepFor(unit) { return unit === "un" ? 1 : 0.1; }

    function render() {
      const q = norm($("search").value);
      const list = $("list");
      list.innerHTML = "";

      const filtered = items
        .filter(it => {
          const matchesSearch = !q || (it.name_norm || "").includes(q);
          const matchesNeeds = !showOnlyNeeds || needsBuy(it);
          return matchesSearch && matchesNeeds;
        })
        .sort((a, b) => (a.name || "").localeCompare((b.name || ""), "pt-BR"));

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = showOnlyNeeds
          ? "Nenhum item est√° marcado como ‚Äúprecisa comprar‚Äù üôÇ"
          : "Nada por aqui. Adicione itens acima üôÇ";
        list.appendChild(empty);
        return;
      }

      for (const it of filtered) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        const needs = needsBuy(it);

        left.innerHTML = `
          <div class="name">${it.name}</div>
          <div class="sub">
            ${it.qty} ${it.unit} ‚Ä¢ m√≠nimo: ${it.min_qty || 0}
            ${needs ? ' ‚Ä¢ <span class="pill danger">precisa comprar</span>' : ""}
          </div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        const minus = document.createElement("button");
        minus.textContent = "‚àí";
        minus.onclick = () => updateQty(it.id, -stepFor(it.unit));

        const qty = document.createElement("div");
        qty.className = "qty pill";
        qty.textContent = `${it.qty} ${it.unit}`;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.onclick = () => updateQty(it.id, +stepFor(it.unit));

        const del = document.createElement("button");
        del.textContent = "üóëÔ∏è";
        del.title = "Remover";
        del.onclick = () => removeItem(it.id);

        controls.append(minus, qty, plus, del);
        row.append(left, controls);
        list.appendChild(row);
      }
    }

    async function addItem() {
      const name = $("name").value.trim();
      const unit = $("unit").value;
      const qty = Number($("qty").value || 0);
      const minQty = Number($("min").value || 0);
      if (!name) return;

      const n = norm(name);
      const existing = items.find(x => x.name_norm === n && x.unit === unit);

      if (existing) {
        existing.qty = round(existing.qty + qty);
        existing.min_qty = (minQty || minQty === 0) ? minQty : (existing.min_qty || 0);
      } else {
        items.push({
          id: crypto.randomUUID(),
          name,
          name_norm: n,
          unit,
          qty: round(qty || 0),
          min_qty: round(minQty || 0)
        });
      }

      $("name").value = "";
      $("qty").value = "";
      $("min").value = "";
      render();
      await saveNow(items);
    }

    function updateQty(id, delta) {
      const it = items.find(x => x.id === id);
      if (!it) return;
      it.qty = round(Math.max(0, Number(it.qty) + Number(delta)));
      render();
      saveDebounced(items);
    }

    async function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      await saveNow(items);
    }

    // ===== UI Events =====
    $("add").onclick = addItem;
    $("search").addEventListener("input", render);
    $("name").addEventListener("keydown", (e) => { if (e.key === "Enter") addItem(); });

    $("filterList").onclick = () => {
      showOnlyNeeds = !showOnlyNeeds;
      $("filterList").classList.toggle("active", showOnlyNeeds);
      $("filterList").textContent = showOnlyNeeds ? "Mostrar tudo" : "Filtrar lista";
      render();
    };

    $("export").onclick = () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "inventario.json";
      a.click();
      URL.revokeObjectURL(url);
    };

    $("import").onclick = async () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = async () => {
        const file = inp.files?.[0];
        if (!file) return;
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) return;
        items = data;
        render();
        await saveNow(items);
      };
      inp.click();
    };

    $("clear").onclick = async () => {
      if (!confirm("Tem certeza que quer zerar tudo?")) return;
      items = [];
      render();
      await saveNow(items);
    };

    $("logoutBtn").onclick = async () => {
      await stopRealtime();
      await supabase.auth.signOut();
      showAuth("login");
      setMsg($("authMsg"), "Saiu.");
    };

    // copiar uuidInv ao toque
    $("invUuid").onclick = async () => {
      const t = $("invUuid").textContent || "";
      if (!t) return;
      try {
        await navigator.clipboard.writeText(t);
        setMsg($("appMsg"), "uuidInv copiado ‚úÖ");
      } catch {
        setMsg($("appMsg"), "N√£o consegui copiar (permiss√£o do navegador).", true);
      }
    };

    // ===== AUTH NAV =====
    $("goRegister").onclick = () => showAuth("register");
    $("goJoin").onclick = () => showAuth("join");
    $("backToLogin1").onclick = () => showAuth("login");
    $("backToLogin2").onclick = () => showAuth("login");

    // ===== AUTH ACTIONS =====

    // LOGIN
    $("loginBtn").onclick = async () => {
      setMsg($("authMsg"), "");
      const email = $("loginEmail").value.trim();
      const password = $("loginPass").value;

      overlay(true);
      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { setMsg($("authMsg"), "Erro: " + error.message, true); return; }

        await bootAfterAuth();
      } catch (e) {
        console.error(e);
        setMsg($("authMsg"), "Falha no login. Veja Console (F12).", true);
      } finally {
        overlay(false);
      }
    };

    // REGISTER (cria conta + invent√°rio)
    $("registerBtn").onclick = async () => {
      setMsg($("regMsg"), "");
      const displayName = $("regName").value.trim();
      const email = $("regEmail").value.trim();
      const password = $("regPass").value;
      const invName = $("regInvName").value.trim() || "Invent√°rio da Casa";

      if (!displayName) { setMsg($("regMsg"), "Informe seu nome.", true); return; }
      if (!email) { setMsg($("regMsg"), "Informe seu email.", true); return; }
      if (!password || password.length < 6) { setMsg($("regMsg"), "Senha precisa ter pelo menos 6 caracteres.", true); return; }

      overlay(true);
      try {
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) { setMsg($("regMsg"), "Erro: " + error.message, true); return; }

        // algumas configs exigem confirmar email; tentamos seguir mesmo assim:
        await ensureProfile(displayName);

        // se o signUp j√° criou sess√£o, cria invent√°rio agora
        const user = await getUser();
        if (!user) {
          setMsg($("regMsg"), "Conta criada! Agora fa√ßa login (verifique o email se pedir confirma√ß√£o).");
          showAuth("login");
          return;
        }

        const invId = await createInventoryAndJoin(invName);
        setMsg($("regMsg"), "Conta criada ‚úÖ");
        await bootAfterAuth(invId);
      } catch (e) {
        console.error(e);
        setMsg($("regMsg"), "Falha no cadastro. Veja Console (F12).", true);
      } finally {
        overlay(false);
      }
    };

    // JOIN (login e vincula pelo uuidInv)
    $("joinBtn").onclick = async () => {
      setMsg($("joinMsg"), "");
      const email = $("joinEmail").value.trim();
      const password = $("joinPass").value;
      const uuidInv = ($("joinUuid").value || "").trim();

      if (!uuidInv) { setMsg($("joinMsg"), "Informe o uuidInv.", true); return; }

      overlay(true);
      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { setMsg($("joinMsg"), "Erro: " + error.message, true); return; }

        await ensureProfile("Usu√°rio");
        await joinInventoryByUuid(uuidInv);

        await bootAfterAuth(uuidInv);
      } catch (e) {
        console.error(e);
        setMsg($("joinMsg"), "Falha ao vincular. Confere o uuidInv e tente de novo.", true);
      } finally {
        overlay(false);
      }
    };

    // ===== BOOT =====
    async function bootAfterAuth(forceInventoryId = null) {
      const user = await getUser();
      if (!user) { showAuth("login"); return; }

      // garante perfil
      const profile = await ensureProfile("Usu√°rio");

      // decide invent√°rio atual
      let invId = forceInventoryId || profile?.current_inventory_id || null;

      // se n√£o tem invent√°rio ainda, manda pra tela de "vincular"
      if (!invId) {
        showAuth("join");
        setMsg($("joinMsg"), "Entre com o uuidInv para vincular seu usu√°rio ao invent√°rio da casa.", false);
        return;
      }

      currentInventoryId = invId;
      $("invUuid").textContent = invId;

      // carrega do cache local (por inv)
      items = loadLocal(invId) || [];
      showApp();
      render();

      setMsg($("appMsg"), "Sincronizando‚Ä¶");

      // carrega do cloud
      try {
        const cloud = await loadItemsFromInventory(invId);
        if (Array.isArray(cloud)) {
          items = cloud;
          saveLocal(invId, items);
        }
        render();
      } catch (e) {
        console.error(e);
        setMsg($("appMsg"), "N√£o consegui ler do cloud (permiss√£o/RLS). Veja Console (F12).", true);
      }

      // realtime por invent√°rio
      await startRealtime(invId);

      setMsg($("appMsg"), "Sincronizado ‚úÖ");
    }

    // Boot inicial (sess√£o)
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        overlay(true);
        try {
          await bootAfterAuth();
        } finally {
          overlay(false);
        }
      } else {
        showAuth("login");
      }
    })();
  </script>
</body>
</html>