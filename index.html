<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio da Casa</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <!-- Overlay -->
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <!-- Toast host -->
  <div id="toastHost" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- ===== AUTH ===== -->
  <div id="authView" class="center-screen">
    <div class="card login-card">
      <h1 class="title" id="authTitle">Entrar</h1>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="row">
          <input id="loginEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>

        <div class="row mt12">
          <button id="loginBtn">Logar</button>
          <button id="openRegisterBtn" class="small" type="button">Registrar</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" class="hidden">
        <div class="row">
          <input id="regName" placeholder="Seu nome" autocomplete="name" />
        </div>
        <div class="row mt10">
          <input id="regEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="regPass" type="password" placeholder="Senha" autocomplete="new-password" />
        </div>

        <div class="row mt10" style="align-items:center;">
          <label class="checkline">
            <input id="genInv" type="checkbox" checked />
            Gerar invent√°rio
          </label>
        </div>

        <div class="row mt10">
          <input id="invCode" placeholder="C√≥digo do invent√°rio (6 letras/n√∫meros)" autocomplete="off" disabled />
        </div>

        <div class="row mt12">
          <button id="registerBtn">Criar conta</button>
          <button id="backToLoginBtn" class="small" type="button">Voltar</button>
        </div>

        <div class="muted">
          Se marcar ‚ÄúGerar invent√°rio‚Äù, voc√™ vira dono e ganha um c√≥digo pra compartilhar.
        </div>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appView" class="wrap hidden">
    <div class="card">
      <div class="row header-row">
        <h1 class="title">Invent√°rio da Casa</h1>
        <div class="row" style="gap:10px; align-items:center;">
          <button id="adminBtn" class="small ghost hidden" type="button" title="Painel admin">üõ°Ô∏è</button>
          <button id="logoutBtn" class="small">Sair</button>
        </div>
      </div>

      <div class="muted" style="margin-top:6px;">
        C√≥digo do invent√°rio:
        <span id="invCodeShow" class="pill copy" title="Toque para copiar"></span>
      </div>

      <div class="divider"></div>

      <!-- MEMBERS -->
      <div id="membersBox">
        <div class="row header-row" style="align-items:flex-end;">
          <div>
            <div style="font-weight:900;">Membros</div>
            <div class="muted" style="margin-top:4px;">Tempo real ‚Ä¢ cargo ‚Ä¢ visto por √∫ltimo</div>
          </div>
          <div class="pill" id="myRolePill" title="Seu cargo">‚Äî</div>
        </div>
        <div id="membersList" class="list" style="margin-top:10px;"></div>
      </div>

      <div class="divider"></div>

      <!-- SEARCH -->
      <div class="row">
        <input id="search" placeholder="Buscar item" />
      </div>

      <div class="divider"></div>

      <!-- ADD / EDIT -->
      <div class="row">
        <input id="name" placeholder="Novo item:" />
        <select id="unit">
          <option value="un">un</option>
          <option value="g">g</option>
          <option value="kg">kg</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
        <input id="qty" type="number" step="0.1" placeholder="Qtd" class="w120" />
        <input id="min" type="number" step="0.1" placeholder="M√≠n" class="w120" />

        <label class="checkline" style="align-items:center; gap:8px;">
          <input id="essential" type="checkbox" />
          Essencial
        </label>

        <button id="add">Adicionar</button>
        <button id="cancelEdit" class="small ghost hidden" type="button">Cancelar</button>
      </div>

      <div class="muted" id="editHint" style="margin-top:8px;">
        Dica: ‚ÄúM√≠n‚Äù emite alerta ao chegar na quantidade definida.
      </div>

      <div class="divider"></div>

      <!-- ACTIONS -->
      <div class="row actions">
        <button class="small" id="filterList">Filtrar lista</button>
        <button class="small" id="filterEssentials">Essenciais: ambos</button>
        <button class="small" id="exportText">Exportar (texto)</button>
        <button class="small" id="import">Importar</button>
        <button class="small" id="clear">Zerar tudo</button>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer id="footer" class="footer"></footer>

  <!-- ===== ADMIN MODAL ===== -->
  <div id="adminModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="row header-row">
        <div>
          <div class="section-title">Painel Admin</div>
          <div class="muted">Somente dono do invent√°rio</div>
        </div>
        <button id="adminClose" class="small ghost" type="button">Fechar</button>
      </div>

      <div class="divider"></div>

      <!-- Login admin (local) -->
      <div id="adminLoginBox">
        <div class="muted" style="margin-top:0">Entre para liberar a√ß√µes administrativas.</div>

        <div class="row mt12">
          <input id="adminUser" placeholder="Usu√°rio" autocomplete="off" />
        </div>
        <div class="row mt10">
          <input id="adminPass" type="password" placeholder="Senha" autocomplete="off" />
        </div>

        <div class="row mt12" style="justify-content:flex-end;">
          <button id="adminLoginBtn" class="small" type="button">Entrar</button>
        </div>

        <div class="muted">
          Padr√£o: usu√°rio <b>admin</b> ‚Ä¢ senha <b>admin000teste</b>
        </div>
      </div>

      <!-- A√ß√µes -->
      <div id="adminActionsBox" class="hidden">
        <div class="muted" style="margin-top:0">
          Invent√°rio atual: <span class="pill" id="adminInvPill">‚Äî</span>
        </div>

        <div class="divider"></div>

        <div class="row" style="gap:10px;">
          <button id="adminClearItems" class="small" type="button">üßπ Zerar itens (invent√°rio)</button>
          <button id="adminResetHistory" class="small" type="button">üïì Resetar hist√≥rico (itens)</button>
          <button id="adminKickMembers" class="small" type="button">üë• Remover membros (exceto eu)</button>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:flex-end;">
          <button id="adminDangerDeleteInv" class="small" type="button"
            style="border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10);">
            ‚ò†Ô∏è Apagar invent√°rio (PERIGOSO)
          </button>
        </div>

        <div class="muted">
          Essas a√ß√µes rodam no banco via RPC e s√≥ funcionam se voc√™ for <b>owner</b>.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ========= CONFIG =========
    const SUPABASE_URL = "https://xzcgwnifypiqqushxrcs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9Nx27f1V0IgMkMw6BdTwmQ_B96lf3wq";
    const APP_URL = "https://dihegoof.github.io/manager/";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ========= READY =========
    const ready = (fn) => (document.readyState === "loading"
      ? document.addEventListener("DOMContentLoaded", fn, { once: true })
      : fn());

    ready(() => {
      // ========= HELPERS =========
      const $ = (id) => document.getElementById(id);

      const norm = (s) => (s || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();

      const round = (v) => Math.round((Number(v) + Number.EPSILON) * 10) / 10;

      function fmtDate(ts) {
        if (!ts) return "‚Äî";
        const d = new Date(ts);
        if (isNaN(d.getTime())) return "‚Äî";
        return d.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
      }

      function diffDays(a, b) {
        if (!a || !b) return null;
        const da = new Date(a), db = new Date(b);
        if (isNaN(da) || isNaN(db)) return null;
        const ms = db.getTime() - da.getTime();
        if (ms < 0) return null;
        return Math.floor(ms / (1000 * 60 * 60 * 24));
      }

      // Footer
      $("footer").innerHTML = `¬© ${new Date().getFullYear()}
        <a href="https://github.com/Dihegoof" target="_blank" rel="noopener">Dihego Nunes</a>
        ‚Äî Todos os direitos reservados`;

      // ========= TOAST =========
      const lastToastAt = new Map();
      function normalizeToastType(type) {
        if (type === "success" || type === "error" || type === "warn") return type;
        return "warn";
      }
      function toast(message, type = "warn", key = "") {
        const t = normalizeToastType(type);
        const msg = (message || "").toString().trim();
        if (!msg) return;

        const k = key || (t + ":" + msg);
        const now = Date.now();
        const last = lastToastAt.get(k) || 0;
        if (now - last < 900) return;
        lastToastAt.set(k, now);

        const host = $("toastHost");
        const wrap = document.createElement("div");
        wrap.className = `toast ${t}`;

        const bubble = document.createElement("div");
        bubble.className = "toast-bubble";
        bubble.textContent = msg;

        wrap.appendChild(bubble);
        host.appendChild(wrap);

        requestAnimationFrame(() => wrap.classList.add("show"));
        setTimeout(() => wrap.classList.add("hide"), 3200);
        setTimeout(() => wrap.remove(), 3800);
      }

      // ========= OVERLAY (failsafe) =========
      function overlay(on) { $("overlay").classList.toggle("on", !!on); }
      let overlayTimer = null;
      function overlaySafe(on, reason = "") {
        overlay(!!on);
        clearTimeout(overlayTimer);
        if (on) {
          overlayTimer = setTimeout(() => {
            overlay(false);
            toast("Travou no carregamento. Atualiza a p√°gina.", "warn", "overlay-timeout");
            console.warn("Overlay timeout:", reason);
          }, 9000);
        }
      }

      function withTimeout(promise, ms, label = "opera√ß√£o") {
        return Promise.race([
          promise,
          new Promise((_, reject) => setTimeout(() => reject(new Error(`${label}: timeout (${ms}ms)`)), ms))
        ]);
      }

      window.addEventListener("unhandledrejection", (e) => {
        console.error("unhandledrejection:", e?.reason);
        overlay(false);
        toast("Erro: " + (e?.reason?.message || e?.reason || "falha"), "error", "unhandled");
      });
      window.addEventListener("error", (e) => {
        console.error("window error:", e?.message, e);
        overlay(false);
        toast("Erro: " + (e?.message || "falha"), "error", "window-error");
      });

      // ========= VIEWS =========
      function showLogin() {
        $("authTitle").textContent = "Entrar";
        $("loginForm").classList.remove("hidden");
        $("registerForm").classList.add("hidden");
        $("authView").classList.remove("hidden");
        $("appView").classList.add("hidden");
        $("authView").classList.add("fade-in");
      }
      function showRegister() {
        $("authTitle").textContent = "Registrar";
        $("loginForm").classList.add("hidden");
        $("registerForm").classList.remove("hidden");
        $("authView").classList.remove("hidden");
        $("appView").classList.add("hidden");
        syncRegisterUI();
        $("authView").classList.add("fade-in");
      }
      function showApp() {
        $("authView").classList.add("hidden");
        $("appView").classList.remove("hidden");
        $("appView").classList.add("fade-in");
      }
      function syncRegisterUI() {
        const gen = $("genInv").checked;
        $("invCode").disabled = gen;
        if (gen) $("invCode").value = "";
      }

      // ========= STATE =========
      let currentUser = null;
      let currentInventoryId = null;

      let items = [];
      let members = [];

      let realtimeItems = null;
      let realtimeMembers = null;

      let showOnlyNeeds = false;
      let essentialFilter = "both"; // both | essential | not

      let editItemId = null;

      // ‚úÖ ADMIN STATE
      let isOwner = false;
      let adminUnlocked = false;

      // pending setup (caso confirm email ON)
      const PENDING_KEY = "pending_inv_setup_v4";
      const setPending = (obj) => localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
      const getPending = () => { try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "null"); } catch { return null; } };
      const clearPending = () => localStorage.removeItem(PENDING_KEY);

      function needsBuy(it) {
        const qty = Number(it.qty ?? 0);
        const min = Number(it.min_qty ?? 0);
        return qty <= 0 || (min > 0 && qty <= min);
      }

      function showInfo(it) {
        const d = diffDays(it.last_buy_at, it.last_zero_at);
        const dur = (d == null) ? "‚Äî" : `${d} dia(s)`;

        const txt =
`üì¶ ${it.name}

üõí √öltima compra:
- data: ${fmtDate(it.last_buy_at)}
- qtd:  ${it.last_buy_qty ?? "‚Äî"}

üõí Compra anterior:
- data: ${fmtDate(it.prev_buy_at)}
- qtd:  ${it.prev_buy_qty ?? "‚Äî"}

üßØ √öltimo zerado:
- data: ${fmtDate(it.last_zero_at)}

‚è±Ô∏è Dura√ß√£o (√∫ltima compra ‚Üí √∫ltimo zerado):
- ${dur}
`;
        alert(txt);
      }

      // ========= RENDER MEMBERS =========
      function renderMembers() {
        const host = $("membersList");
        host.innerHTML = "";

        if (!members.length) {
          const empty = document.createElement("div");
          empty.className = "sub";
          empty.textContent = "Nenhum membro ainda.";
          host.appendChild(empty);
          return;
        }

        const sorted = [...members].sort((a,b) => {
          const ra = (a.role === "owner") ? 0 : 1;
          const rb = (b.role === "owner") ? 0 : 1;
          if (ra !== rb) return ra - rb;
          return (a.display_name || "").localeCompare((b.display_name || ""), "pt-BR");
        });

        for (const m of sorted) {
          const row = document.createElement("div");
          row.className = "item";

          const left = document.createElement("div");
          const star = m.role === "owner" ? " ‚òÖ" : "";
          left.innerHTML = `
            <div class="name">${m.display_name || "Usu√°rio"}${star}</div>
            <div class="sub">cargo: ${m.role} ‚Ä¢ visto: ${fmtDate(m.last_seen_at)}</div>
          `;

          row.appendChild(left);
          host.appendChild(row);
        }
      }

      // ========= RENDER ITEMS =========
      function renderItems() {
        const q = norm($("search").value);
        const list = $("list");
        list.innerHTML = "";

        let filtered = items
          .filter(it => {
            const matchesSearch = !q || (it.name_norm || "").includes(q);
            const matchesNeeds = !showOnlyNeeds || needsBuy(it);

            let matchesEssential = true;
            if (essentialFilter === "essential") matchesEssential = !!it.essential;
            if (essentialFilter === "not") matchesEssential = !it.essential;

            return matchesSearch && matchesNeeds && matchesEssential;
          })
          .sort((a,b) => (a.name || "").localeCompare((b.name || ""), "pt-BR"));

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "sub";
          empty.textContent = showOnlyNeeds ? "Nenhum item precisa comprar üôÇ" : "Nada por aqui üôÇ";
          list.appendChild(empty);
          return;
        }

        for (const it of filtered) {
          const row = document.createElement("div");
          row.className = "item";

          const left = document.createElement("div");
          const needs = needsBuy(it);
          const ess = it.essential ? ' ‚Ä¢ <span class="pill">essencial</span>' : "";
          left.innerHTML = `
            <div class="name">${it.name}</div>
            <div class="sub">
              ${it.qty} ${it.unit} ‚Ä¢ m√≠nimo: ${it.min_qty || 0}
              ${needs ? ' ‚Ä¢ <span class="pill danger">precisa comprar</span>' : ""}
              ${ess}
            </div>
          `;

          const controls = document.createElement("div");
          controls.className = "controls";

          const minus = document.createElement("button");
          minus.textContent = "‚àí";
          minus.onclick = () => changeQty(it.id, it.unit === "un" ? -1 : -0.1);

          const edit = document.createElement("button");
          edit.textContent = "‚öôÔ∏è";
          edit.title = "Editar";
          edit.onclick = () => startEdit(it);

          const info = document.createElement("button");
          info.textContent = "‚ÑπÔ∏è";
          info.title = "Info / hist√≥rico";
          info.onclick = () => showInfo(it);

          const del = document.createElement("button");
          del.textContent = "üóëÔ∏è";
          del.title = "Excluir";
          del.onclick = () => deleteItem(it.id, it.name);

          const qty = document.createElement("div");
          qty.className = "qty pill";
          qty.textContent = `${it.qty} ${it.unit}`;

          const plus = document.createElement("button");
          plus.textContent = "+";
          plus.onclick = () => changeQty(it.id, it.unit === "un" ? +1 : +0.1);

          controls.append(minus, edit, info, del, qty, plus);
          row.append(left, controls);
          list.appendChild(row);
        }
      }

      // ========= AUTH / BOOT =========
      async function getSession() {
        const { data: { session } } = await supabase.auth.getSession();
        return session || null;
      }

      async function ensureProfileRow(displayName = "Usu√°rio") {
        const { error } = await withTimeout(
          supabase.from("profiles").upsert({ user_id: currentUser.id, display_name: displayName }),
          8000,
          "profile upsert"
        );
        if (error) throw error;
      }

      async function finalizePendingIfAny() {
        const pending = getPending();
        if (!pending || !currentUser) return false;

        try {
          await ensureProfileRow(pending.displayName || "Usu√°rio");

          let invId = null;

          if (pending.mode === "create") {
            const { data, error } = await withTimeout(
              supabase.rpc("create_inventory_and_set_profile", {
                p_name: "Invent√°rio da Casa",
                p_display_name: pending.displayName || "Usu√°rio",
              }),
              9000,
              "RPC create"
            );
            if (error) throw error;
            invId = data?.[0]?.inventory_id || data?.inventory_id || data?.[0] || null;
          } else {
            const { data, error } = await withTimeout(
              supabase.rpc("join_inventory_by_code", {
                p_code: pending.code,
                p_display_name: pending.displayName || "Usu√°rio",
              }),
              9000,
              "RPC join"
            );
            if (error) throw error;
            invId = data?.[0]?.inventory_id || data?.inventory_id || data?.[0] || null;
          }

          clearPending();
          if (!invId) throw new Error("N√£o consegui obter o invent√°rio.");
          await bootInventory(invId);
          return true;

        } catch (e) {
          console.error(e);
          clearPending();
          toast("Falha ao finalizar v√≠nculo/cria√ß√£o: " + (e?.message || e), "error", "finalize-fail");
          return true;
        }
      }

      async function loadInventoryMeta(invId) {
        const { data, error } = await withTimeout(
          supabase.from("inventories")
            .select("invite_code, name")
            .eq("id", invId)
            .single(),
          8000,
          "load inventory meta"
        );
        if (error) throw error;
        $("invCodeShow").textContent = data?.invite_code || "(sem c√≥digo)";
      }

      async function loadItems(invId) {
        const { data, error } = await withTimeout(
          supabase.from("inventory_items")
            .select("*")
            .eq("inventory_id", invId),
          8000,
          "load items"
        );
        if (error) throw error;
        items = Array.isArray(data) ? data : [];
        renderItems();
      }

      function setAdminVisible() {
        if (isOwner) $("adminBtn").classList.remove("hidden");
        else $("adminBtn").classList.add("hidden");
      }

      async function loadMembers(invId) {
        const { data, error } = await withTimeout(
          supabase.from("inventory_members")
            .select("inventory_id,user_id,role,display_name,last_seen_at,created_at")
            .eq("inventory_id", invId),
          8000,
          "load members"
        );
        if (error) throw error;
        members = Array.isArray(data) ? data : [];
        renderMembers();

        const me = members.find(m => m.user_id === currentUser.id);
        $("myRolePill").textContent = me?.role ? `voc√™: ${me.role}` : "voc√™: ‚Äî";

        // ‚úÖ owner -> mostra bot√£o admin
        isOwner = (me?.role === "owner");
        setAdminVisible();
      }

      async function stopRealtime() {
        try { if (realtimeItems) await supabase.removeChannel(realtimeItems); } catch {}
        try { if (realtimeMembers) await supabase.removeChannel(realtimeMembers); } catch {}
        realtimeItems = null;
        realtimeMembers = null;
      }

      async function startRealtime(invId) {
        await stopRealtime();

        realtimeItems = supabase
          .channel("rt-items-" + invId)
          .on("postgres_changes", {
            event: "*",
            schema: "public",
            table: "inventory_items",
            filter: `inventory_id=eq.${invId}`,
          }, (payload) => {
            const ev = payload.eventType;
            if (ev === "INSERT") {
              items = [payload.new, ...items.filter(x => x.id !== payload.new.id)];
            } else if (ev === "UPDATE") {
              items = items.map(x => x.id === payload.new.id ? payload.new : x);
            } else if (ev === "DELETE") {
              items = items.filter(x => x.id !== payload.old.id);
            }
            renderItems();
          })
          .subscribe((status) => {
            console.log("[realtime items]", status);
            if (status === "SUBSCRIBED") toast("Tempo real ativo ‚úÖ", "success", "rt-items-ok");
            if (status === "CHANNEL_ERROR") toast("Falha no tempo real (itens).", "warn", "rt-items-err");
            if (status === "TIMED_OUT") toast("Tempo real demorou pra conectar (itens).", "warn", "rt-items-timeout");
          });

        realtimeMembers = supabase
          .channel("rt-members-" + invId)
          .on("postgres_changes", {
            event: "*",
            schema: "public",
            table: "inventory_members",
            filter: `inventory_id=eq.${invId}`,
          }, (payload) => {
            const ev = payload.eventType;
            if (ev === "INSERT") {
              members = [payload.new, ...members.filter(x => x.user_id !== payload.new.user_id)];
            } else if (ev === "UPDATE") {
              members = members.map(x => x.user_id === payload.new.user_id ? payload.new : x);
            } else if (ev === "DELETE") {
              members = members.filter(x => x.user_id !== payload.old.user_id);
            }
            renderMembers();

            const me = members.find(m => m.user_id === currentUser.id);
            $("myRolePill").textContent = me?.role ? `voc√™: ${me.role}` : "voc√™: ‚Äî";

            isOwner = (me?.role === "owner");
            setAdminVisible();
          })
          .subscribe((status) => {
            console.log("[realtime members]", status);
            if (status === "CHANNEL_ERROR") toast("Falha no tempo real (membros).", "warn", "rt-mem-err");
          });
      }

      async function bootInventory(invId) {
        currentInventoryId = invId;
        showApp();

        overlaySafe(true, "boot");
        try {
          await loadInventoryMeta(invId);
          await Promise.all([ loadItems(invId), loadMembers(invId) ]);
          await startRealtime(invId);
          toast("Sincronizado ‚úÖ", "success", "synced");
        } finally {
          overlaySafe(false, "boot");
        }
      }

      // ‚úÖ BOOT DEFINITIVO (se tiver inv -> entra; se n√£o -> cria; se perdeu acesso -> admin)
      async function bootFromProfile() {
        if (!currentUser) return;

        // 1) tenta finalizar pending (se houver)
        const did = await finalizePendingIfAny();
        if (did) return;

        // 2) profile
        const { data: prof, error } = await withTimeout(
          supabase.from("profiles")
            .select("current_inventory_id, display_name")
            .eq("user_id", currentUser.id)
            .maybeSingle(),
          8000,
          "load profile"
        );
        if (error) throw error;

        const displayName = prof?.display_name || "Usu√°rio";
        const invId = prof?.current_inventory_id || null;

        // 3) sem invent√°rio -> cria automaticamente
        if (!invId) {
          overlaySafe(true, "auto-create-inv");
          try {
            await ensureProfileRow(displayName);

            const { data, error } = await withTimeout(
              supabase.rpc("create_inventory_and_set_profile", {
                p_name: "Invent√°rio da Casa",
                p_display_name: displayName,
              }),
              9000,
              "RPC auto create"
            );
            if (error) throw error;

            const newInvId = data?.[0]?.inventory_id || data?.inventory_id || data?.[0] || null;
            if (!newInvId) throw new Error("N√£o consegui criar invent√°rio.");

            await bootInventory(newInvId);
            toast("Invent√°rio criado ‚úÖ", "success", "auto-inv-ok");
            return;

          } catch (e) {
            console.error(e);
            toast("Falha ao criar invent√°rio: " + (e?.message || e), "error", "auto-inv-fail");
            return;
          } finally {
            overlaySafe(false, "auto-create-inv");
          }
        }

        // 4) tem invent√°rio -> tenta abrir; se permission -> admin
        try {
          await bootInventory(invId);
          return;
        } catch (e) {
          console.error(e);
          const msg = (e?.message || "").toLowerCase();
          const access =
            msg.includes("permission") ||
            msg.includes("denied") ||
            msg.includes("row level") ||
            msg.includes("not allowed");

          if (access) {
            toast("Voc√™ perdeu acesso a este invent√°rio (removido/exclu√≠do). Fale com o admin.", "error", "lost-access");
            return;
          }
          toast("Falha ao abrir invent√°rio: " + (e?.message || e), "error", "boot-inv-fail");
          return;
        }
      }

      // ========= LAST SEEN =========
      let lastSeenPingAt = 0;
      async function pingLastSeen() {
        if (!currentUser || !currentInventoryId) return;
        const now = Date.now();
        if (now - lastSeenPingAt < 60_000) return;
        lastSeenPingAt = now;

        const { error } = await supabase
          .from("inventory_members")
          .update({ last_seen_at: new Date().toISOString() })
          .eq("inventory_id", currentInventoryId)
          .eq("user_id", currentUser.id);

        if (error) console.warn("last_seen update:", error.message);
      }

      setInterval(() => { pingLastSeen(); }, 60_000);
      window.addEventListener("focus", () => { pingLastSeen(); });
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) pingLastSeen(); // ‚úÖ sem overlay aqui
      });

      // ========= ITEMS CRUD =========
      function resetEdit() {
        editItemId = null;
        $("cancelEdit").classList.add("hidden");
        $("add").textContent = "Adicionar";
        $("editHint").textContent = "Dica: ‚ÄúM√≠n‚Äù emite alerta ao chegar na quantidade definida.";
      }

      function startEdit(it) {
        editItemId = it.id;
        $("name").value = it.name || "";
        $("unit").value = it.unit || "un";
        $("qty").value = it.qty ?? 0;
        $("min").value = it.min_qty ?? 0;
        $("essential").checked = !!it.essential;

        $("cancelEdit").classList.remove("hidden");
        $("add").textContent = "Salvar";
        $("editHint").textContent = "Editando item ‚Äî altere os campos e clique em Salvar.";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      async function upsertItem() {
        if (!currentUser || !currentInventoryId) return;

        const name = $("name").value.trim();
        const unit = $("unit").value;
        const qty = round(Number($("qty").value || 0));
        const minQty = round(Number($("min").value || 0));
        const essential = !!$("essential").checked;

        if (!name) return toast("Informe o nome do item.", "warn", "need-name");

        const payload = {
          inventory_id: currentInventoryId,
          name,
          name_norm: norm(name),
          unit,
          qty,
          min_qty: minQty,
          essential,
        };

        overlaySafe(true, "upsert-item");
        try {
          if (editItemId) {
            const { data, error } = await withTimeout(
              supabase.from("inventory_items")
                .update(payload)
                .eq("id", editItemId)
                .eq("inventory_id", currentInventoryId)
                .select("*")
                .single(),
              8000,
              "update item"
            );
            if (error) throw error;

            // ‚úÖ atualiza local imediatamente
            items = items.map(x => x.id === data.id ? data : x);
            renderItems();

            toast("Atualizado ‚úÖ", "success", "item-upd");
            resetEdit();
          } else {
            payload.created_by = currentUser.id;

            const { data, error } = await withTimeout(
              supabase.from("inventory_items")
                .insert(payload)
                .select("*")
                .single(),
              8000,
              "insert item"
            );
            if (error) throw error;

            // ‚úÖ insere local imediatamente
            items = [data, ...items.filter(x => x.id !== data.id)];
            renderItems();

            toast("Adicionado ‚úÖ", "success", "item-add");
          }

          $("name").value = "";
          $("qty").value = "";
          $("min").value = "";
          $("essential").checked = false;

        } catch (e) {
          console.error(e);
          toast("Falha ao salvar: " + (e?.message || e), "error", "save-fail");
        } finally {
          overlaySafe(false, "upsert-item");
        }
      }

      async function changeQty(itemId, delta) {
        const it = items.find(x => x.id === itemId);
        if (!it) return;

        const newQty = round(Math.max(0, Number(it.qty || 0) + Number(delta)));

        // otimista
        items = items.map(x => x.id === itemId ? { ...x, qty: newQty } : x);
        renderItems();

        const { data, error } = await supabase
          .from("inventory_items")
          .update({ qty: newQty })
          .eq("id", itemId)
          .eq("inventory_id", currentInventoryId)
          .select("*")
          .single();

        if (error) {
          console.warn(error);
          toast("N√£o salvou no cloud: " + error.message, "error", "qty-fail");
          try { await loadItems(currentInventoryId); } catch {}
          return;
        }

        if (data) {
          items = items.map(x => x.id === data.id ? data : x);
          renderItems();
        }
      }

      async function deleteItem(itemId, name = "") {
        if (!currentInventoryId) return;

        const label = name ? `‚Äú${name}‚Äù` : "este item";
        if (!confirm(`Excluir ${label}?`)) return;

        // otimista
        const prev = items.slice();
        items = items.filter(x => x.id !== itemId);
        renderItems();

        overlaySafe(true, "delete");
        try {
          const { error } = await withTimeout(
            supabase.from("inventory_items")
              .delete()
              .eq("id", itemId)
              .eq("inventory_id", currentInventoryId),
            8000,
            "delete item"
          );
          if (error) throw error;

          toast("Exclu√≠do ‚úÖ", "success", "item-del");
        } catch (e) {
          console.error(e);
          items = prev;
          renderItems();
          toast("Falha ao excluir: " + (e?.message || e), "error", "del-fail");
          try { await loadItems(currentInventoryId); } catch {}
        } finally {
          overlaySafe(false, "delete");
        }
      }

      // ========= EXPORT / IMPORT / CLEAR =========
      function exportText() {
        const lines = items
          .slice()
          .sort((a,b) => (a.name||"").localeCompare((b.name||""), "pt-BR"))
          .map(it => {
            const ess = it.essential ? " (essencial)" : "";
            const needs = needsBuy(it) ? " [PRECISA]" : "";
            return `- ${it.name}: ${it.qty} ${it.unit} (min: ${it.min_qty || 0})${ess}${needs}`;
          });

        const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "inventario.txt";
        a.click();
        URL.revokeObjectURL(url);
        toast("Exportado ‚úÖ", "success", "export-text");
      }

      async function importJson() {
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = "application/json";

        inp.onchange = async () => {
          const file = inp.files?.[0];
          if (!file) return;

          overlaySafe(true, "import");
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            if (!Array.isArray(data)) return toast("Arquivo inv√°lido.", "error", "import-invalid");

            const rows = data.map(x => ({
              inventory_id: currentInventoryId,
              name: x.name || "",
              name_norm: x.name_norm || norm(x.name || ""),
              unit: x.unit || "un",
              qty: round(Number(x.qty || 0)),
              min_qty: round(Number(x.min_qty || 0)),
              essential: !!x.essential,
              created_by: currentUser.id,
            })).filter(r => r.name.trim());

            if (!rows.length) return toast("Nada pra importar.", "warn", "import-empty");

            const { error } = await withTimeout(
              supabase.from("inventory_items").insert(rows),
              9000,
              "import insert"
            );
            if (error) throw error;

            toast("Importado ‚úÖ", "success", "import-ok");
          } catch (e) {
            console.error(e);
            toast("Falha ao importar: " + (e?.message || e), "error", "import-fail");
          } finally {
            overlaySafe(false, "import");
          }
        };

        inp.click();
      }

      async function clearAll() {
        if (!confirm("Tem certeza que quer zerar tudo?")) return;

        overlaySafe(true, "clear");
        try {
          const { error } = await withTimeout(
            supabase.from("inventory_items")
              .delete()
              .eq("inventory_id", currentInventoryId),
            9000,
            "clear items"
          );
          if (error) throw error;

          toast("Zerado ‚úÖ", "success", "clear-ok");
        } catch (e) {
          console.error(e);
          toast("Falha ao zerar: " + (e?.message || e), "error", "clear-fail");
        } finally {
          overlaySafe(false, "clear");
        }
      }

      // ========= ADMIN PANEL =========
      const ADMIN_DEFAULT_USER = "admin";
      const ADMIN_DEFAULT_PASS = "admin000teste";

      function openAdmin() {
        if (!$("adminModal")) return;
        $("adminModal").classList.add("on");
        $("adminModal").setAttribute("aria-hidden", "false");

        adminUnlocked = false;
        $("adminLoginBox").classList.remove("hidden");
        $("adminActionsBox").classList.add("hidden");

        $("adminInvPill").textContent = currentInventoryId ? currentInventoryId.slice(0, 8) + "‚Ä¶" : "‚Äî";
        $("adminUser").value = "";
        $("adminPass").value = "";
        $("adminUser").focus();
      }

      function closeAdmin() {
        $("adminModal").classList.remove("on");
        $("adminModal").setAttribute("aria-hidden", "true");
      }

      $("adminModal").addEventListener("click", (e) => {
        if (e.target === $("adminModal")) closeAdmin();
      });
      $("adminClose").onclick = closeAdmin;

      $("adminBtn").onclick = () => openAdmin();

      $("adminLoginBtn").onclick = async () => {
        const u = ($("adminUser").value || "").trim();
        const p = ($("adminPass").value || "").trim();

        if (!u || !p) return toast("Informe usu√°rio e senha.", "warn", "adm-need");

        if (u === ADMIN_DEFAULT_USER && p === ADMIN_DEFAULT_PASS) {
          adminUnlocked = true;
          $("adminLoginBox").classList.add("hidden");
          $("adminActionsBox").classList.remove("hidden");
          toast("Admin liberado ‚úÖ", "success", "adm-ok");
          return;
        }

        toast("Credenciais inv√°lidas.", "error", "adm-bad");
      };

      async function adminEnsure() {
        if (!adminUnlocked) throw new Error("Fa√ßa login no admin primeiro.");
        if (!currentInventoryId) throw new Error("Sem invent√°rio carregado.");
        if (!isOwner) throw new Error("Somente owner pode usar o admin.");
      }

      $("adminClearItems").onclick = async () => {
        try {
          await adminEnsure();
          if (!confirm("Zerar TODOS os itens deste invent√°rio?")) return;

          overlaySafe(true, "admin-clear-items");
          const { error } = await withTimeout(
            supabase.rpc("admin_clear_items", { p_inventory_id: currentInventoryId }),
            12000,
            "admin_clear_items"
          );
          if (error) throw error;

          toast("Itens zerados ‚úÖ", "success", "adm-clear-ok");
        } catch (e) {
          console.error(e);
          toast("Admin: " + (e?.message || e), "error", "adm-clear-fail");
        } finally {
          overlaySafe(false, "admin-clear-items");
        }
      };

      $("adminResetHistory").onclick = async () => {
        try {
          await adminEnsure();
          if (!confirm("Resetar hist√≥rico (last_buy/prev_buy/last_zero) de TODOS os itens?")) return;

          overlaySafe(true, "admin-reset-history");
          const { error } = await withTimeout(
            supabase.rpc("admin_reset_history", { p_inventory_id: currentInventoryId }),
            12000,
            "admin_reset_history"
          );
          if (error) throw error;

          toast("Hist√≥rico resetado ‚úÖ", "success", "adm-hist-ok");
        } catch (e) {
          console.error(e);
          toast("Admin: " + (e?.message || e), "error", "adm-hist-fail");
        } finally {
          overlaySafe(false, "admin-reset-history");
        }
      };

      $("adminKickMembers").onclick = async () => {
        try {
          await adminEnsure();
          if (!confirm("Remover TODOS os membros (exceto voc√™) deste invent√°rio?")) return;

          overlaySafe(true, "admin-kick");
          const { error } = await withTimeout(
            supabase.rpc("admin_kick_members", { p_inventory_id: currentInventoryId }),
            12000,
            "admin_kick_members"
          );
          if (error) throw error;

          toast("Membros removidos ‚úÖ", "success", "adm-kick-ok");
        } catch (e) {
          console.error(e);
          toast("Admin: " + (e?.message || e), "error", "adm-kick-fail");
        } finally {
          overlaySafe(false, "admin-kick");
        }
      };

      $("adminDangerDeleteInv").onclick = async () => {
        try {
          await adminEnsure();

          const confirm1 = confirm("‚ö†Ô∏è Isso vai APAGAR o invent√°rio e tudo dentro. Tem certeza?");
          if (!confirm1) return;
          const confirm2 = prompt("Digite APAGAR para confirmar:");
          if ((confirm2 || "").trim().toUpperCase() !== "APAGAR") return toast("Cancelado.", "warn", "adm-del-cancel");

          overlaySafe(true, "admin-delete-inv");
          const { error } = await withTimeout(
            supabase.rpc("admin_delete_inventory", { p_inventory_id: currentInventoryId }),
            15000,
            "admin_delete_inventory"
          );
          if (error) throw error;

          toast("Invent√°rio apagado.", "warn", "adm-del-ok");
          closeAdmin();

          await stopRealtime();
          await supabase.auth.signOut();
          currentUser = null;
          currentInventoryId = null;
          items = [];
          members = [];
          resetEdit();
          showLogin();
        } catch (e) {
          console.error(e);
          toast("Admin: " + (e?.message || e), "error", "adm-del-fail");
        } finally {
          overlaySafe(false, "admin-delete-inv");
        }
      };

      // ========= UI EVENTS =========
      $("openRegisterBtn").onclick = () => showRegister();
      $("backToLoginBtn").onclick = () => showLogin();
      $("genInv").addEventListener("change", syncRegisterUI);

      $("loginBtn").onclick = async () => {
        const email = $("loginEmail").value.trim();
        const password = $("loginPass").value;

        if (!email || !password) return toast("Informe email e senha.", "warn", "need-login");

        overlaySafe(true, "login");
        try {
          const { data, error } = await withTimeout(
            supabase.auth.signInWithPassword({ email, password }),
            9000,
            "login"
          );
          if (error) throw error;

          currentUser = data?.user || (await getSession())?.user || null;
          toast("Logado ‚úÖ", "success", "logged");
          await bootFromProfile();
          pingLastSeen();

        } catch (e) {
          console.error(e);
          toast("Falha no login: " + (e?.message || e), "error", "login-fail");
        } finally {
          overlaySafe(false, "login");
        }
      };

      $("registerBtn").onclick = async () => {
        const displayName = $("regName").value.trim();
        const email = $("regEmail").value.trim();
        const password = $("regPass").value;
        const gen = $("genInv").checked;
        const code = ($("invCode").value || "").trim().toUpperCase();

        if (!displayName) return toast("Informe seu nome.", "warn", "reg-name");
        if (!email) return toast("Informe seu email.", "warn", "reg-email");
        if (!password || password.length < 6) return toast("Senha com pelo menos 6 caracteres.", "warn", "reg-pass");
        if (!gen && !code) return toast("Informe o c√≥digo do invent√°rio.", "warn", "reg-code");

        setPending({
          displayName,
          mode: gen ? "create" : "join",
          code: gen ? "" : code,
          createdAt: Date.now(),
        });

        overlaySafe(true, "register");
        try {
          const { data, error } = await withTimeout(
            supabase.auth.signUp({
              email,
              password,
              options: { emailRedirectTo: APP_URL },
            }),
            9000,
            "signUp"
          );
          if (error) {
            clearPending();
            throw error;
          }

          // confirm email ON: n√£o vem session
          if (!data?.session?.user) {
            toast("Conta criada ‚úÖ Confirme o email e depois fa√ßa login.", "warn", "confirm-email");
            showLogin();
            return;
          }

          currentUser = data.session.user;
          toast("Conta criada ‚úÖ", "success", "signup-ok");

          await finalizePendingIfAny();
          pingLastSeen();

        } catch (e) {
          console.error(e);
          clearPending();
          toast("Falha no cadastro: " + (e?.message || e), "error", "signup-fail");
        } finally {
          overlaySafe(false, "register");
        }
      };

      $("logoutBtn").onclick = async () => {
        overlaySafe(true, "logout");
        try {
          await stopRealtime();
          await supabase.auth.signOut();
          currentUser = null;
          currentInventoryId = null;
          items = [];
          members = [];
          resetEdit();
          showLogin();
          toast("Saiu.", "warn", "logout");
        } finally {
          overlaySafe(false, "logout");
        }
      };

      $("invCodeShow").onclick = async () => {
        const t = $("invCodeShow").textContent || "";
        if (!t || t === "(sem c√≥digo)") return;
        try {
          await navigator.clipboard.writeText(t);
          toast("C√≥digo copiado ‚úÖ", "success", "copy-code");
        } catch {
          toast("N√£o consegui copiar.", "error", "copy-fail");
        }
      };

      $("add").onclick = () => upsertItem();
      $("cancelEdit").onclick = () => resetEdit();
      $("search").addEventListener("input", renderItems);
      $("name").addEventListener("keydown", (e) => { if (e.key === "Enter") upsertItem(); });

      $("filterList").onclick = () => {
        showOnlyNeeds = !showOnlyNeeds;
        $("filterList").classList.toggle("active", showOnlyNeeds);
        $("filterList").textContent = showOnlyNeeds ? "Mostrar tudo" : "Filtrar lista";
        renderItems();
      };

      $("filterEssentials").onclick = () => {
        if (essentialFilter === "both") essentialFilter = "essential";
        else if (essentialFilter === "essential") essentialFilter = "not";
        else essentialFilter = "both";

        $("filterEssentials").textContent =
          essentialFilter === "both" ? "Essenciais: ambos" :
          essentialFilter === "essential" ? "Essenciais: s√≥ essenciais" :
          "Essenciais: s√≥ n√£o essenciais";

        renderItems();
      };

      $("exportText").onclick = exportText;
      $("import").onclick = importJson;
      $("clear").onclick = clearAll;

      // ========= AUTH STATE (SEM ‚ÄúTROCA ABA = LOADING‚Äù) =========
      let booting = false;

      supabase.auth.onAuthStateChange(async (_event, session) => {
        if (booting) return;

        if (!session?.user) {
          await stopRealtime();
          currentUser = null;
          currentInventoryId = null;
          items = [];
          members = [];
          resetEdit();
          showLogin();
          return;
        }

        booting = true;
        try {
          currentUser = session.user;
          await bootFromProfile();
          pingLastSeen();
        } catch (e) {
          console.error(e);
          toast("Falha ao iniciar: " + (e?.message || e), "error", "boot-fail");
        } finally {
          booting = false;
        }
      });

      // ========= FIRST PAINT =========
      (async () => {
        try {
          const session = await getSession();
          if (!session?.user) return showLogin();

          currentUser = session.user;
          await bootFromProfile();
          pingLastSeen();
        } catch (e) {
          console.error(e);
          showLogin();
        }
      })();

      // Offline/Online (sem ‚Äúcair da conta‚Äù)
      window.addEventListener("offline", () => toast("Sem internet. Pode atrasar o tempo real.", "warn", "offline"));
      window.addEventListener("online", () => toast("Conex√£o voltou ‚úÖ", "success", "online"));
    });
  </script>
</body>
</html>