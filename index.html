<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invent√°rio</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Invent√°rio da Casa</div>
      <div id="topBadge" class="badge">desconectado</div>
    </div>

    <!-- AUTH -->
    <div id="authCard" class="card">
      <div class="grid">
        <div>
          <h2 style="margin:0 0 10px 0">Entrar</h2>
          <div class="row">
            <div class="field">
              <label>Email</label>
              <input id="loginEmail" class="input" type="email" placeholder="seu@email.com" />
            </div>
            <div class="field">
              <label>Senha</label>
              <input id="loginPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnLogin" class="btn">Entrar</button>
          </div>
          <div class="small" style="margin-top:8px">
            Dica: no GitHub Pages use sempre HTTPS e confira se o URL do site est√° em ‚ÄúAuth ‚Üí URL Configuration‚Äù.
          </div>
        </div>

        <div>
          <h2 style="margin:0 0 10px 0">Registrar</h2>
          <div class="row">
            <div class="field">
              <label>Nome</label>
              <input id="regName" class="input" type="text" placeholder="Dihego" />
            </div>
            <div class="field">
              <label>Email</label>
              <input id="regEmail" class="input" type="email" placeholder="seu@email.com" />
            </div>
            <div class="field">
              <label>Senha</label>
              <input id="regPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>

          <div class="row" style="align-items:center; margin-top:10px">
            <label style="margin:0; display:flex; gap:10px; align-items:center">
              <input id="regCreateInv" type="checkbox" checked />
              <span>Gerar invent√°rio</span>
            </label>
            <div class="field" style="flex:1 1 240px; min-width:220px">
              <input id="regInvite" class="input" type="text" placeholder="C√≥digo do invent√°rio (6 letras/n√∫meros)" maxlength="6" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnRegister" class="btn">Criar conta</button>
          </div>

          <div class="small" style="margin-top:8px">
            Se ‚ÄúGerar invent√°rio‚Äù estiver marcado, o c√≥digo acima √© ignorado.
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none">
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between">
          <div>
            <div style="font-weight:900" id="hello">Ol√°</div>
            <div class="small" id="invInfo">Invent√°rio: -</div>
          </div>
          <div class="row">
            <button id="btnLogout" class="btn btn-ghost">Sair</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- MEMBERS (visualiza√ß√£o simples) -->
        <div class="card">
          <h3 style="margin:0 0 10px 0">Membros</h3>
          <div class="small" style="margin-bottom:10px">
            (Somente visualiza√ß√£o por enquanto)
          </div>
          <div id="membersList" class="list"></div>
        </div>

        <!-- ADD/EDIT -->
        <div class="card">
          <h3 style="margin:0 0 10px 0" id="formTitle">Adicionar item</h3>
          <div class="row">
            <div class="field" style="flex:1 1 260px">
              <label>Nome</label>
              <input id="itemName" class="input" type="text" placeholder="Arroz" />
            </div>
            <div class="field">
              <label>Qtd</label>
              <input id="itemQty" class="input" type="number" step="0.01" placeholder="1" />
            </div>
            <div class="field">
              <label>Unidade</label>
              <input id="itemUnit" class="input" type="text" placeholder="kg / un / pct" value="un" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label>Qtd m√≠nima</label>
              <input id="itemMin" class="input" type="number" step="0.01" placeholder="0" />
            </div>
            <div class="field" style="display:flex; align-items:flex-end">
              <label style="margin:0; display:flex; gap:10px; align-items:center">
                <input id="itemEssential" type="checkbox" checked />
                <span>Essencial</span>
              </label>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnSaveItem" class="btn">Salvar</button>
            <button id="btnCancelEdit" class="btn btn-ghost" style="display:none">Cancelar</button>
          </div>

          <div class="hr"></div>

          <div class="row" style="align-items:center; justify-content:space-between">
            <div>
              <div style="font-weight:900">Lista de compras</div>
              <div class="small">Mostra itens abaixo do m√≠nimo.</div>
            </div>
            <div class="row">
              <select id="filterEssential" class="input" style="width:auto">
                <option value="all">Essenciais + N√£o essenciais</option>
                <option value="essential">S√≥ essenciais</option>
                <option value="non">S√≥ n√£o essenciais</option>
              </select>
              <button id="btnCopyList" class="btn btn-ghost">Copiar</button>
            </div>
          </div>
          <div class="small" id="buyList" style="margin-top:10px; white-space:pre-wrap"></div>
        </div>
      </div>

      <!-- ITEMS -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between">
          <h3 style="margin:0">Itens</h3>
          <div class="pill" id="itemsCount">0</div>
        </div>
        <div class="small" style="margin-top:6px">
          Realtime ligado: qualquer altera√ß√£o aparece pros dois (voc√™ e sua esposa) sem recarregar.
        </div>

        <div style="margin-top:12px" id="itemsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- MODAL INFO -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="row" style="align-items:center; justify-content:space-between">
        <h3 id="modalTitle">Info</h3>
        <button id="btnCloseModal" class="btn btn-ghost">Fechar</button>
      </div>
      <div id="modalBody" class="small" style="white-space:pre-wrap"></div>
    </div>
  </div>

  <div id="toast" class="toast">ok</div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // =========================
    // CONFIG (preencha com o seu)
    // =========================
    const SUPABASE_URL = "COLE_AQUI_SUA_URL";
    const SUPABASE_ANON_KEY = "COLE_AQUI_SUA_ANON_KEY";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: "invapp_session_v1"
      }
    });

    // =========================
    // UI helpers
    // =========================
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 2200);
    }

    function fmtDate(d){
      if(!d) return "-";
      try{
        const dt = new Date(d);
        return dt.toLocaleString("pt-BR");
      }catch(e){ return String(d); }
    }

    function daysBetween(a, b){
      if(!a || !b) return null;
      const da = new Date(a).getTime();
      const db = new Date(b).getTime();
      if(!isFinite(da) || !isFinite(db)) return null;
      const diff = Math.abs(db - da);
      return Math.round(diff / (1000*60*60*24));
    }

    // =========================
    // App state
    // =========================
    let session = null;
    let profile = null;
    let inventoryId = null;

    let items = [];
    let members = [];
    let editItemId = null;

    let itemsChannel = null;
    let membersChannel = null;

    function setTopBadge(text){
      $("topBadge").textContent = text;
    }

    function showAuth(){
      $("authCard").style.display = "block";
      $("app").style.display = "none";
    }

    function showApp(){
      $("authCard").style.display = "none";
      $("app").style.display = "block";
    }

    // =========================
    // Core: boot + session
    // =========================
    async function boot(){
      // nunca deixa ‚Äúloading infinito‚Äù: a UI sempre mostra auth ou app
      const { data } = await supabase.auth.getSession();
      session = data.session || null;

      if(!session){
        setTopBadge("desconectado");
        showAuth();
        return;
      }

      setTopBadge("conectado");
      await afterLogin();
    }

    supabase.auth.onAuthStateChange(async (event, newSession) => {
      session = newSession || null;

      if(!session){
        cleanupRealtime();
        setTopBadge("desconectado");
        showAuth();
        return;
      }

      setTopBadge("conectado");
      await afterLogin();
    });

    // Evita bug de ‚Äútrocar aba e morrer‚Äù
    document.addEventListener("visibilitychange", async () => {
      if(document.visibilityState === "visible"){
        // ao voltar pra aba: revalida sess√£o e re-sincroniza (sem loading)
        const { data } = await supabase.auth.getSession();
        if(!data.session){
          cleanupRealtime();
          setTopBadge("desconectado");
          showAuth();
          toast("Sess√£o expirou. Entre novamente.");
          return;
        }
        session = data.session;
        setTopBadge("conectado");
        // re-sync leve (se j√° estava logado)
        if($("app").style.display === "block"){
          await syncAll(true);
        }
      }
    });

    function cleanupRealtime(){
      try{
        if(itemsChannel) supabase.removeChannel(itemsChannel);
        if(membersChannel) supabase.removeChannel(membersChannel);
      }catch(e){}
      itemsChannel = null;
      membersChannel = null;
      items = [];
      members = [];
      inventoryId = null;
      profile = null;
      editItemId = null;
    }

    // =========================
    // Login/Register
    // =========================
    $("btnLogin").addEventListener("click", async () => {
      const email = $("loginEmail").value.trim();
      const password = $("loginPass").value.trim();
      if(!email || !password) return toast("Preencha email e senha.");

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) return toast("Erro: " + error.message);

      toast("Logado!");
    });

    $("btnRegister").addEventListener("click", async () => {
      const displayName = $("regName").value.trim();
      const email = $("regEmail").value.trim();
      const password = $("regPass").value.trim();
      const createInv = $("regCreateInv").checked;
      const invite = $("regInvite").value.trim();

      if(!displayName || !email || !password) return toast("Preencha nome, email e senha.");

      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error) return toast("Erro: " + error.message);

      // muitos projetos exigem email confirmation; se tiver, session pode vir null
      // ent√£o tentamos login autom√°tico:
      let s = data.session;
      if(!s){
        const { data: loginData, error: loginErr } = await supabase.auth.signInWithPassword({ email, password });
        if(loginErr) return toast("Conta criada. Agora entre manualmente.");
        s = loginData.session;
      }
      session = s;

      // Finaliza invent√°rio via RPC (assinaturas SEM conflito)
      if(createInv){
        const { error: rpcErr } = await supabase.rpc("create_inventory_and_set_profile", { p_display_name: displayName });
        if(rpcErr) return toast("Falhou ao finalizar invent√°rio: " + rpcErr.message);
      }else{
        if(invite.length !== 6) return toast("C√≥digo do invent√°rio deve ter 6 caracteres.");
        const { error: rpcErr } = await supabase.rpc("join_inventory_and_set_profile", { p_display_name: displayName, p_invite_code: invite });
        if(rpcErr) return toast("Falhou ao vincular: " + rpcErr.message);
      }

      toast("Conta pronta!");
      await afterLogin();
    });

    $("btnLogout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      toast("Saiu.");
    });

    // =========================
    // After login: load profile + inventory + realtime
    // =========================
    async function afterLogin(){
      showApp();

      // carrega profile
      const uid = session.user.id;
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("user_id, display_name, current_inventory_id, last_seen_at")
        .eq("user_id", uid)
        .maybeSingle();

      if(profErr) {
        // Se profile n√£o existe (caso raro): for√ßa usu√°rio registrar de novo pelo fluxo correto
        toast("Profile n√£o encontrado. Fa√ßa logout e registre novamente.");
        console.error(profErr);
        return;
      }

      profile = prof;
      inventoryId = profile?.current_inventory_id || null;

      $("hello").textContent = "Ol√°, " + (profile.display_name || "usu√°rio");
      $("invInfo").textContent = inventoryId ? ("Invent√°rio: " + inventoryId) : "Invent√°rio: -";

      if(!inventoryId){
        toast("Sem invent√°rio vinculado. Fa√ßa logout e registre novamente.");
        return;
      }

      // marca "last seen" (sem spam)
      await supabase.from("profiles").update({ last_seen_at: new Date().toISOString() }).eq("user_id", uid);

      await syncAll(false);
      setupRealtime();
    }

    async function syncAll(soft){
      // soft = n√£o mexe em UI, s√≥ sincroniza em sil√™ncio
      await Promise.all([loadItems(), loadMembers()]);
      renderAll();
      if(!soft) toast("Sincronizado.");
    }

    // =========================
    // Realtime (itens + membros)
    // =========================
    function setupRealtime(){
      cleanupRealtimeChannelsOnly();

      // Itens: qualquer INSERT/UPDATE/DELETE no inventory_id => refetch (simples e confi√°vel)
      itemsChannel = supabase.channel("rt-items-" + inventoryId)
        .on("postgres_changes", {
          event: "*",
          schema: "public",
          table: "inventory_items",
          filter: "inventory_id=eq." + inventoryId
        }, async () => {
          await loadItems();
          renderItems();
          renderBuyList();
        })
        .subscribe();

      // Membros: refresh
      membersChannel = supabase.channel("rt-members-" + inventoryId)
        .on("postgres_changes", {
          event: "*",
          schema: "public",
          table: "inventory_members",
          filter: "inventory_id=eq." + inventoryId
        }, async () => {
          await loadMembers();
          renderMembers();
        })
        .subscribe();
    }

    function cleanupRealtimeChannelsOnly(){
      try{ if(itemsChannel) supabase.removeChannel(itemsChannel); }catch(e){}
      try{ if(membersChannel) supabase.removeChannel(membersChannel); }catch(e){}
      itemsChannel = null;
      membersChannel = null;
    }

    // =========================
    // Data fetch
    // =========================
    async function loadItems(){
      const { data, error } = await supabase
        .from("inventory_items")
        .select("*")
        .eq("inventory_id", inventoryId)
        .order("updated_at", { ascending: false });

      if(error){
        console.error(error);
        toast("Erro ao carregar itens: " + error.message);
        return;
      }
      items = data || [];
    }

    async function loadMembers(){
      const { data, error } = await supabase
        .from("inventory_members")
        .select("user_id, role, display_name, last_seen_at, created_at")
        .eq("inventory_id", inventoryId)
        .order("role", { ascending: true });

      if(error){
        console.error(error);
        toast("Erro ao carregar membros: " + error.message);
        return;
      }
      members = data || [];
    }

    // =========================
    // Render
    // =========================
    function renderAll(){
      renderItems();
      renderMembers();
      renderBuyList();
    }

    function renderMembers(){
      const box = $("membersList");
      box.innerHTML = "";
      if(!members.length){
        box.innerHTML = `<div class="small">Nenhum membro encontrado.</div>`;
        return;
      }
      for(const m of members){
        const isOwner = m.role === "owner";
        const last = m.last_seen_at ? fmtDate(m.last_seen_at) : "nunca";
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="item-left">
            <div class="item-name">${escapeHtml(m.display_name)} ${isOwner ? "‚≠ê" : ""}</div>
            <div class="item-meta">Cargo: ${isOwner ? "dono" : "membro"} ‚Ä¢ Visto: ${escapeHtml(last)}</div>
          </div>
        `;
        box.appendChild(el);
      }
    }

    function renderItems(){
      $("itemsCount").textContent = String(items.length);
      const box = $("itemsList");
      box.innerHTML = "";
      if(!items.length){
        box.innerHTML = `<div class="small">Sem itens ainda.</div>`;
        return;
      }

      for(const it of items){
        const belowMin = Number(it.qty) < Number(it.min_qty);
        const meta = `${it.qty} ${escapeHtml(it.unit)} ‚Ä¢ m√≠n ${it.min_qty} ‚Ä¢ ${it.essential ? "essencial" : "n√£o essencial"}${belowMin ? " ‚Ä¢ ‚ö† abaixo do m√≠nimo" : ""}`;

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="item-left">
            <div class="item-name">${escapeHtml(it.name)}</div>
            <div class="item-meta">${escapeHtml(meta)}</div>
          </div>
          <div class="item-actions">
            <button class="icon-btn" title="Diminuir" data-act="minus" data-id="${it.id}">‚àí</button>
            <button class="icon-btn" title="Editar" data-act="edit" data-id="${it.id}">‚öôÔ∏è</button>
            <button class="icon-btn" title="Info" data-act="info" data-id="${it.id}">‚ÑπÔ∏è</button>
          </div>
        `;
        box.appendChild(el);
      }
    }

    function renderBuyList(){
      const mode = $("filterEssential").value;
      const need = items.filter(it => Number(it.qty) < Number(it.min_qty))
        .filter(it => mode === "all" ? true : (mode === "essential" ? !!it.essential : !it.essential))
        .map(it => `- ${it.name} (${it.min_qty - it.qty} ${it.unit})`);

      $("buyList").textContent = need.length ? need.join("\n") : "Nada pra comprar üéâ";
    }

    $("filterEssential").addEventListener("change", renderBuyList);

    $("btnCopyList").addEventListener("click", async () => {
      const text = $("buyList").textContent || "";
      try{
        await navigator.clipboard.writeText(text);
        toast("Lista copiada!");
      }catch(e){
        toast("N√£o deu pra copiar (permiss√£o do navegador).");
      }
    });

    // =========================
    // Add/Edit item
    // =========================
    $("btnSaveItem").addEventListener("click", async () => {
      const name = $("itemName").value.trim();
      const qty = Number($("itemQty").value || 0);
      const unit = ($("itemUnit").value.trim() || "un");
      const minQty = Number($("itemMin").value || 0);
      const essential = $("itemEssential").checked;

      if(!name) return toast("Digite o nome do item.");

      const nameNorm = normalizeName(name);

      const payload = {
        inventory_id: inventoryId,
        name,
        name_norm: nameNorm,
        unit,
        qty,
        min_qty: minQty,
        essential,
        updated_by: session.user.id
      };

      if(editItemId){
        // update
        const { error } = await supabase
          .from("inventory_items")
          .update(payload)
          .eq("id", editItemId);

        if(error) return toast("Erro: " + error.message);

        toast("Item atualizado!");
        clearEdit();
      }else{
        // insert
        payload.created_by = session.user.id;

        const { error } = await supabase
          .from("inventory_items")
          .insert(payload);

        if(error) return toast("Erro: " + error.message);

        toast("Item adicionado!");
        clearForm();
      }

      // realtime vai atualizar todo mundo automaticamente
    });

    $("btnCancelEdit").addEventListener("click", () => {
      clearEdit();
      clearForm();
    });

    function startEdit(itemId){
      const it = items.find(x => x.id === itemId);
      if(!it) return;

      editItemId = itemId;
      $("formTitle").textContent = "Editar item";
      $("btnCancelEdit").style.display = "inline-block";

      $("itemName").value = it.name || "";
      $("itemQty").value = it.qty ?? 0;
      $("itemUnit").value = it.unit || "un";
      $("itemMin").value = it.min_qty ?? 0;
      $("itemEssential").checked = !!it.essential;

      toast("Editando: " + it.name);
    }

    function clearEdit(){
      editItemId = null;
      $("formTitle").textContent = "Adicionar item";
      $("btnCancelEdit").style.display = "none";
    }

    function clearForm(){
      $("itemName").value = "";
      $("itemQty").value = "";
      $("itemMin").value = "";
      $("itemUnit").value = "un";
      $("itemEssential").checked = true;
    }

    // Minus / Edit / Info handlers (delegation)
    $("itemsList").addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button");
      if(!btn) return;
      const act = btn.getAttribute("data-act");
      const id = btn.getAttribute("data-id");
      if(!act || !id) return;

      const it = items.find(x => x.id === id);
      if(!it) return;

      if(act === "edit"){
        startEdit(id);
        return;
      }

      if(act === "minus"){
        const next = Math.max(0, Number(it.qty) - 1);
        const { error } = await supabase
          .from("inventory_items")
          .update({ qty: next, updated_by: session.user.id })
          .eq("id", id);

        if(error) return toast("Erro: " + error.message);
        // realtime faz o resto
        return;
      }

      if(act === "info"){
        openInfo(it);
        return;
      }
    });

    // =========================
    // Modal Info: comprado/zerado + dias
    // =========================
    const modal = $("modalBackdrop");
    $("btnCloseModal").addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

    function openInfo(it){
      $("modalTitle").textContent = "Info ‚Ä¢ " + it.name;

      const lastBuy = it.last_buy_at ? fmtDate(it.last_buy_at) : "-";
      const lastBuyQty = (it.last_buy_qty ?? "-");
      const prevBuy = it.prev_buy_at ? fmtDate(it.prev_buy_at) : "-";
      const prevBuyQty = (it.prev_buy_qty ?? "-");
      const lastZero = it.last_zero_at ? fmtDate(it.last_zero_at) : "-";

      // c√°lculo: quando tiver comprado e zerado, d√° pra estimar quanto durou
      let dur = null;
      if(it.last_buy_at && it.last_zero_at){
        // ‚Äúdurou‚Äù do comprado at√© zerar (se zerou depois de comprar)
        const d = daysBetween(it.last_buy_at, it.last_zero_at);
        if(d !== null) dur = d + " dia(s)";
      }

      $("modalBody").textContent =
`√öltima compra: ${lastBuy} (comprou +${lastBuyQty})
Compra anterior: ${prevBuy} (comprou +${prevBuyQty})
√öltima vez zerado: ${lastZero}

Dura√ß√£o estimada (compra ‚Üí zerou): ${dur ?? "-"}

Obs:
- O sistema marca ‚Äúcompra‚Äù automaticamente quando a quantidade aumenta.
- Marca ‚Äúzerou‚Äù quando a quantidade cai para 0.`;

      modal.classList.add("show");
    }

    function closeModal(){
      modal.classList.remove("show");
    }

    // =========================
    // Utils
    // =========================
    function normalizeName(s){
      return (s || "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9\s]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // =========================
    // Start
    // =========================
    boot();
  </script>
</body>
</html>