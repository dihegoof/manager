<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio da Casa</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <!-- TOASTS -->
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- AUTH -->
  <div id="authView" class="center-screen">
    <div class="card login-card">
      <h1 class="title" id="authTitle">Entrar</h1>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="row">
          <input id="loginEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>

        <div class="row mt12 actions">
          <button id="loginBtn">Logar</button>
          <button id="openRegisterBtn" class="small" type="button">Registrar</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" class="hidden">
        <div class="row">
          <input id="regName" placeholder="Seu nome" autocomplete="name" />
        </div>
        <div class="row mt10">
          <input id="regEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="regPass" type="password" placeholder="Senha" autocomplete="new-password" />
        </div>

        <div class="row mt10" style="align-items:center;">
          <label class="checkline">
            <input id="genInv" type="checkbox" checked />
            Gerar invent√°rio
          </label>
        </div>

        <div class="row mt10">
          <input id="invCode" placeholder="C√≥digo do invent√°rio (6 letras/n√∫meros)" autocomplete="off" disabled />
        </div>

        <div class="row mt12 actions">
          <button id="registerBtn">Criar conta</button>
          <button id="backToLoginBtn" class="small" type="button">Voltar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="wrap hidden">
    <div class="card">
      <div class="row header-row">
        <h1 class="title">Invent√°rio da Casa</h1>
        <button id="logoutBtn" class="small">Sair</button>
      </div>

      <div class="muted" style="margin-top:6px;">
        C√≥digo do invent√°rio:
        <span id="invCodeShow" class="pill copy" title="Toque para copiar"></span>
      </div>

      <div class="divider"></div>

      <div class="row">
        <input id="search" placeholder="Buscar item" />
      </div>

      <div class="divider"></div>

      <div class="row">
        <input id="name" placeholder="Novo item:" />
        <select id="unit">
          <option value="un">un</option>
          <option value="g">g</option>
          <option value="kg">kg</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
        <input id="qty" type="number" step="0.1" placeholder="Qtd" class="w120" />
        <input id="min" type="number" step="0.1" placeholder="M√≠n" class="w120" />
        <button id="add">Adicionar</button>
      </div>

      <div class="muted">
        Dica: O ‚ÄúM√≠n‚Äù (m√≠nimo) emite um alerta ao chegar na quantidade definida.
      </div>

      <div class="divider"></div>

      <div class="row actions">
        <button class="small" id="filterList">Filtrar lista</button>
        <button class="small" id="export">Exportar (backup)</button>
        <button class="small" id="import">Importar</button>
        <button class="small" id="clear">Zerar tudo</button>
      </div>

      <div class="list" id="list"></div>

      <!-- MEMBERS -->
      <div class="divider"></div>

      <div class="members-card">
        <div class="row members-header">
          <div>
            <div class="members-title">Membros do invent√°rio</div>
            <div class="members-sub">Quem tem acesso a este invent√°rio</div>
          </div>

          <div class="row" style="gap:8px;">
            <button id="membersRefresh" class="small" type="button">Atualizar</button>
          </div>
        </div>

        <div id="membersList" class="members-list">
          <div class="members-empty">Carregando‚Ä¶</div>
        </div>

        <div class="members-hint">
          ‚≠ê = dono/organizador. O dono pode remover membros.
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER (todas as telas) -->
  <footer class="footer" id="footer"></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xzcgwnifypiqqushxrcs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9Nx27f1V0IgMkMw6BdTwmQ_B96lf3wq";
    const APP_URL = "https://dihegoof.github.io/manager/";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    const round = (v) => Math.round((Number(v) + Number.EPSILON) * 10) / 10;

    /* ===== Toast ===== */
    function toast(message, type = "success") {
      const c = $("toastContainer");
      if (!c) return;

      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.innerHTML = `<div class="toast-bubble">${escapeHtml(message)}</div>`;
      c.appendChild(t);

      // sobe e some
      requestAnimationFrame(() => t.classList.add("show"));
      setTimeout(() => t.classList.add("hide"), 3000);
      setTimeout(() => t.remove(), 3600);
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function humanizeAuthError(err) {
      const raw = (err?.message || err || "").toString();
      const m = raw.toLowerCase();

      if (m.includes("invalid login") || m.includes("invalid credentials")) return { text: "Email ou senha inv√°lidos.", type: "error" };
      if (m.includes("email not confirmed")) return { text: "Confirme seu email antes de entrar.", type: "warn" };
      if (m.includes("rate limit")) return { text: "Muitas tentativas. Aguarde um pouco e tente novamente.", type: "warn" };
      if (m.includes("already registered") || m.includes("already exists") || m.includes("user already registered")) return { text: "Esse email j√° possui conta. Fa√ßa login.", type: "warn" };
      if (m.includes("invalid email")) return { text: "Email inv√°lido.", type: "warn" };
      if (m.includes("password") && (m.includes("least") || m.includes("characters"))) return { text: "Senha precisa ter pelo menos 6 caracteres.", type: "warn" };

      return { text: raw || "Ocorreu um erro.", type: "error" };
    }

    function overlay(on) { $("overlay").classList.toggle("on", !!on); }

    function showLogin() {
      $("authTitle").textContent = "Entrar";
      $("loginForm").classList.remove("hidden");
      $("registerForm").classList.add("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
      $("authView").classList.add("fade-in");
    }

    function showRegister() {
      $("authTitle").textContent = "Registrar";
      $("loginForm").classList.add("hidden");
      $("registerForm").classList.remove("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
      syncRegisterUI();
      $("authView").classList.add("fade-in");
    }

    function showApp() {
      $("authView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      $("appView").classList.add("fade-in");
    }

    function syncRegisterUI() {
      const gen = $("genInv").checked;
      $("invCode").disabled = gen;
      if (gen) $("invCode").value = "";
    }

    async function getSessionUser() {
      const { data: { session } } = await supabase.auth.getSession();
      return session?.user || null;
    }

    /* =========================================================
       INVENTORY + APP
    ========================================================= */

    async function loadInventory(inventoryId) {
      const { data, error } = await supabase
        .from("inventories")
        .select("items, invite_code")
        .eq("id", inventoryId)
        .single();
      if (error) throw error;
      return data;
    }

    async function saveInventoryItems(inventoryId, arr) {
      const { error } = await supabase
        .from("inventories")
        .update({ items: arr, updated_at: new Date().toISOString() })
        .eq("id", inventoryId);
      if (error) throw error;
    }

    const KEY_PREFIX = "home_inventory_inv_";
    const loadLocal = (invId) => { try { return JSON.parse(localStorage.getItem(KEY_PREFIX + invId)) || []; } catch { return []; } };
    const saveLocal = (invId, arr) => localStorage.setItem(KEY_PREFIX + invId, JSON.stringify(arr));

    let items = [];
    let saveTimer = null;
    let currentInventoryId = null;
    let realtimeChannel = null;
    let showOnlyNeeds = false;

    // MEMBERS STATE
    let members = [];
    let canManageMembers = false;
    let meUserId = null;

    function needsBuy(it) {
      const qty = Number(it.qty ?? 0);
      const min = Number(it.min_qty ?? 0);
      return qty <= 0 || (min > 0 && qty <= min);
    }

    function render() {
      const q = norm($("search").value);
      const list = $("list");
      list.innerHTML = "";

      const filtered = items
        .filter(it => {
          const matchesSearch = !q || (it.name_norm || "").includes(q);
          const matchesNeeds = !showOnlyNeeds || needsBuy(it);
          return matchesSearch && matchesNeeds;
        })
        .sort((a, b) => (a.name || "").localeCompare((b.name || ""), "pt-BR"));

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = showOnlyNeeds ? "Nenhum item precisa comprar üôÇ" : "Nada por aqui üôÇ";
        list.appendChild(empty);
        return;
      }

      for (const it of filtered) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        const needs = needsBuy(it);

        left.innerHTML = `
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="sub">
            ${it.qty} ${escapeHtml(it.unit)} ‚Ä¢ m√≠nimo: ${it.min_qty || 0}
            ${needs ? ' ‚Ä¢ <span class="pill danger">precisa comprar</span>' : ""}
          </div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        const minus = document.createElement("button");
        minus.textContent = "‚àí";
        minus.onclick = () => updateQty(it.id, it.unit === "un" ? -1 : -0.1);

        const qty = document.createElement("div");
        qty.className = "qty pill";
        qty.textContent = `${it.qty} ${it.unit}`;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.onclick = () => updateQty(it.id, it.unit === "un" ? +1 : +0.1);

        const del = document.createElement("button");
        del.textContent = "üóëÔ∏è";
        del.title = "Remover";
        del.onclick = () => removeItem(it.id);

        controls.append(minus, qty, plus, del);
        row.append(left, controls);
        list.appendChild(row);
      }
    }

    async function saveNow(arr) {
      if (!currentInventoryId) return;
      saveLocal(currentInventoryId, arr);
      try {
        await saveInventoryItems(currentInventoryId, arr);
        toast("Salvo ‚úÖ", "success");
      } catch (e) {
        console.error(e);
        toast("N√£o salvou no cloud.", "error");
      }
    }

    function saveDebounced(arr) {
      if (!currentInventoryId) return;
      saveLocal(currentInventoryId, arr);
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveNow(arr), 250);
    }

    async function addItem() {
      const name = $("name").value.trim();
      const unit = $("unit").value;
      const qty = Number($("qty").value || 0);
      const minQty = Number($("min").value || 0);
      if (!name) return;

      const n = norm(name);
      const existing = items.find(x => x.name_norm === n && x.unit === unit);

      if (existing) {
        existing.qty = round(existing.qty + qty);
        existing.min_qty = (minQty || minQty === 0) ? minQty : (existing.min_qty || 0);
      } else {
        items.push({ id: crypto.randomUUID(), name, name_norm: n, unit, qty: round(qty || 0), min_qty: round(minQty || 0) });
      }

      $("name").value = ""; $("qty").value = ""; $("min").value = "";
      render();
      await saveNow(items);
    }

    function updateQty(id, delta) {
      const it = items.find(x => x.id === id);
      if (!it) return;
      it.qty = round(Math.max(0, Number(it.qty) + Number(delta)));
      render();
      saveDebounced(items);
    }

    async function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      await saveNow(items);
    }

    async function startRealtime(inventoryId) {
      if (realtimeChannel) await supabase.removeChannel(realtimeChannel);
      realtimeChannel = supabase
        .channel("inv-" + inventoryId)
        .on("postgres_changes", {
          event: "*",
          schema: "public",
          table: "inventories",
          filter: `id=eq.${inventoryId}`,
        }, (payload) => {
          const newItems = payload?.new?.items;
          if (Array.isArray(newItems)) {
            items = newItems;
            saveLocal(inventoryId, items);
            render();
            toast("Atualizado ‚ö°", "success");
          }
        })
        .subscribe();
    }

    async function stopRealtime() {
      if (realtimeChannel) await supabase.removeChannel(realtimeChannel);
      realtimeChannel = null;
    }

    /* =========================================================
       MEMBERS (REAL)
    ========================================================= */

    function renderMembers(list = []) {
      const box = $("membersList");
      if (!box) return;
      box.innerHTML = "";

      if (!Array.isArray(list) || !list.length) {
        const empty = document.createElement("div");
        empty.className = "members-empty";
        empty.textContent = "Nenhum membro encontrado.";
        box.appendChild(empty);
        return;
      }

      for (const m of list) {
        const row = document.createElement("div");
        row.className = "member";

        const left = document.createElement("div");
        left.className = "member-left";

        const name = document.createElement("div");
        name.className = "member-name";
        name.textContent = m.display_name || "Membro";

        const meta = document.createElement("div");
        meta.className = "member-meta";
        meta.textContent = m.email || "";

        left.appendChild(name);
        if (m.email) left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "member-right";

        const badge = document.createElement("span");
        badge.className = "member-badge " + (m.role === "owner" ? "owner" : "");
        badge.textContent = m.role === "owner" ? "‚≠ê dono" : "membro";
        right.appendChild(badge);

        const btn = document.createElement("button");
        btn.className = "small ghost";
        btn.type = "button";
        btn.textContent = "Remover";

        const isMe = (m.user_id === meUserId);
        const isOwnerTarget = (m.role === "owner");

        // regras:
        // - s√≥ owner remove
        // - n√£o remove a si mesmo
        // - (simples) n√£o remove owners (depois a gente melhora com m√∫ltiplos owners)
        const canRemove = canManageMembers && !isMe && !isOwnerTarget;

        btn.disabled = !canRemove;
        btn.title = canRemove ? "Remover do invent√°rio" : "Apenas o dono remove (e n√£o remove donos).";
        btn.onclick = async () => {
          if (!canRemove) return;
          if (!confirm(`Remover "${m.display_name || m.email || "membro"}" do invent√°rio?`)) return;
          await removeMember(m.user_id);
        };

        right.appendChild(btn);

        row.append(left, right);
        box.appendChild(row);
      }
    }

    async function loadMembers() {
      if (!currentInventoryId) return;

      const user = await getSessionUser();
      meUserId = user?.id || null;

      const { data, error } = await supabase.rpc("list_inventory_members", {
        p_inventory_id: currentInventoryId
      });

      if (error) {
        console.error(error);
        toast("Erro ao carregar membros.", "error");
        return;
      }

      members = Array.isArray(data) ? data : [];
      canManageMembers = members.some(m => m.user_id === meUserId && m.role === "owner");

      renderMembers(members);
    }

    async function removeMember(userId) {
      if (!currentInventoryId) return;

      const { error } = await supabase.rpc("remove_inventory_member", {
        p_inventory_id: currentInventoryId,
        p_user_id: userId
      });

      if (error) {
        console.error(error);
        toast("N√£o consegui remover: " + error.message, "error");
        return;
      }

      toast("Membro removido ‚úÖ", "success");
      await loadMembers();
    }

    /* =========================================================
       BOOT
    ========================================================= */

    async function bootToInventory(inventoryId) {
      currentInventoryId = inventoryId;

      items = loadLocal(inventoryId) || [];
      showApp();
      render();
      toast("Sincronizando‚Ä¶", "warn");

      const data = await loadInventory(inventoryId);
      if (Array.isArray(data?.items)) {
        items = data.items;
        saveLocal(inventoryId, items);
      }
      $("invCodeShow").textContent = data?.invite_code || "(sem c√≥digo)";
      render();

      await startRealtime(inventoryId);
      await loadMembers();

      toast("Sincronizado ‚úÖ", "success");
    }

    /* =========================================================
       ‚úÖ FINALIZA√á√ÉO PROFISSIONAL (metadata)
    ========================================================= */

    async function finalizeSetupFromMetadata(sessionUser = null) {
      const user = sessionUser || await getSessionUser();
      if (!user) return false;

      // j√° tem invent√°rio?
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("current_inventory_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (profErr) {
        toast("Erro ao ler seu perfil.", "error");
        return true;
      }

      if (prof?.current_inventory_id) return false;

      const md = user.user_metadata || {};
      const mode = md.inv_mode; // "create" | "join"
      const code = (md.inv_code || "").toString().trim().toUpperCase();
      const displayName = (md.display_name || "Usu√°rio").toString().trim();

      if (!mode || (mode === "join" && !code)) return false;

      overlay(true);
      try {
        // profile name
        const { error: upErr } = await supabase.from("profiles").upsert({
          user_id: user.id,
          display_name: displayName
        });
        if (upErr) throw new Error(upErr.message);

        let inventoryId = null;

        if (mode === "create") {
          const { data, error } = await supabase.rpc("create_inventory_and_set_profile", {
            p_name: "Invent√°rio da Casa",
            p_display_name: displayName
          });
          if (error) throw new Error(error.message);
          inventoryId = data?.[0]?.inventory_id;
        } else {
          const { data, error } = await supabase.rpc("join_inventory_by_code", {
            p_code: code,
            p_display_name: displayName
          });
          if (error) throw new Error(error.message);
          inventoryId = data?.[0]?.inventory_id;
        }

        if (!inventoryId) throw new Error("N√£o consegui obter o invent√°rio.");

        // limpa metadata para n√£o reexecutar
        await supabase.auth.updateUser({ data: { inv_mode: null, inv_code: null } });

        await bootToInventory(inventoryId);
        return true;
      } catch (e) {
        console.error(e);
        toast("Falha ao finalizar invent√°rio: " + (e?.message || e), "error");
        return true;
      } finally {
        overlay(false);
      }
    }

    /* =========================================================
       UI EVENTS
    ========================================================= */

    $("openRegisterBtn").onclick = () => showRegister();
    $("backToLoginBtn").onclick = () => showLogin();
    $("genInv").addEventListener("change", syncRegisterUI);

    $("membersRefresh")?.addEventListener("click", async () => {
      await loadMembers();
      toast("Membros atualizados ‚úÖ", "success");
    });

    // LOGIN
    $("loginBtn").onclick = async () => {
      const email = $("loginEmail").value.trim();
      const password = $("loginPass").value;

      overlay(true);
      try {
        const { data: signInData, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          const h = humanizeAuthError(error);
          toast(h.text, h.type);
          return;
        }

        // tenta finalizar automaticamente
        if (await finalizeSetupFromMetadata(signInData?.session?.user)) return;

        const user = signInData?.session?.user || await getSessionUser();
        const { data: prof, error: perr } = await supabase
          .from("profiles")
          .select("current_inventory_id")
          .eq("user_id", user.id)
          .maybeSingle();

        if (perr) throw perr;

        if (prof?.current_inventory_id) {
          await bootToInventory(prof.current_inventory_id);
        } else {
          // usu√°rio antigo sem metadata
          toast("Seu usu√°rio n√£o tem invent√°rio vinculado. Use Registrar.", "warn");
          showRegister();
        }
      } catch (e) {
        console.error(e);
        toast("Falha no login.", "error");
      } finally {
        overlay(false);
      }
    };

    // REGISTER
    $("registerBtn").onclick = async () => {
      const displayName = $("regName").value.trim();
      const email = $("regEmail").value.trim();
      const password = $("regPass").value;
      const gen = $("genInv").checked;
      const code = ($("invCode").value || "").trim().toUpperCase();

      if (!displayName) return toast("Informe seu nome.", "warn");
      if (!email) return toast("Informe seu email.", "warn");
      if (!password || password.length < 6) return toast("Senha com pelo menos 6 caracteres.", "warn");
      if (!gen && !code) return toast("Informe o c√≥digo do invent√°rio.", "warn");

      overlay(true);
      try {
        const { data: signUpData, error: signUpErr } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: APP_URL,
            data: {
              display_name: displayName,
              inv_mode: gen ? "create" : "join",
              inv_code: gen ? null : code
            }
          }
        });

        if (signUpErr) {
          const h = humanizeAuthError(signUpErr);
          toast(h.text, h.type);
          return;
        }

        // confirm ON: n√£o vem session
        const user = signUpData?.session?.user || null;
        if (!user) {
          toast("Conta criada ‚úÖ Confirme o email. Depois voc√™ entra direto no invent√°rio.", "warn");
          showLogin();
          return;
        }

        // confirm OFF: finaliza na hora
        await finalizeSetupFromMetadata(user);

      } catch (e) {
        console.error(e);
        toast(String(e?.message || e), "error");
      } finally {
        overlay(false);
      }
    };

    $("logoutBtn").onclick = async () => {
      await stopRealtime();
      await supabase.auth.signOut();
      showLogin();
      toast("Saiu.", "success");
    };

    $("invCodeShow").onclick = async () => {
      const t = $("invCodeShow").textContent || "";
      if (!t) return;
      try {
        await navigator.clipboard.writeText(t);
        toast("C√≥digo copiado ‚úÖ", "success");
      } catch {
        toast("N√£o consegui copiar.", "error");
      }
    };

    $("add").onclick = addItem;
    $("search").addEventListener("input", render);
    $("name").addEventListener("keydown", (e) => { if (e.key === "Enter") addItem(); });

    $("filterList").onclick = () => {
      showOnlyNeeds = !showOnlyNeeds;
      $("filterList").classList.toggle("active", showOnlyNeeds);
      $("filterList").textContent = showOnlyNeeds ? "Mostrar tudo" : "Filtrar lista";
      render();
      toast(showOnlyNeeds ? "Filtro ativado" : "Mostrando tudo", "success");
    };

    $("export").onclick = () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "inventario.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("Backup exportado ‚úÖ", "success");
    };

    $("import").onclick = async () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = async () => {
        const file = inp.files?.[0];
        if (!file) return;
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) return toast("Arquivo inv√°lido.", "error");
        items = data;
        render();
        await saveNow(items);
        toast("Importado ‚úÖ", "success");
      };
      inp.click();
    };

    $("clear").onclick = async () => {
      if (!confirm("Tem certeza que quer zerar tudo?")) return;
      items = [];
      render();
      await saveNow(items);
      toast("Invent√°rio zerado ‚úÖ", "success");
    };

    // INIT
    (async () => {
      // footer (todas as telas)
      const footer = $("footer");
      if (footer) {
        footer.innerHTML =
          `¬© ${new Date().getFullYear()} <a href="https://github.com/Dihegoof" target="_blank" rel="noopener noreferrer">Dihego Nunes</a> ‚Äî Todos os direitos reservados`;
      }

      const { data: { session } } = await supabase.auth.getSession();

      if (session?.user) {
        if (await finalizeSetupFromMetadata(session.user)) return;

        overlay(true);
        try {
          const { data: prof, error } = await supabase
            .from("profiles")
            .select("current_inventory_id")
            .eq("user_id", session.user.id)
            .maybeSingle();

          if (error) throw error;

          if (prof?.current_inventory_id) {
            await bootToInventory(prof.current_inventory_id);
          } else {
            toast("Seu usu√°rio n√£o tem invent√°rio vinculado. Use Registrar.", "warn");
            showRegister();
          }
        } catch (e) {
          console.error(e);
          toast("Falha ao iniciar sess√£o.", "error");
          showLogin();
        } finally {
          overlay(false);
        }
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>