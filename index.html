<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio da Casa</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <!-- Overlay -->
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <!-- Toast host -->
  <div id="toastHost" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- ===== AUTH ===== -->
  <div id="authView" class="center-screen">
    <div class="card login-card">
      <h1 class="title" id="authTitle">Entrar</h1>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="row">
          <input id="loginEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>

        <div class="row mt12">
          <button id="loginBtn">Logar</button>
          <button id="openRegisterBtn" class="small" type="button">Registrar</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" class="hidden">
        <div class="row">
          <input id="regName" placeholder="Seu nome" autocomplete="name" />
        </div>
        <div class="row mt10">
          <input id="regEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="regPass" type="password" placeholder="Senha" autocomplete="new-password" />
        </div>

        <div class="row mt10" style="align-items:center;">
          <label class="checkline">
            <input id="genInv" type="checkbox" checked />
            Gerar invent√°rio
          </label>
        </div>

        <div class="row mt10">
          <input id="invCode" placeholder="C√≥digo do invent√°rio (6 letras/n√∫meros)" autocomplete="off" disabled />
        </div>

        <div class="row mt12">
          <button id="registerBtn">Criar conta</button>
          <button id="backToLoginBtn" class="small" type="button">Voltar</button>
        </div>

        <div class="muted">
          Dica: Se marcar ‚ÄúGerar invent√°rio‚Äù, voc√™ vira dono e ganha um c√≥digo pra compartilhar com sua fam√≠lia.
        </div>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appView" class="wrap hidden">
    <div class="card">
      <div class="row header-row">
        <h1 class="title">Invent√°rio da Casa</h1>
        <button id="logoutBtn" class="small">Sair</button>
      </div>

      <div class="muted" style="margin-top:6px;">
        C√≥digo do invent√°rio:
        <span id="invCodeShow" class="pill copy" title="Toque para copiar"></span>
      </div>

      <div class="divider"></div>

      <!-- ===== MEMBERS (SIMPLES) ===== -->
      <div id="membersBox">
        <div class="row header-row" style="align-items:flex-end;">
          <div>
            <div style="font-weight:900;">Membros</div>
            <div class="muted" style="margin-top:4px;">Tempo real ‚Ä¢ cargo ‚Ä¢ visto por √∫ltimo</div>
          </div>
          <div class="pill" id="myRolePill" title="Seu cargo">‚Äî</div>
        </div>

        <div id="membersList" class="list" style="margin-top:10px;"></div>
      </div>

      <div class="divider"></div>

      <!-- SEARCH -->
      <div class="row">
        <input id="search" placeholder="Buscar item" />
      </div>

      <div class="divider"></div>

      <!-- ADD / EDIT -->
      <div class="row">
        <input id="name" placeholder="Novo item:" />
        <select id="unit">
          <option value="un">un</option>
          <option value="g">g</option>
          <option value="kg">kg</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
        <input id="qty" type="number" step="0.1" placeholder="Qtd" class="w120" />
        <input id="min" type="number" step="0.1" placeholder="M√≠n" class="w120" />

        <label class="checkline" style="align-items:center; gap:8px;">
          <input id="essential" type="checkbox" />
          Essencial
        </label>

        <button id="add">Adicionar</button>
        <button id="cancelEdit" class="small ghost hidden" type="button">Cancelar</button>
      </div>

      <div class="muted" id="editHint" style="margin-top:8px;">
        Dica: ‚ÄúM√≠n‚Äù emite alerta ao chegar na quantidade definida.
      </div>

      <div class="divider"></div>

      <!-- ACTIONS -->
      <div class="row actions">
        <button class="small" id="filterList">Filtrar lista</button>
        <button class="small" id="filterEssentials">Essenciais: ambos</button>
        <button class="small" id="exportText">Exportar (texto)</button>
        <button class="small" id="import">Importar</button>
        <button class="small" id="clear">Zerar tudo</button>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <footer id="footer" class="footer"></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ========= CONFIG =========
    const SUPABASE_URL = "https://xzcgwnifypiqqushxrcs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9Nx27f1V0IgMkMw6BdTwmQ_B96lf3wq";
    const APP_URL = "https://dihegoof.github.io/manager/";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      }
    });

    // ========= SAFE READY =========
    const ready = (fn) => (document.readyState === "loading"
      ? document.addEventListener("DOMContentLoaded", fn, { once: true })
      : fn());

    ready(() => {
      // ========= HELPERS =========
      const $ = (id) => document.getElementById(id);

      const norm = (s) => (s || "")
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();

      const round = (v) => Math.round((Number(v) + Number.EPSILON) * 10) / 10;

      function fmtDate(ts) {
        if (!ts) return "‚Äî";
        const d = new Date(ts);
        if (isNaN(d.getTime())) return "‚Äî";
        return d.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
      }

      function diffDays(a, b) {
        if (!a || !b) return null;
        const da = new Date(a), db = new Date(b);
        if (isNaN(da) || isNaN(db)) return null;
        const ms = db.getTime() - da.getTime();
        if (ms < 0) return null;
        return Math.floor(ms / (1000 * 60 * 60 * 24));
      }

      // Footer
      $("footer").innerHTML = `¬© ${new Date().getFullYear()}
        <a href="https://github.com/Dihegoof" target="_blank" rel="noopener">Dihego Nunes</a>
        ‚Äî Todos os direitos reservados`;

      // ========= TOAST =========
      const lastToastAt = new Map();
      function normalizeToastType(type) {
        // seu CSS tem success / error / warn (e talvez warning/info)
        if (type === "success" || type === "error" || type === "warn") return type;
        return "warn";
      }
      function toast(message, type = "warn", key = "") {
        const t = normalizeToastType(type);
        const msg = (message || "").toString().trim();
        if (!msg) return;

        const k = key || (t + ":" + msg);
        const now = Date.now();
        const last = lastToastAt.get(k) || 0;
        if (now - last < 900) return;
        lastToastAt.set(k, now);

        const host = $("toastHost");
        const wrap = document.createElement("div");
        wrap.className = `toast ${t}`;

        const bubble = document.createElement("div");
        bubble.className = "toast-bubble";
        bubble.textContent = msg;

        wrap.appendChild(bubble);
        host.appendChild(wrap);

        requestAnimationFrame(() => wrap.classList.add("show"));
        setTimeout(() => wrap.classList.add("hide"), 3200);
        setTimeout(() => wrap.remove(), 3800);
      }

      // ========= OVERLAY (NO INFINITE) =========
      function overlay(on) { $("overlay").classList.toggle("on", !!on); }
      let overlayTimer = null;
      function overlaySafe(on, reason = "") {
        overlay(!!on);
        clearTimeout(overlayTimer);
        if (on) {
          overlayTimer = setTimeout(() => {
            overlay(false);
            toast("Travou no carregamento. Atualiza a p√°gina.", "warn", "overlay-timeout");
            console.warn("Overlay timeout:", reason);
          }, 9000);
        }
      }

      function withTimeout(promise, ms, label = "opera√ß√£o") {
        return Promise.race([
          promise,
          new Promise((_, reject) =>
            setTimeout(() => reject(new Error(`${label}: timeout (${ms}ms)`)), ms)
          )
        ]);
      }

      window.addEventListener("unhandledrejection", (e) => {
        console.error("unhandledrejection:", e?.reason);
        overlay(false);
        toast("Erro: " + (e?.reason?.message || e?.reason || "falha"), "error", "unhandled");
      });
      window.addEventListener("error", (e) => {
        console.error("window error:", e?.message, e);
        overlay(false);
        toast("Erro: " + (e?.message || "falha"), "error", "window-error");
      });

      // ========= VIEWS =========
      function showLogin() {
        $("authTitle").textContent = "Entrar";
        $("loginForm").classList.remove("hidden");
        $("registerForm").classList.add("hidden");
        $("authView").classList.remove("hidden");
        $("appView").classList.add("hidden");
        $("authView").classList.add("fade-in");
      }

      function showRegister() {
        $("authTitle").textContent = "Registrar";
        $("loginForm").classList.add("hidden");
        $("registerForm").classList.remove("hidden");
        $("authView").classList.remove("hidden");
        $("appView").classList.add("hidden");
        syncRegisterUI();
        $("authView").classList.add("fade-in");
      }

      function showApp() {
        $("authView").classList.add("hidden");
        $("appView").classList.remove("hidden");
        $("appView").classList.add("fade-in");
      }

      function syncRegisterUI() {
        const gen = $("genInv").checked;
        $("invCode").disabled = gen;
        if (gen) $("invCode").value = "";
      }

      // ========= STATE =========
      let currentUser = null;
      let currentInventoryId = null;

      let items = [];
      let members = [];

      let realtimeItems = null;
      let realtimeMembers = null;

      let showOnlyNeeds = false;
      let essentialFilter = "both"; // both | essential | not

      let editItemId = null;

      // pending registration setup (para casos de confirm email ON)
      const PENDING_KEY = "pending_inv_setup_v3";
      const setPending = (obj) => localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
      const getPending = () => { try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "null"); } catch { return null; } };
      const clearPending = () => localStorage.removeItem(PENDING_KEY);

      function needsBuy(it) {
        const qty = Number(it.qty ?? 0);
        const min = Number(it.min_qty ?? 0);
        return qty <= 0 || (min > 0 && qty <= min);
      }

      // ========= RENDER MEMBERS =========
      function renderMembers() {
        const host = $("membersList");
        host.innerHTML = "";

        if (!members.length) {
          const empty = document.createElement("div");
          empty.className = "sub";
          empty.textContent = "Nenhum membro ainda.";
          host.appendChild(empty);
          return;
        }

        const sorted = [...members].sort((a,b) => {
          const ra = (a.role === "owner") ? 0 : 1;
          const rb = (b.role === "owner") ? 0 : 1;
          if (ra !== rb) return ra - rb;
          return (a.display_name || "").localeCompare((b.display_name || ""), "pt-BR");
        });

        for (const m of sorted) {
          const row = document.createElement("div");
          row.className = "item";

          const left = document.createElement("div");
          const star = m.role === "owner" ? " ‚òÖ" : "";
          left.innerHTML = `
            <div class="name">${m.display_name || "Usu√°rio"}${star}</div>
            <div class="sub">cargo: ${m.role} ‚Ä¢ visto: ${fmtDate(m.last_seen_at)}</div>
          `;

          row.appendChild(left);
          host.appendChild(row);
        }
      }

      // ========= RENDER ITEMS =========
      function renderItems() {
        const q = norm($("search").value);
        const list = $("list");
        list.innerHTML = "";

        let filtered = items
          .filter(it => {
            const matchesSearch = !q || (it.name_norm || "").includes(q);
            const matchesNeeds = !showOnlyNeeds || needsBuy(it);

            let matchesEssential = true;
            if (essentialFilter === "essential") matchesEssential = !!it.essential;
            if (essentialFilter === "not") matchesEssential = !it.essential;

            return matchesSearch && matchesNeeds && matchesEssential;
          })
          .sort((a,b) => (a.name || "").localeCompare((b.name || ""), "pt-BR"));

        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "sub";
          empty.textContent = showOnlyNeeds ? "Nenhum item precisa comprar üôÇ" : "Nada por aqui üôÇ";
          list.appendChild(empty);
          return;
        }

        for (const it of filtered) {
          const row = document.createElement("div");
          row.className = "item";

          const left = document.createElement("div");
          const needs = needsBuy(it);
          const ess = it.essential ? ' ‚Ä¢ <span class="pill">essencial</span>' : "";
          left.innerHTML = `
            <div class="name">${it.name}</div>
            <div class="sub">
              ${it.qty} ${it.unit} ‚Ä¢ m√≠nimo: ${it.min_qty || 0}
              ${needs ? ' ‚Ä¢ <span class="pill danger">precisa comprar</span>' : ""}
              ${ess}
            </div>
          `;

          const controls = document.createElement("div");
          controls.className = "controls";

          const minus = document.createElement("button");
          minus.textContent = "‚àí";
          minus.onclick = () => changeQty(it.id, it.unit === "un" ? -1 : -0.1);

          const edit = document.createElement("button");
          edit.textContent = "‚öôÔ∏è";
          edit.title = "Editar";
          edit.onclick = () => startEdit(it);

          const info = document.createElement("button");
          info.textContent = "‚ÑπÔ∏è";
          info.title = "Info / hist√≥rico";
          info.onclick = () => showInfo(it);

          const qty = document.createElement("div");
          qty.className = "qty pill";
          qty.textContent = `${it.qty} ${it.unit}`;

          const plus = document.createElement("button");
          plus.textContent = "+";
          plus.onclick = () => changeQty(it.id, it.unit === "un" ? +1 : +0.1);

          controls.append(minus, edit, info, qty, plus);
          row.append(left, controls);
          list.appendChild(row);
        }
      }

      function showInfo(it) {
        const d = diffDays(it.last_buy_at, it.last_zero_at);
        const dur = (d == null) ? "‚Äî" : `${d} dia(s)`;

        const txt =
`üì¶ ${it.name}

üõí √öltima compra:
- data: ${fmtDate(it.last_buy_at)}
- qtd:  ${it.last_buy_qty ?? "‚Äî"}

üõí Compra anterior:
- data: ${fmtDate(it.prev_buy_at)}
- qtd:  ${it.prev_buy_qty ?? "‚Äî"}

üßØ √öltimo zerado:
- data: ${fmtDate(it.last_zero_at)}

‚è±Ô∏è Dura√ß√£o (√∫ltima compra ‚Üí √∫ltimo zerado):
- ${dur}
`;
        alert(txt);
      }

      // ========= AUTH / BOOT =========
      async function getSession() {
        const { data: { session } } = await supabase.auth.getSession();
        return session || null;
      }

      async function ensureProfileRow(displayName = "Usu√°rio") {
        // garante que profile existe (RLS permite insert own)
        const { error } = await withTimeout(
          supabase.from("profiles").upsert({ user_id: currentUser.id, display_name: displayName }),
          8000,
          "profile upsert"
        );
        if (error) throw error;
      }

      async function finalizePendingIfAny() {
        const pending = getPending();
        if (!pending || !currentUser) return false;

        try {
          await ensureProfileRow(pending.displayName || "Usu√°rio");

          let invId = null;

          if (pending.mode === "create") {
            const { data, error } = await withTimeout(
              supabase.rpc("create_inventory_and_set_profile", {
                p_name: "Invent√°rio da Casa",
                p_display_name: pending.displayName || "Usu√°rio",
              }),
              9000,
              "RPC create"
            );
            if (error) throw error;
            invId = data?.[0]?.inventory_id || data?.inventory_id || data?.[0] || null;
          } else {
            const { data, error } = await withTimeout(
              supabase.rpc("join_inventory_by_code", {
                p_code: pending.code,
                p_display_name: pending.displayName || "Usu√°rio",
              }),
              9000,
              "RPC join"
            );
            if (error) throw error;
            invId = data?.[0]?.inventory_id || data?.inventory_id || data?.[0] || null;
          }

          clearPending();

          if (!invId) throw new Error("N√£o consegui obter o invent√°rio.");
          await bootInventory(invId);
          return true;

        } catch (e) {
          console.error(e);
          clearPending();
          toast("Falhou ao finalizar v√≠nculo/cria√ß√£o: " + (e?.message || e), "error", "finalize-fail");
          showRegister();
          return true;
        }
      }

      async function bootFromProfile() {
        if (!currentUser) return;

        // 1) se tinha pending (cadastro), finaliza primeiro
        const did = await finalizePendingIfAny();
        if (did) return;

        // 2) busca o current_inventory_id
        const { data: prof, error } = await withTimeout(
          supabase.from("profiles")
            .select("current_inventory_id, display_name")
            .eq("user_id", currentUser.id)
            .maybeSingle(),
          8000,
          "load profile"
        );

        if (error) throw error;

        if (!prof?.current_inventory_id) {
          showRegister();
          toast("Voc√™ est√° logado. Gere um invent√°rio ou informe um c√≥digo.", "warn", "need-inv");
          return;
        }

        await bootInventory(prof.current_inventory_id);
      }

      async function loadInventoryMeta(invId) {
        const { data, error } = await withTimeout(
          supabase.from("inventories")
            .select("invite_code, name")
            .eq("id", invId)
            .single(),
          8000,
          "load inventory meta"
        );
        if (error) throw error;
        $("invCodeShow").textContent = data?.invite_code || "(sem c√≥digo)";
      }

      async function loadItems(invId) {
        const { data, error } = await withTimeout(
          supabase.from("inventory_items")
            .select("*")
            .eq("inventory_id", invId),
          8000,
          "load items"
        );
        if (error) throw error;
        items = Array.isArray(data) ? data : [];
        renderItems();
      }

      async function loadMembers(invId) {
        const { data, error } = await withTimeout(
          supabase.from("inventory_members")
            .select("inventory_id,user_id,role,display_name,last_seen_at,created_at")
            .eq("inventory_id", invId),
          8000,
          "load members"
        );
        if (error) throw error;
        members = Array.isArray(data) ? data : [];
        renderMembers();

        const me = members.find(m => m.user_id === currentUser.id);
        $("myRolePill").textContent = me?.role ? `voc√™: ${me.role}` : "voc√™: ‚Äî";
      }

      async function stopRealtime() {
        try {
          if (realtimeItems) await supabase.removeChannel(realtimeItems);
        } catch {}
        try {
          if (realtimeMembers) await supabase.removeChannel(realtimeMembers);
        } catch {}
        realtimeItems = null;
        realtimeMembers = null;
      }

      async function startRealtime(invId) {
        await stopRealtime();

        realtimeItems = supabase
          .channel("rt-items-" + invId)
          .on("postgres_changes", {
            event: "*",
            schema: "public",
            table: "inventory_items",
            filter: `inventory_id=eq.${invId}`,
          }, (payload) => {
            // Realtime confi√°vel: refaz estado local sem ‚Äúbrigar‚Äù entre sess√µes
            const ev = payload.eventType;
            if (ev === "INSERT") {
              items = [payload.new, ...items.filter(x => x.id !== payload.new.id)];
            } else if (ev === "UPDATE") {
              items = items.map(x => x.id === payload.new.id ? payload.new : x);
            } else if (ev === "DELETE") {
              items = items.filter(x => x.id !== payload.old.id);
            }
            renderItems();
          })
          .subscribe();

        realtimeMembers = supabase
          .channel("rt-members-" + invId)
          .on("postgres_changes", {
            event: "*",
            schema: "public",
            table: "inventory_members",
            filter: `inventory_id=eq.${invId}`,
          }, (payload) => {
            const ev = payload.eventType;
            if (ev === "INSERT") {
              members = [payload.new, ...members.filter(x => x.user_id !== payload.new.user_id)];
            } else if (ev === "UPDATE") {
              members = members.map(x => x.user_id === payload.new.user_id ? payload.new : x);
            } else if (ev === "DELETE") {
              members = members.filter(x => x.user_id !== payload.old.user_id);
            }
            renderMembers();

            const me = members.find(m => m.user_id === currentUser.id);
            $("myRolePill").textContent = me?.role ? `voc√™: ${me.role}` : "voc√™: ‚Äî";
          })
          .subscribe();
      }

      async function bootInventory(invId) {
        currentInventoryId = invId;

        showApp();

        // Carrega meta + itens + membros (sem overlay infinito)
        overlaySafe(true, "boot");
        try {
          await loadInventoryMeta(invId);
          await Promise.all([
            loadItems(invId),
            loadMembers(invId),
          ]);
          await startRealtime(invId);
          toast("Sincronizado ‚úÖ", "success", "synced");
        } finally {
          overlaySafe(false, "boot");
        }
      }

      // ========= LAST SEEN (membros) =========
      let lastSeenPingAt = 0;
      async function pingLastSeen() {
        if (!currentUser || !currentInventoryId) return;
        const now = Date.now();
        if (now - lastSeenPingAt < 60_000) return; // 1 min
        lastSeenPingAt = now;

        // update s√≥ no membership (mais √∫til pro app)
        const { error } = await supabase
          .from("inventory_members")
          .update({ last_seen_at: new Date().toISOString() })
          .eq("inventory_id", currentInventoryId)
          .eq("user_id", currentUser.id);

        // se falhar n√£o quebra UX
        if (error) console.warn("last_seen update:", error.message);
      }

      setInterval(() => { pingLastSeen(); }, 60_000);
      window.addEventListener("focus", () => { pingLastSeen(); });
      document.addEventListener("visibilitychange", () => {
        // ‚úÖ n√£o faz ‚Äúloading‚Äù aqui, s√≥ pinga quando volta
        if (!document.hidden) pingLastSeen();
      });

      // ========= ITEMS CRUD =========
      function resetEdit() {
        editItemId = null;
        $("cancelEdit").classList.add("hidden");
        $("add").textContent = "Adicionar";
        $("editHint").textContent = "Dica: ‚ÄúM√≠n‚Äù emite alerta ao chegar na quantidade definida.";
      }

      function startEdit(it) {
        editItemId = it.id;
        $("name").value = it.name || "";
        $("unit").value = it.unit || "un";
        $("qty").value = it.qty ?? 0;
        $("min").value = it.min_qty ?? 0;
        $("essential").checked = !!it.essential;

        $("cancelEdit").classList.remove("hidden");
        $("add").textContent = "Salvar";
        $("editHint").textContent = "Editando item ‚Äî altere os campos e clique em Salvar.";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      async function upsertItem() {
        if (!currentUser || !currentInventoryId) return;

        const name = $("name").value.trim();
        const unit = $("unit").value;
        const qty = round(Number($("qty").value || 0));
        const minQty = round(Number($("min").value || 0));
        const essential = !!$("essential").checked;

        if (!name) return toast("Informe o nome do item.", "warn", "need-name");

        const payload = {
          inventory_id: currentInventoryId,
          name,
          name_norm: norm(name),
          unit,
          qty,
          min_qty: minQty,
          essential,
        };

        overlaySafe(true, "upsert-item");
        try {
          if (editItemId) {
            const { error } = await withTimeout(
              supabase.from("inventory_items")
                .update(payload)
                .eq("id", editItemId)
                .eq("inventory_id", currentInventoryId),
              8000,
              "update item"
            );
            if (error) throw error;

            toast("Atualizado ‚úÖ", "success", "item-upd");
            resetEdit();
          } else {
            payload.created_by = currentUser.id;

            const { error } = await withTimeout(
              supabase.from("inventory_items").insert(payload),
              8000,
              "insert item"
            );
            if (error) throw error;

            toast("Adicionado ‚úÖ", "success", "item-add");
          }

          $("name").value = "";
          $("qty").value = "";
          $("min").value = "";
          $("essential").checked = false;

        } catch (e) {
          console.error(e);
          toast("Falha ao salvar: " + (e?.message || e), "error", "save-fail");
        } finally {
          overlaySafe(false, "upsert-item");
        }
      }

      async function changeQty(itemId, delta) {
        const it = items.find(x => x.id === itemId);
        if (!it) return;

        const newQty = round(Math.max(0, Number(it.qty || 0) + Number(delta)));

        // otimista local
        items = items.map(x => x.id === itemId ? { ...x, qty: newQty } : x);
        renderItems();

        const { error } = await supabase
          .from("inventory_items")
          .update({ qty: newQty })
          .eq("id", itemId)
          .eq("inventory_id", currentInventoryId);

        if (error) {
          console.warn(error);
          toast("N√£o salvou no cloud: " + error.message, "error", "qty-fail");
          // recarrega pra consist√™ncia
          try { await loadItems(currentInventoryId); } catch {}
        }
      }

      // ========= EXPORT / IMPORT / CLEAR =========
      function exportText() {
        const lines = items
          .slice()
          .sort((a,b) => (a.name||"").localeCompare((b.name||""), "pt-BR"))
          .map(it => {
            const ess = it.essential ? " (essencial)" : "";
            const needs = needsBuy(it) ? " [PRECISA]" : "";
            return `- ${it.name}: ${it.qty} ${it.unit} (min: ${it.min_qty || 0})${ess}${needs}`;
          });

        const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "inventario.txt";
        a.click();
        URL.revokeObjectURL(url);
        toast("Exportado ‚úÖ", "success", "export-text");
      }

      async function importJson() {
        const inp = document.createElement("input");
        inp.type = "file";
        inp.accept = "application/json";

        inp.onchange = async () => {
          const file = inp.files?.[0];
          if (!file) return;

          overlaySafe(true, "import");
          try {
            const text = await file.text();
            const data = JSON.parse(text);
            if (!Array.isArray(data)) return toast("Arquivo inv√°lido.", "error", "import-invalid");

            // Importa como INSERT em lote (convertendo pro schema novo)
            const rows = data.map(x => ({
              inventory_id: currentInventoryId,
              name: x.name || "",
              name_norm: x.name_norm || norm(x.name || ""),
              unit: x.unit || "un",
              qty: round(Number(x.qty || 0)),
              min_qty: round(Number(x.min_qty || 0)),
              essential: !!x.essential,
              created_by: currentUser.id,
            })).filter(r => r.name.trim());

            if (!rows.length) return toast("Nada pra importar.", "warn", "import-empty");

            const { error } = await withTimeout(
              supabase.from("inventory_items").insert(rows),
              9000,
              "import insert"
            );
            if (error) throw error;

            toast("Importado ‚úÖ", "success", "import-ok");
          } catch (e) {
            console.error(e);
            toast("Falha ao importar: " + (e?.message || e), "error", "import-fail");
          } finally {
            overlaySafe(false, "import");
          }
        };

        inp.click();
      }

      async function clearAll() {
        if (!confirm("Tem certeza que quer zerar tudo?")) return;

        overlaySafe(true, "clear");
        try {
          const { error } = await withTimeout(
            supabase.from("inventory_items")
              .delete()
              .eq("inventory_id", currentInventoryId),
            9000,
            "clear items"
          );
          if (error) throw error;

          toast("Zerado ‚úÖ", "success", "clear-ok");
        } catch (e) {
          console.error(e);
          toast("Falha ao zerar: " + (e?.message || e), "error", "clear-fail");
        } finally {
          overlaySafe(false, "clear");
        }
      }

      // ========= UI EVENTS =========
      $("openRegisterBtn").onclick = () => showRegister();
      $("backToLoginBtn").onclick = () => showLogin();
      $("genInv").addEventListener("change", syncRegisterUI);

      $("loginBtn").onclick = async () => {
        const email = $("loginEmail").value.trim();
        const password = $("loginPass").value;

        if (!email || !password) return toast("Informe email e senha.", "warn", "need-login");

        overlaySafe(true, "login");
        try {
          const { data, error } = await withTimeout(
            supabase.auth.signInWithPassword({ email, password }),
            9000,
            "login"
          );
          if (error) throw error;

          currentUser = data?.user || (await getSession())?.user || null;
          toast("Logado ‚úÖ", "success", "logged");
          await bootFromProfile();

        } catch (e) {
          console.error(e);
          toast("Falha no login: " + (e?.message || e), "error", "login-fail");
        } finally {
          overlaySafe(false, "login");
        }
      };

      $("registerBtn").onclick = async () => {
        const displayName = $("regName").value.trim();
        const email = $("regEmail").value.trim();
        const password = $("regPass").value;
        const gen = $("genInv").checked;
        const code = ($("invCode").value || "").trim().toUpperCase();

        if (!displayName) return toast("Informe seu nome.", "warn", "reg-name");
        if (!email) return toast("Informe seu email.", "warn", "reg-email");
        if (!password || password.length < 6) return toast("Senha com pelo menos 6 caracteres.", "warn", "reg-pass");
        if (!gen && !code) return toast("Informe o c√≥digo do invent√°rio.", "warn", "reg-code");

        // guarda pending (pra casos de confirm email ON)
        setPending({
          displayName,
          mode: gen ? "create" : "join",
          code: gen ? "" : code,
          createdAt: Date.now(),
        });

        overlaySafe(true, "register");
        try {
          const { data, error } = await withTimeout(
            supabase.auth.signUp({
              email,
              password,
              options: { emailRedirectTo: APP_URL },
            }),
            9000,
            "signUp"
          );
          if (error) {
            clearPending();
            throw error;
          }

          // Se confirm email estiver ON, n√£o vem session
          if (!data?.session?.user) {
            toast("Conta criada ‚úÖ Confirme o email e depois fa√ßa login.", "warn", "confirm-email");
            showLogin();
            return;
          }

          currentUser = data.session.user;
          toast("Conta criada ‚úÖ", "success", "signup-ok");

          // finaliza cria√ß√£o/v√≠nculo agora
          await finalizePendingIfAny();

        } catch (e) {
          console.error(e);
          clearPending();
          toast("Falha no cadastro: " + (e?.message || e), "error", "signup-fail");
        } finally {
          overlaySafe(false, "register");
        }
      };

      $("logoutBtn").onclick = async () => {
        overlaySafe(true, "logout");
        try {
          await stopRealtime();
          await supabase.auth.signOut();
          currentUser = null;
          currentInventoryId = null;
          items = [];
          members = [];
          resetEdit();
          showLogin();
          toast("Saiu.", "warn", "logout");
        } finally {
          overlaySafe(false, "logout");
        }
      };

      $("invCodeShow").onclick = async () => {
        const t = $("invCodeShow").textContent || "";
        if (!t || t === "(sem c√≥digo)") return;
        try {
          await navigator.clipboard.writeText(t);
          toast("C√≥digo copiado ‚úÖ", "success", "copy-code");
        } catch {
          toast("N√£o consegui copiar.", "error", "copy-fail");
        }
      };

      $("add").onclick = () => upsertItem();
      $("cancelEdit").onclick = () => { resetEdit(); };

      $("search").addEventListener("input", renderItems);
      $("name").addEventListener("keydown", (e) => {
        if (e.key === "Enter") upsertItem();
      });

      $("filterList").onclick = () => {
        showOnlyNeeds = !showOnlyNeeds;
        $("filterList").classList.toggle("active", showOnlyNeeds);
        $("filterList").textContent = showOnlyNeeds ? "Mostrar tudo" : "Filtrar lista";
        renderItems();
      };

      $("filterEssentials").onclick = () => {
        if (essentialFilter === "both") essentialFilter = "essential";
        else if (essentialFilter === "essential") essentialFilter = "not";
        else essentialFilter = "both";

        $("filterEssentials").textContent =
          essentialFilter === "both" ? "Essenciais: ambos" :
          essentialFilter === "essential" ? "Essenciais: s√≥ essenciais" :
          "Essenciais: s√≥ n√£o essenciais";

        renderItems();
      };

      $("exportText").onclick = exportText;
      $("import").onclick = importJson;
      $("clear").onclick = clearAll;

      // ========= AUTH STATE (SEM BUG DE TROCAR ABA) =========
      let booting = false;

      supabase.auth.onAuthStateChange(async (_event, session) => {
        // N√£o fica ‚Äúfor√ßando overlay‚Äù aqui -> evita bug de tab switch
        if (booting) return;

        if (!session?.user) {
          await stopRealtime();
          currentUser = null;
          currentInventoryId = null;
          items = [];
          members = [];
          resetEdit();
          showLogin();
          return;
        }

        booting = true;
        try {
          currentUser = session.user;
          await bootFromProfile();
          pingLastSeen();
        } catch (e) {
          console.error(e);
          showRegister();
          toast("Logado ‚úÖ mas falhou ao iniciar: " + (e?.message || e), "warn", "boot-fail");
        } finally {
          booting = false;
        }
      });

      // ========= FIRST PAINT =========
      (async () => {
        try {
          const session = await getSession();
          if (!session?.user) return showLogin();

          currentUser = session.user;
          await bootFromProfile();
          pingLastSeen();
        } catch (e) {
          console.error(e);
          showLogin();
        }
      })();

      // (opcional) avisa offline/online sem ‚Äúcair da conta‚Äù
      window.addEventListener("offline", () => toast("Sem internet. Pode atrasar o tempo real.", "warn", "offline"));
      window.addEventListener("online", () => toast("Conex√£o voltou ‚úÖ", "success", "online"));
    });
  </script>
</body>
</html>