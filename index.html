<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invent√°rio da Casa</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <div id="toastHost" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal simples (Info do item) -->
  <div id="modal" class="modal hidden" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Info</div>
        <button id="modalClose" class="small ghost" type="button">Fechar</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>

  <!-- ===== AUTH ===== -->
  <div id="authView" class="center-screen">
    <div class="card login-card">
      <h1 class="title" id="authTitle">Entrar</h1>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="row">
          <input id="loginEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="loginPass" type="password" placeholder="Senha" autocomplete="current-password" />
        </div>

        <div class="row mt12">
          <button id="loginBtn">Logar</button>
          <button id="openRegisterBtn" class="small" type="button">Registrar</button>
        </div>
      </div>

      <!-- REGISTER -->
      <div id="registerForm" class="hidden">
        <div class="row">
          <input id="regName" placeholder="Seu nome" autocomplete="name" />
        </div>
        <div class="row mt10">
          <input id="regEmail" placeholder="Email" autocomplete="username" />
        </div>
        <div class="row mt10">
          <input id="regPass" type="password" placeholder="Senha" autocomplete="new-password" />
        </div>

        <div class="row mt10" style="align-items:center;">
          <label class="checkline">
            <input id="genInv" type="checkbox" checked />
            Gerar invent√°rio
          </label>
        </div>

        <div class="row mt10">
          <input id="invCode" placeholder="C√≥digo do invent√°rio (6 letras/n√∫meros)" autocomplete="off" disabled />
        </div>

        <div class="row mt12">
          <button id="registerBtn">Criar conta</button>
          <button id="backToLoginBtn" class="small" type="button">Voltar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appView" class="wrap hidden">
    <div class="card">
      <div class="row header-row">
        <h1 class="title">Invent√°rio da Casa</h1>
        <button id="logoutBtn" class="small">Sair</button>
      </div>

      <div class="muted" style="margin-top:6px;">
        C√≥digo do invent√°rio:
        <span id="invCodeShow" class="pill copy" title="Toque para copiar"></span>
      </div>

      <!-- ===== MEMBROS (hidden / accordion) ===== -->
      <div class="divider"></div>

      <div class="members-box">
        <div class="row header-row" style="gap:8px;">
          <div class="members-title">Membros</div>

          <div class="row" style="gap:8px; justify-content:flex-end; flex: 1;">
            <button id="toggleMembersBtn" class="small ghost" type="button">Mostrar membros</button>
            <button id="reloadMembersBtn" class="small ghost hidden" type="button">Atualizar</button>
          </div>
        </div>

        <div id="membersWrap" class="hidden">
          <div class="muted" style="margin-top:4px;">
            ‚≠ê = dono. (visualiza√ß√£o apenas por enquanto)
          </div>
          <div id="membersList" class="members-list"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <input id="search" placeholder="Buscar item" />
      </div>

      <div class="divider"></div>

      <!-- ADD / EDIT -->
      <div class="row">
        <input id="name" placeholder="Novo item:" />
        <select id="unit">
          <option value="un">un</option>
          <option value="g">g</option>
          <option value="kg">kg</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
        <input id="qty" type="number" step="0.1" placeholder="Qtd" class="w120" />
        <input id="min" type="number" step="0.1" placeholder="M√≠n" class="w120" />
        <button id="add">Adicionar</button>
        <button id="cancelEdit" class="small ghost hidden" type="button">Cancelar</button>
      </div>

      <div class="muted" id="editHint">
        Dica: O ‚ÄúM√≠n‚Äù (m√≠nimo) emite um alerta ao chegar na quantidade definida.
      </div>

      <div class="divider"></div>

      <div class="row actions">
        <button class="small" id="filterList">Filtrar lista</button>
        <button class="small" id="export">Exportar (backup)</button>
        <button class="small" id="import">Importar</button>
        <button class="small" id="clear">Zerar tudo</button>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer id="footer" class="footer"></footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xzcgwnifypiqqushxrcs.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_9Nx27f1V0IgMkMw6BdTwmQ_B96lf3wq";
    const APP_URL = "https://dihegoof.github.io/manager/";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
    const round = (v) => Math.round((Number(v) + Number.EPSILON) * 10) / 10;

    // Footer
    $("footer").innerHTML = `¬© ${new Date().getFullYear()}
      <a href="https://github.com/Dihegoof" target="_blank" rel="noopener">Dihego Nunes</a>
      ‚Äî Todos os direitos reservados`;

    // ===== Toast =====
    const lastToastAt = new Map();
    function toast(message, type = "warn", key = "") {
      const msg = (message || "").toString().trim();
      if (!msg) return;
      const k = key || (type + ":" + msg);
      const now = Date.now();
      const last = lastToastAt.get(k) || 0;
      if (now - last < 900) return;
      lastToastAt.set(k, now);

      const host = $("toastHost");
      const wrap = document.createElement("div");
      wrap.className = `toast ${type}`;
      const bubble = document.createElement("div");
      bubble.className = "toast-bubble";
      bubble.textContent = msg;
      wrap.appendChild(bubble);
      host.appendChild(wrap);
      requestAnimationFrame(() => wrap.classList.add("show"));
      setTimeout(() => wrap.classList.add("hide"), 3200);
      setTimeout(() => wrap.remove(), 3800);
    }

    function overlay(on) { $("overlay").classList.toggle("on", !!on); }

    function withTimeout(promise, ms, label = "opera√ß√£o") {
      return Promise.race([
        promise,
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error(`${label}: timeout (${ms}ms)`)), ms)
        )
      ]);
    }

    function isAbortError(e) {
      const msg = (e?.message || "").toLowerCase();
      return e?.name === "AbortError" || msg.includes("signal is aborted") || msg.includes("aborted");
    }

    async function runTask(label, fn, { showOverlay = true, timeoutMs = 12000, retryOnAbort = true } = {}) {
      if (showOverlay) overlay(true);
      try {
        return await withTimeout(fn(), timeoutMs, label);
      } catch (e) {
        if (retryOnAbort && isAbortError(e)) {
          console.warn(label, "AbortError -> retry once");
          try {
            return await withTimeout(fn(), timeoutMs, label);
          } catch (e2) {
            console.error(label, e2);
            toast(`${label}: ${e2?.message || e2}`, "error", "err:" + label);
            throw e2;
          } finally {
            if (showOverlay) overlay(false);
          }
        }

        console.error(label, e);
        toast(`${label}: ${e?.message || e}`, "error", "err:" + label);
        throw e;
      } finally {
        if (showOverlay) overlay(false);
      }
    }

    // ===== Modal =====
    function openModal(title, html) {
      $("modalTitle").textContent = title || "Info";
      $("modalBody").innerHTML = html || "";
      $("modal").classList.remove("hidden");
      $("modal").setAttribute("aria-hidden", "false");
    }
    function closeModal() {
      $("modal").classList.add("hidden");
      $("modal").setAttribute("aria-hidden", "true");
      $("modalBody").innerHTML = "";
    }
    $("modalClose").onclick = closeModal;
    $("modal").addEventListener("click", (e) => {
      if (e.target && e.target.id === "modal") closeModal();
    });

    window.addEventListener("unhandledrejection", (e) => {
      console.error("unhandledrejection:", e?.reason);
      overlay(false);
      toast("Erro: " + (e?.reason?.message || e?.reason || "falha"), "error", "unhandled");
    });
    window.addEventListener("error", (e) => {
      console.error("window error:", e?.message, e);
      overlay(false);
      toast("Erro: " + (e?.message || "falha"), "error", "window-error");
    });

    // ===== Views =====
    function showLogin() {
      $("authTitle").textContent = "Entrar";
      $("loginForm").classList.remove("hidden");
      $("registerForm").classList.add("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
    }

    function showRegister() {
      $("authTitle").textContent = "Registrar";
      $("loginForm").classList.add("hidden");
      $("registerForm").classList.remove("hidden");
      $("authView").classList.remove("hidden");
      $("appView").classList.add("hidden");
      syncRegisterUI();
    }

    function showApp() {
      $("authView").classList.add("hidden");
      $("appView").classList.remove("hidden");
    }

    function syncRegisterUI() {
      const gen = $("genInv").checked;
      $("invCode").disabled = gen;
      if (gen) $("invCode").value = "";
    }

    // ===== local cache by inventory =====
    const KEY_PREFIX = "home_inventory_inv_";
    const loadLocal = (invId) => { try { return JSON.parse(localStorage.getItem(KEY_PREFIX + invId)) || []; } catch { return []; } };
    const saveLocal = (invId, arr) => localStorage.setItem(KEY_PREFIX + invId, JSON.stringify(arr));

    // ===== state =====
    let items = [];
    let members = [];
    let saveTimer = null;
    let currentInventoryId = null;
    let realtimeChannel = null;
    let showOnlyNeeds = false;

    // edi√ß√£o de item
    let editingId = null;

    function needsBuy(it) {
      const qty = Number(it.qty ?? 0);
      const min = Number(it.min_qty ?? 0);
      return qty <= 0 || (min > 0 && qty <= min);
    }

    function fmtDate(ts) {
      try {
        const d = new Date(ts);
        return d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      } catch { return String(ts || ""); }
    }

    function normalizeItem(raw) {
      const name = (raw?.name || "").toString().trim();
      const unit = (raw?.unit || "un").toString().trim();
      const qty = round(Number(raw?.qty ?? 0));
      const min_qty = round(Number(raw?.min_qty ?? 0));
      if (!name) return null;

      const history = Array.isArray(raw?.history) ? raw.history.slice(0, 2) : [];
      return {
        id: raw?.id || crypto.randomUUID(),
        name,
        name_norm: norm(name),
        unit,
        qty: Math.max(0, qty),
        min_qty: Math.max(0, min_qty),
        history
      };
    }

    function pushHistory(it, delta, qtyAfter) {
      const entry = { ts: new Date().toISOString(), delta: round(delta), qty_after: round(qtyAfter) };
      const h = Array.isArray(it.history) ? it.history : [];
      it.history = [entry, ...h].slice(0, 2);
    }

    // ===== members accordion =====
    function setMembersOpen(open) {
      $("membersWrap").classList.toggle("hidden", !open);
      $("reloadMembersBtn").classList.toggle("hidden", !open);
      $("toggleMembersBtn").textContent = open ? "Esconder membros" : "Mostrar membros";
    }
    $("toggleMembersBtn").onclick = () => {
      const open = $("membersWrap").classList.contains("hidden");
      setMembersOpen(open);
      if (open && currentInventoryId) {
        tryLoadMembers(currentInventoryId);
      }
    };

    function renderMembers() {
      const box = $("membersList");
      box.innerHTML = "";

      if (!members.length) {
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = "Sem membros carregados (ou sem permiss√£o).";
        box.appendChild(empty);
        return;
      }

      members
        .slice()
        .sort((a,b) =>
          (a.role === "owner" ? -1 : 1) - (b.role === "owner" ? -1 : 1) ||
          (a.display_name||"").localeCompare((b.display_name||""), "pt-BR")
        )
        .forEach(m => {
          const row = document.createElement("div");
          row.className = "member-row";
          row.innerHTML = `
            <div class="member-name">${m.display_name || "Usu√°rio"} ${m.role === "owner" ? "‚≠ê" : ""}</div>
            <div class="member-sub">${m.role || "member"}</div>
          `;
          box.appendChild(row);
        });
    }

    function renderItems() {
      const q = norm($("search").value);
      const list = $("list");
      list.innerHTML = "";

      const filtered = items
        .filter(it => {
          const matchesSearch = !q || (it.name_norm || "").includes(q);
          const matchesNeeds = !showOnlyNeeds || needsBuy(it);
          return matchesSearch && matchesNeeds;
        })
        .sort((a, b) => (a.name || "").localeCompare((b.name || ""), "pt-BR"));

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "sub";
        empty.textContent = showOnlyNeeds ? "Nenhum item precisa comprar üôÇ" : "Nada por aqui üôÇ";
        list.appendChild(empty);
        return;
      }

      for (const it of filtered) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        const needs = needsBuy(it);
        left.innerHTML = `
          <div class="name">${it.name}</div>
          <div class="sub">
            ${it.qty} ${it.unit} ‚Ä¢ m√≠nimo: ${it.min_qty || 0}
            ${needs ? ' ‚Ä¢ <span class="pill danger">precisa comprar</span>' : ""}
          </div>
        `;

        const controls = document.createElement("div");
        controls.className = "controls";

        const minus = document.createElement("button");
        minus.textContent = "‚àí";
        minus.onclick = () => updateQty(it.id, it.unit === "un" ? -1 : -0.1);

        const gear = document.createElement("button");
        gear.className = "iconbtn";
        gear.title = "Editar item";
        gear.textContent = "‚öôÔ∏è";
        gear.onclick = () => startEditItem(it.id);

        const qtyEl = document.createElement("div");
        qtyEl.className = "qty pill";
        qtyEl.textContent = `${it.qty} ${it.unit}`;

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.onclick = () => updateQty(it.id, it.unit === "un" ? +1 : +0.1);

        const info = document.createElement("button");
        info.className = "iconbtn";
        info.title = "Info / hist√≥rico";
        info.textContent = "‚ÑπÔ∏è";
        info.onclick = () => showItemInfo(it.id);

        const del = document.createElement("button");
        del.className = "iconbtn";
        del.textContent = "üóëÔ∏è";
        del.title = "Remover";
        del.onclick = () => removeItem(it.id);

        controls.append(minus, gear, qtyEl, plus, info, del);
        row.append(left, controls);
        list.appendChild(row);
      }
    }

    function startEditItem(id) {
      const it = items.find(x => x.id === id);
      if (!it) return;

      editingId = id;
      $("name").value = it.name;
      $("unit").value = it.unit;
      $("qty").value = it.qty;
      $("min").value = it.min_qty ?? 0;

      $("add").textContent = "Atualizar";
      $("cancelEdit").classList.remove("hidden");
      $("editHint").textContent = "Modo edi√ß√£o: altere os campos e toque em Atualizar.";
      toast("Editando: " + it.name, "warn", "edit-start");
      try { $("name").scrollIntoView({ behavior: "smooth", block: "center" }); } catch {}
      $("name").focus();
    }

    function cancelEdit() {
      editingId = null;
      $("name").value = "";
      $("qty").value = "";
      $("min").value = "";
      $("add").textContent = "Adicionar";
      $("cancelEdit").classList.add("hidden");
      $("editHint").textContent = "Dica: O ‚ÄúM√≠n‚Äù (m√≠nimo) emite um alerta ao chegar na quantidade definida.";
    }
    $("cancelEdit").onclick = cancelEdit;

    function showItemInfo(id) {
      const it = items.find(x => x.id === id);
      if (!it) return;

      const h = Array.isArray(it.history) ? it.history : [];
      const histHtml = h.length
        ? `<div class="hist">
            ${h.map(x => `
              <div class="hist-row">
                <div class="hist-date">${fmtDate(x.ts)}</div>
                <div class="hist-delta">Œî ${x.delta} (${it.unit})</div>
              </div>
            `).join("")}
          </div>`
        : `<div class="sub">Sem hist√≥rico ainda.</div>`;

      openModal(
        "Info do item",
        `
          <div class="info-grid">
            <div><b>Nome:</b> ${it.name}</div>
            <div><b>Qtd:</b> ${it.qty} ${it.unit}</div>
            <div><b>M√≠n:</b> ${it.min_qty || 0}</div>
          </div>
          <div class="divider" style="margin:12px 0;"></div>
          <div class="sub" style="margin-bottom:8px;">√öltimas 2 altera√ß√µes (data + quantia adicionada/alterada):</div>
          ${histHtml}
        `
      );
    }

    // ===== cloud helpers =====
    async function loadInventory(invId) {
      const { data, error } = await supabase
        .from("inventories")
        .select("items, invite_code")
        .eq("id", invId)
        .single();
      if (error) throw error;
      return data;
    }

    async function saveInventoryItems(invId, arr) {
      const { error } = await supabase
        .from("inventories")
        .update({ items: arr, updated_at: new Date().toISOString() })
        .eq("id", invId);
      if (error) throw error;
    }

    async function saveNow(arr, quiet = false) {
      if (!currentInventoryId) return;
      saveLocal(currentInventoryId, arr);

      try {
        await runTask("Salvar", () => saveInventoryItems(currentInventoryId, arr), { showOverlay: false, timeoutMs: 30000, retryOnAbort: true });
        if (!quiet) toast("Salvo ‚úÖ", "success", "saved");
      } catch (e) {
        if (!quiet) toast("N√£o salvou no cloud (rede/perm): " + (e?.message || e), "warn", "save-warn");
      }
    }

    function saveDebounced(arr) {
      if (!currentInventoryId) return;
      saveLocal(currentInventoryId, arr);
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveNow(arr, true), 250);
    }

    async function addOrUpdateFromForm() {
      const name = $("name").value.trim();
      const unit = $("unit").value;
      const qty = round(Number($("qty").value || 0));
      const minQty = round(Number($("min").value || 0));
      if (!name) return;

      if (editingId) {
        const it = items.find(x => x.id === editingId);
        if (!it) { cancelEdit(); return; }

        const oldQty = Number(it.qty ?? 0);

        it.name = name;
        it.name_norm = norm(name);
        it.unit = unit;
        it.min_qty = Math.max(0, minQty);
        it.qty = Math.max(0, qty);

        const delta = it.qty - oldQty;
        pushHistory(it, delta, it.qty);

        renderItems();
        await saveNow(items);
        toast("Atualizado ‚úÖ", "success", "edit-ok");
        cancelEdit();
        return;
      }

      const n = norm(name);
      const existing = items.find(x => x.name_norm === n && x.unit === unit);

      if (existing) {
        const oldQty = Number(existing.qty ?? 0);
        existing.qty = round(oldQty + qty);
        existing.min_qty = (minQty || minQty === 0) ? minQty : (existing.min_qty || 0);
        pushHistory(existing, qty, existing.qty);
      } else {
        const newItem = {
          id: crypto.randomUUID(),
          name,
          name_norm: n,
          unit,
          qty: Math.max(0, qty),
          min_qty: Math.max(0, minQty),
          history: []
        };
        pushHistory(newItem, qty, newItem.qty);
        items.push(newItem);
      }

      $("name").value = ""; $("qty").value = ""; $("min").value = "";
      renderItems();
      await saveNow(items);
    }

    function updateQty(id, delta) {
      const it = items.find(x => x.id === id);
      if (!it) return;
      it.qty = round(Math.max(0, Number(it.qty) + Number(delta)));
      renderItems();
      saveDebounced(items);
    }

    async function removeItem(id) {
      items = items.filter(x => x.id !== id);
      renderItems();
      await saveNow(items);
    }

    // ===== realtime items =====
    async function startItemsRealtime(invId) {
      if (realtimeChannel) await supabase.removeChannel(realtimeChannel);

      realtimeChannel = supabase
        .channel("inv-" + invId)
        .on("postgres_changes", {
          event: "*",
          schema: "public",
          table: "inventories",
          filter: `id=eq.${invId}`,
        }, (payload) => {
          const newItems = payload?.new?.items;
          if (Array.isArray(newItems)) {
            items = newItems.map(normalizeItem).filter(Boolean);
            saveLocal(invId, items);
            renderItems();
          }
        })
        .subscribe();
    }

    async function stopItemsRealtime() {
      if (realtimeChannel) await supabase.removeChannel(realtimeChannel);
      realtimeChannel = null;
    }

    // ===== members load (visualiza√ß√£o) =====
    async function tryLoadMembers(invId) {
      try {
        const { data, error } = await supabase
          .from("inventory_members")
          .select("user_id, role, display_name, created_at")
          .eq("inventory_id", invId);

        if (error) throw error;
        members = Array.isArray(data) ? data : [];
        renderMembers();
      } catch (e) {
        members = [];
        renderMembers();
      }
    }

    $("reloadMembersBtn").onclick = () => {
      if (!currentInventoryId) return;
      tryLoadMembers(currentInventoryId);
      toast("Atualizando membros‚Ä¶", "warn", "mem-reload");
    };

    async function bootToInventory(invId) {
      currentInventoryId = invId;

      items = (loadLocal(invId) || []).map(normalizeItem).filter(Boolean);
      showApp();
      renderItems();

      const data = await runTask("Sincronizar", () => loadInventory(invId), { showOverlay: true, timeoutMs: 25000, retryOnAbort: true });

      if (Array.isArray(data?.items)) {
        items = data.items.map(normalizeItem).filter(Boolean);
        saveLocal(invId, items);
      }

      $("invCodeShow").textContent = data?.invite_code || "(sem c√≥digo)";
      renderItems();

      // membros: s√≥ carrega se estiver aberto
      if (!$("membersWrap").classList.contains("hidden")) {
        await tryLoadMembers(invId);
      }

      await startItemsRealtime(invId);
      toast("Sincronizado ‚úÖ", "success", "synced");
    }

    // ===== pending setup =====
    const PENDING_KEY = "pending_inv_setup_v2";
    const setPendingSetup = (obj) => localStorage.setItem(PENDING_KEY, JSON.stringify(obj));
    const getPendingSetup = () => { try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "null"); } catch { return null; } };
    const clearPendingSetup = () => localStorage.removeItem(PENDING_KEY);

    async function finalizePendingSetupIfNeeded(user) {
      const pending = getPendingSetup();
      if (!pending) return false;

      try {
        const { error: pErr } = await supabase.from("profiles").upsert({
          user_id: user.id,
          display_name: pending.displayName || "Usu√°rio",
        });
        if (pErr) throw pErr;

        let inventoryId = null;

        if (pending.mode === "create") {
          const { data, error } = await supabase.rpc("create_inventory_and_set_profile", {
            p_name: "Invent√°rio",
            p_display_name: pending.displayName || "Usu√°rio",
          });
          if (error) throw error;
          inventoryId = data?.[0]?.inventory_id;
        } else {
          const { data, error } = await supabase.rpc("join_inventory_by_code", {
            p_code: pending.code,
            p_display_name: pending.displayName || "Usu√°rio",
          });
          if (error) throw error;
          inventoryId = data?.[0]?.inventory_id;
        }

        if (!inventoryId) throw new Error("N√£o consegui obter o invent√°rio.");

        clearPendingSetup();
        await bootToInventory(inventoryId);
        return true;

      } catch (e) {
        clearPendingSetup();
        if (isAbortError(e)) {
          toast("Rede inst√°vel. Atualize a p√°gina e tente de novo.", "warn", "abort-pending");
          showLogin();
          return true;
        }
        showRegister();
        toast("Logado ‚úÖ mas falhou ao finalizar invent√°rio: " + (e?.message || e), "warn", "finalize-fail");
        return true;
      }
    }

    async function bootFromProfile(userId) {
      const { data: prof, error } = await supabase
        .from("profiles")
        .select("current_inventory_id")
        .eq("user_id", userId)
        .maybeSingle();

      if (error) throw error;

      if (!prof?.current_inventory_id) {
        showRegister();
        toast("Voc√™ est√° logado. Agora gere um invent√°rio ou informe um c√≥digo.", "warn", "need-inv");
        return;
      }

      await bootToInventory(prof.current_inventory_id);
    }

    // ===== UI events =====
    $("openRegisterBtn").onclick = () => showRegister();
    $("backToLoginBtn").onclick = () => showLogin();
    $("genInv").addEventListener("change", syncRegisterUI);

    $("loginBtn").onclick = async () => {
      const email = $("loginEmail").value.trim();
      const password = $("loginPass").value;

      await runTask("Login", async () => {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        toast("Logado ‚úÖ", "success", "logged");
      }, { showOverlay: true, timeoutMs: 20000, retryOnAbort: true });
    };

    $("registerBtn").onclick = async () => {
      const displayName = $("regName").value.trim();
      const email = $("regEmail").value.trim();
      const password = $("regPass").value;
      const gen = $("genInv").checked;
      const code = ($("invCode").value || "").trim().toUpperCase();

      if (!displayName) return toast("Informe seu nome.", "warn", "reg-name");
      if (!email) return toast("Informe seu email.", "warn", "reg-email");
      if (!password || password.length < 6) return toast("Senha com pelo menos 6 caracteres.", "warn", "reg-pass");
      if (!gen && !code) return toast("Informe o c√≥digo do invent√°rio.", "warn", "reg-code");

      setPendingSetup({ displayName, mode: gen ? "create" : "join", code: gen ? "" : code, createdAt: Date.now() });

      await runTask("Criar conta", async () => {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: { emailRedirectTo: APP_URL },
        });
        if (error) { clearPendingSetup(); throw error; }

        if (!data?.session?.user) {
          clearPendingSetup();
          toast("Conta criada ‚úÖ Confirme o email e depois fa√ßa login.", "warn", "confirm-email");
          showLogin();
          return;
        }

        await runTask("Preparar invent√°rio", async () => {
          const ok = await finalizePendingSetupIfNeeded(data.session.user);
          if (!ok) throw new Error("N√£o consegui finalizar invent√°rio.");
        }, { showOverlay: true, timeoutMs: 30000, retryOnAbort: true });
      }, { showOverlay: true, timeoutMs: 30000, retryOnAbort: true });
    };

    $("logoutBtn").onclick = async () => {
      await runTask("Sair", async () => {
        await stopItemsRealtime();
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        currentInventoryId = null;
        items = [];
        members = [];
        cancelEdit();
        setMembersOpen(false);
        showLogin();
        toast("Saiu.", "warn", "logout");
      }, { showOverlay: true, timeoutMs: 20000, retryOnAbort: true });
    };

    $("invCodeShow").onclick = async () => {
      const t = $("invCodeShow").textContent || "";
      if (!t) return;
      try {
        await navigator.clipboard.writeText(t);
        toast("C√≥digo copiado ‚úÖ", "success", "copy-code");
      } catch {
        toast("N√£o consegui copiar.", "error", "copy-fail");
      }
    };

    $("add").onclick = addOrUpdateFromForm;
    $("search").addEventListener("input", renderItems);
    $("name").addEventListener("keydown", (e) => { if (e.key === "Enter") addOrUpdateFromForm(); });

    $("filterList").onclick = () => {
      showOnlyNeeds = !showOnlyNeeds;
      $("filterList").classList.toggle("active", showOnlyNeeds);
      $("filterList").textContent = showOnlyNeeds ? "Mostrar tudo" : "Filtrar lista";
      renderItems();
    };

    $("export").onclick = () => {
      const payload = { version: 2, exportedAt: new Date().toISOString(), items };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "inventario-backup.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("Exportado ‚úÖ", "success", "export");
    };

    $("import").onclick = async () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";

      inp.onchange = async () => {
        const file = inp.files?.[0];
        if (!file) return;

        await runTask("Importar", async () => {
          const text = await file.text();
          const parsed = JSON.parse(text);

          const arr = Array.isArray(parsed) ? parsed : (Array.isArray(parsed?.items) ? parsed.items : null);
          if (!Array.isArray(arr)) throw new Error("Arquivo inv√°lido.");

          items = arr.map(normalizeItem).filter(Boolean);
          cancelEdit();
          renderItems();
          await saveNow(items);
          toast("Importado ‚úÖ", "success", "import-ok");
        }, { showOverlay: true, timeoutMs: 30000, retryOnAbort: true });
      };

      inp.click();
    };

    $("clear").onclick = async () => {
      if (!confirm("Tem certeza que quer zerar tudo?")) return;
      await runTask("Zerar", async () => {
        items = [];
        cancelEdit();
        renderItems();
        await saveNow(items);
        toast("Zerado ‚úÖ", "success", "clear-ok");
      }, { showOverlay: true, timeoutMs: 25000, retryOnAbort: true });
    };

    // ===== auth source of truth =====
    let booting = false;

    supabase.auth.onAuthStateChange(async (_event, session) => {
      if (booting) return;

      if (!session?.user) {
        overlay(false);
        showLogin();
        return;
      }

      booting = true;
      try {
        const did = await finalizePendingSetupIfNeeded(session.user);
        if (did) return;

        await runTask("Iniciar", () => bootFromProfile(session.user.id), { showOverlay: true, timeoutMs: 25000, retryOnAbort: true });
      } catch (e) {
        console.error(e);
        if (isAbortError(e)) {
          toast("Rede inst√°vel (Abort). Atualize a p√°gina e tente de novo.", "warn", "abort-boot");
          showLogin();
        } else {
          showRegister();
          toast("Logado ‚úÖ mas falhou ao sincronizar. Verifique policies/RPC.", "warn", "boot-fail");
        }
      } finally {
        booting = false;
      }
    });

    // first paint
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) showLogin();
    })();

    // (membros come√ßa fechado)
    setMembersOpen(false);
  </script>
</body>
</html>
